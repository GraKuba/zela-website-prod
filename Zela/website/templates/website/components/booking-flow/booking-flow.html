{% load static %}
<div
  class="min-h-screen bg-gray-50"
  x-data="bookingFlow()"
  x-init="init()"
  style="font-family: Arial, sans-serif"
>
  <!-- Main Content Container -->
  <div id="booking-screen" class="min-h-screen">
    <!-- Screen 1: Service Landing / Address Capture -->
    {% include "website/components/booking-flow/screens/screen-1-address-capture.html" %}
  </div>

  <!-- Overlay for matchmaking -->
  <div
    x-show="showMatchmakingOverlay"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 bg-green-600 z-50 flex items-center justify-center"
    style="display: none"
  >
    {% include "website/components/booking-flow/screens/screen-10-matchmaking.html" %}
  </div>

  <!-- Modal for heads-up -->
  <div
    x-show="showHeadsUpModal"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-0"
    x-transition:leave-end="opacity-100"
    class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center px-4"
    style="display: none"
  >
    {% include "website/components/booking-flow/screens/screen-11-heads-up-modal.html" %}
  </div>

  <!-- Worker Profile Modal -->
  {% include "website/components/booking-flow/screens/modal-worker-profile.html" %}

  <!-- Hidden screen templates -->
  <div id="choose-worker-screen" style="display: none">
    {% include "website/components/booking-flow/screens/screen-choose-worker.html" %}
  </div>

  <div id="individual-worker-screen" style="display: none">
    {% include "website/components/booking-flow/screens/screen-individual-worker.html" %}
  </div>

  <div id="repeat-booking-screen" style="display: none">
    {% include "website/components/booking-flow/screens/screen-repeat-booking.html" %}
  </div>

  <div id="confirmation-screen" style="display: none">
    {% include "website/components/booking-flow/screens/screen-15-booking-confirmation.html" %}
  </div>
</div>

<script>
  function bookingFlow() {
    return {
      // Current screen state
      currentScreen: 1,
      showServiceModal: true,
      serviceModalDismissed: false,
      showMatchmakingOverlay: false,
      showHeadsUpModal: false,
      showContinueButton: false,
      showServiceScope: false,
      showAddressInColumn: false,

      // Map state
      map: null,
      mapMarker: null,
      searchResults: [],
      searchTimeout: null,
      availableWorkers: [],
      savedAddresses: [],

      // Booking state
      booking: {
        serviceType: "indoor-cleaning",
        location: {
          unitName: "",
          streetAddress: "",
          coordinates: null,
          fullAddress: "",
        },
        frequency: null, // 'one-time' or 'repeat'
        dateBucket: null, // 'tomorrow' or 'later'
        date: null,
        timeWindow: "07:00 - 07:30",
        // Repeat booking specific fields
        repeat: {
          frequency: 'weekly', // 'daily', 'weekly', 'bi-weekly', 'monthly'
          startDate: null,
          endDate: null,
          daysOfWeek: [], // For weekly/bi-weekly: ['monday', 'wednesday', 'friday']
          numberOfSessions: 4, // Default number of sessions
        },
        details: {
          homeSize: "medium-3-4-bedrooms",
          extraTasks: [],
          duration: 5.5,
          startTime: "07:00",
          notes: "",
        },
        tip: {
          amount: 0,
          selectedOption: null,
        },
        pricing: {
          bookingCost: 710,
          otherCosts: {
            bookingCover: 21,
            serviceFee: 39,
          },
          total: 770,
        },
        payment: {
          method: null,
          useSweepCred: false,
          cardId: null,
        },
        voucher: "",
      },

      // Service data
      serviceInfo: {
        "indoor-cleaning": {
          name: "Indoor Cleaning",
          description:
            "Get 3.5 to 10 hours of top-to-bottom comprehensive cleaning of your home.",
          icon: "ðŸ§¹",
          howItWorks: [
            "Tell us where you need help.",
            "Set up your booking requirements.",
            "Choose your worker.",
            "Done!",
          ],
          included: {
            "LIVING ROOM": [
              "Dusting of furniture and surfaces",
              "Mopping and vacuuming of floors",
              "Dusting and wiping of skirtings",
              "Dusting and wiping of electronics, picture frames etc.",
              "Dusting and wiping of light switches and other fixtures",
            ],
            KITCHEN: [
              "Wiping of surfaces, sinks and appliances",
              "Washing of dishes",
              "Wiping outside of cupboards and fridge",
              "Wiping of walls",
              "Emptying bins and cleaning bin area",
              "Mopping floors",
            ],
            BEDROOMS: [
              "Dusting of furniture and surfaces",
              "Making bed",
              "Vacuuming and/or mopping floors",
              "Dusting and wiping of skirtings",
              "Folding or hanging of clothes in bedroom",
            ],
            BATHROOMS: [
              "Cleaning of shower, bath and sinks",
              "Toilet clean",
              "Wiping of counters and taps",
              "Wiping of walls and mirrors",
              "Wiping outside of cupboards and cabinets",
              "Folding or hanging of clean towels",
              "Emptying bins and cleaning bin area",
              "Mopping floors",
            ],
          },
        },
        "outdoor-services": {
          name: "Outdoor Services",
          description:
            "Professional outdoor cleaning and maintenance including gardening, pool cleaning, and exterior washing.",
          icon: "ðŸŒ¿",
          howItWorks: [
            "Tell us where you need help.",
            "Set up your booking requirements.",
            "Choose your worker.",
            "Done!",
          ],
        },
        "office-cleaning": {
          name: "Office Cleaning",
          description:
            "Keep your workspace pristine with our comprehensive office cleaning services.",
          icon: "ðŸ¢",
          howItWorks: [
            "Tell us where you need help.",
            "Set up your booking requirements.",
            "Choose your worker.",
            "Done!",
          ],
        },
        "moms-helper": {
          name: "Mom's Helper",
          description:
            "Get help with childcare, meal prep, light housekeeping, and other household tasks.",
          icon: "ðŸ‘¶",
          howItWorks: [
            "Tell us where you need help.",
            "Set up your booking requirements.",
            "Choose your worker.",
            "Done!",
          ],
        },
        "moving-cleaning": {
          name: "Moving Cleaning",
          description:
            "Deep cleaning services for move-ins and move-outs to ensure your space is spotless.",
          icon: "ðŸ“¦",
          howItWorks: [
            "Tell us where you need help.",
            "Set up your booking requirements.",
            "Choose your worker.",
            "Done!",
          ],
        },
        "elder-care": {
          name: "Elder Care",
          description:
            "Compassionate care and assistance for elderly family members including companionship and daily tasks.",
          icon: "ðŸ‘µ",
          howItWorks: [
            "Tell us where you need help.",
            "Set up your booking requirements.",
            "Choose your worker.",
            "Done!",
          ],
        },
        "express-cleaning": {
          name: "Express Cleaning",
          description:
            "Quick and efficient cleaning service when you need it fast - perfect for last-minute needs.",
          icon: "âš¡",
          howItWorks: [
            "Tell us where you need help.",
            "Set up your booking requirements.",
            "Choose your worker.",
            "Done!",
          ],
        },
        "laundry-ironing": {
          name: "Laundry & Ironing",
          description:
            "Professional laundry and ironing services to keep your clothes fresh and wrinkle-free.",
          icon: "ðŸ‘”",
          howItWorks: [
            "Tell us where you need help.",
            "Set up your booking requirements.",
            "Choose your worker.",
            "Done!",
          ],
        },
      },

      // Extra tasks options
      extraTasksOptions: [
        { id: "inside-fridge", label: "Inside Fridge", icon: "ðŸ¥¶" },
        { id: "inside-oven", label: "Inside Oven", icon: "ðŸ”¥" },
        { id: "inside-cabinets", label: "Inside Cabinets", icon: "ðŸšª" },
        { id: "interior-windows", label: "Interior Windows", icon: "ðŸªŸ" },
        { id: "interior-walls", label: "Interior Walls", icon: "ðŸ§±" },
        { id: "water-plants", label: "Water Plants", icon: "ðŸŒ±" },
        { id: "ironing", label: "Ironing", icon: "ðŸ‘”" },
        { id: "laundry", label: "Laundry", icon: "ðŸ‘•" },
      ],

      // Home size options
      homeSizeOptions: [
        {
          id: "small-1-2-bedrooms",
          label: "Small Home: 1-2 Bedrooms",
          duration: 3.5,
        },
        {
          id: "medium-3-4-bedrooms",
          label: "Medium Home: 3-4 Bedrooms",
          duration: 5.5,
        },
        {
          id: "large-5-plus-bedrooms",
          label: "Large Home: 5+ Bedrooms",
          duration: 8,
        },
      ],

      // Time slots
      timeSlots: [
        "07:00 - 07:30",
        "07:30 - 08:00",
        "08:00 - 08:30",
        "08:30 - 09:00",
        "09:00 - 09:30",
        "09:30 - 10:00",
        "10:00 - 10:30",
        "10:30 - 11:00",
        "11:00 - 11:30",
        "11:30 - 12:00",
        "12:00 - 12:30",
        "12:30 - 13:00",
        "13:00 - 13:30",
        "13:30 - 14:00",
        "14:00 - 14:30",
        "14:30 - 15:00",
      ],

      async init() {
        // Initialize with service type from URL or default
        this.booking.serviceType =
          new URLSearchParams(window.location.search).get("service") ||
          "indoor-cleaning";

        // Set default date to tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        this.booking.date = tomorrow.toISOString().split("T")[0];

        // Set default repeat booking start date
        this.booking.repeat.startDate = tomorrow.toISOString().split("T")[0];

        // Load saved booking data from session
        try {
          const response = await fetch('/booking-flow/get-data/');
          if (response.ok) {
            const result = await response.json();
            if (result.data && Object.keys(result.data).length > 0) {
              // Merge saved data with current booking data
              Object.assign(this.booking, result.data);
              console.log('Loaded saved booking data:', result.data);
            }
          }
        } catch (error) {
          console.error('Error loading saved booking data:', error);
        }

        // Store reference to this component globally for access from dynamically loaded content
        window.bookingFlowComponent = this;
        
        // Load user's saved addresses
        this.loadSavedAddresses();
      },

      // Navigation methods
      goToScreen(screenNumber) {
        this.currentScreen = screenNumber;

        // Handle special screens
        if (screenNumber === "choose-worker") {
          // Show choose worker screen
          document.getElementById("booking-screen").innerHTML =
            document.getElementById("choose-worker-screen").innerHTML;
          return;
        }

        if (screenNumber === "individual-worker") {
          // Show individual worker screen
          document.getElementById("booking-screen").innerHTML =
            document.getElementById("individual-worker-screen").innerHTML;
          return;
        }

        if (screenNumber === "repeat-booking") {
          // Store the current context
          const currentContext = this;
          
          // Show repeat booking screen
          const bookingScreen = document.getElementById("booking-screen");
          const repeatBookingContent = document.getElementById("repeat-booking-screen").innerHTML;
          
          // Replace content
          bookingScreen.innerHTML = repeatBookingContent;
          
          // Initialize repeat booking pricing
          this.calculateRepeatPricing();
          
          // Re-bind Alpine.js data to the new content by adding x-data attribute
          bookingScreen.setAttribute('x-data', 'bookingFlow()');
          
          // Re-initialize Alpine.js for the new content
          setTimeout(() => {
            // Make sure the global component reference is available
            window.bookingFlowComponent = currentContext;
            
            // Initialize repeat booking displays
            initializeRepeatBookingDisplays();
            
            Alpine.initTree(bookingScreen);
          }, 50);
          
          return;
        }

        if (screenNumber === 15) {
          // Show confirmation screen
          document.getElementById("booking-screen").innerHTML =
            document.getElementById("confirmation-screen").innerHTML;
          return;
        }

        // Use HTMX to load the appropriate screen
        htmx.ajax("GET", `/booking-flow/screen/${screenNumber}/`, {
          target: "#booking-screen",
          swap: "innerHTML",
        });
      },

      // Action methods
      dismissServiceModal() {
        this.showServiceModal = false;
        this.serviceModalDismissed = true;
        
        // Show the address form in the right column
        this.showAddressInColumn = true;
        
        // Fix map rendering issue by resizing the map after modal dismiss
        setTimeout(() => {
          if (this.map) {
            this.map.invalidateSize();
          }
        }, 350); // Wait for transition to complete
      },

      proceedToAddressConfirmation() {
        // Only proceed if we have a valid address and coordinates
        if (
          this.booking.location.streetAddress &&
          this.booking.location.coordinates
        ) {
          this.goToScreen(2);
        } else {
          alert("Please select an address on the map first");
        }
      },

      setLocation(address, coordinates) {
        this.booking.location.fullAddress = address;
        this.booking.location.coordinates = coordinates;
        this.goToScreen(3);
      },

      confirmLocation() {
        this.goToScreen(4);
      },

      selectFrequency(frequency) {
        this.booking.frequency = frequency;
        // Save state to session
        this.saveBookingData();
        // Don't navigate immediately - wait for date bucket selection
      },

      selectDateBucket(bucket) {
        this.booking.dateBucket = bucket;
        
        if (bucket === "tomorrow") {
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          this.booking.date = tomorrow.toISOString().split("T")[0];
          // Also update the time window to match the start time
          if (this.booking.details.startTime) {
            this.booking.timeWindow = `${this.booking.details.startTime} - ${this.addMinutesToTime(this.booking.details.startTime, 30)}`;
          }
        } else if (bucket === "later") {
          // Set date to a week from now as default for "later"
          const laterDate = new Date();
          laterDate.setDate(laterDate.getDate() + 7);
          this.booking.date = laterDate.toISOString().split("T")[0];
        }
        
        // Save state to session
        this.saveBookingData();
        
        // Navigate based on frequency
        if (this.booking.frequency === 'one-time') {
          this.goToScreen(8); // Go to one-time booking details
        } else if (this.booking.frequency === 'repeat') {
          this.goToScreen('repeat-booking'); // Go to repeat booking details
        }
      },
      
      addMinutesToTime(time, minutes) {
        const [hours, mins] = time.split(':').map(Number);
        const totalMins = hours * 60 + mins + minutes;
        const newHours = Math.floor(totalMins / 60);
        const newMins = totalMins % 60;
        return `${String(newHours).padStart(2, '0')}:${String(newMins).padStart(2, '0')}`;
      },

      toggleExtraTask(taskId) {
        const index = this.booking.details.extraTasks.indexOf(taskId);
        if (index > -1) {
          this.booking.details.extraTasks.splice(index, 1);
        } else {
          this.booking.details.extraTasks.push(taskId);
        }
        this.calculatePricing();
        // Save state to session
        this.saveBookingData();
      },

      updateDuration(change) {
        this.booking.details.duration = Math.max(
          1,
          this.booking.details.duration + change
        );
        this.calculatePricing();
        // Save state to session
        this.saveBookingData();
      },

      // Update duration based on home size selection
      updateHomeSizeDuration() {
        const homeSizeOption = this.homeSizeOptions.find(
          (option) => option.id === this.booking.details.homeSize
        );
        if (homeSizeOption) {
          this.booking.details.duration = homeSizeOption.duration;
        }
        this.calculatePricing();
        // Save state to session
        this.saveBookingData();
      },

      calculatePricing() {
        // Enhanced pricing calculation based on duration, home size, and extra tasks
        const baseRate = 129; // per hour
        let baseCost = this.booking.details.duration * baseRate;

        // Adjust for home size
        const homeSize = this.booking.details.homeSize;
        let sizeMultiplier = 1;
        if (homeSize === "small-1-2-bedrooms") {
          sizeMultiplier = 0.8;
        } else if (homeSize === "large-5-plus-bedrooms") {
          sizeMultiplier = 1.2;
        }

        // Add extra tasks cost
        const extraTasksCost = this.booking.details.extraTasks.length * 25;

        // Calculate final cost
        baseCost = baseCost * sizeMultiplier + extraTasksCost;

        this.booking.pricing.bookingCost = Math.round(baseCost);
        this.booking.pricing.total =
          this.booking.pricing.bookingCost +
          this.booking.pricing.otherCosts.bookingCover +
          this.booking.pricing.otherCosts.serviceFee;
      },

      findWorker() {
        this.showMatchmakingOverlay = true;

        // Simulate search delay
        setTimeout(() => {
          this.showMatchmakingOverlay = false;
          this.goToChooseWorker();
        }, 3000);
      },

      goToChooseWorker() {
        // Navigate directly to choose worker screen
        this.goToScreen("choose-worker");
        // Load workers after navigation
        setTimeout(() => this.loadAvailableWorkers(), 100);
      },

      chooseWorker(workerId) {
        // Store selected worker
        this.booking.selectedWorker = workerId;
        // Save to session
        this.saveBookingData();
        // Navigate to payment screen directly (skip individual worker screen for now)
        this.goToScreen(13);
      },

      chooseForMe() {
        // Handle automatic worker selection
        // Mark as auto-selection
        this.booking.selectedWorker = "auto";
        this.saveBookingData();
        // Navigate to payment screen
        this.goToScreen(13);
      },

      closeHeadsUpModal() {
        this.showHeadsUpModal = false;
        this.goToScreen(12);
      },

      proceedToPayment() {
        this.goToScreen(13);
      },

      selectPaymentMethod(method) {
        this.booking.payment.method = method;
        this.saveBookingData();
        
        if (method === "credit-card") {
          // For now, simulate payment success and complete booking
          this.completeBooking();
        }
      },

      // Map methods
      initMap() {
        // Initialize map centered on Luanda, Angola
        this.map = L.map("booking-map").setView([-8.8368, 13.2343], 12);

        // Add OpenStreetMap tiles
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "Â© OpenStreetMap contributors",
        }).addTo(this.map);

        // Add some sample markers for service areas
        this.addSampleMarkers();

        // Map clicking disabled - users must use address input
      },

      addSampleMarkers() {
        // Add some sample service area markers in Luanda
        const serviceAreas = [
          { lat: -8.8368, lng: 13.2343, name: "Luanda Centro" },
          { lat: -8.8147, lng: 13.2302, name: "Ilha de Luanda" },
          { lat: -8.8547, lng: 13.2465, name: "Talatona" },
          { lat: -8.8892, lng: 13.2782, name: "Benfica" },
          { lat: -8.9083, lng: 13.3233, name: "Viana" },
        ];

        serviceAreas.forEach((area) => {
          const marker = L.circleMarker([area.lat, area.lng], {
            radius: 8,
            fillColor: "#10b981",
            color: "#059669",
            weight: 2,
            opacity: 0.8,
            fillOpacity: 0.6,
          }).addTo(this.map);

          marker.bindPopup(`<b>${area.name}</b><br>Service available`);
        });
      },

      searchAddress(query) {
        if (!query || query.length < 3) {
          this.searchResults = [];
          return;
        }

        // Clear previous timeout
        if (this.searchTimeout) {
          clearTimeout(this.searchTimeout);
        }

        // Debounce search
        this.searchTimeout = setTimeout(() => {
          this.performAddressSearch(query);
        }, 500);
        
        // Also attempt to geocode and center the map on manual entry
        if (query.length > 10) {
          this.searchTimeout = setTimeout(() => {
            this.geocodeAndCenterMap(query);
          }, 1000);
        }
      },
      
      async geocodeAndCenterMap(query) {
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
              query + ", Angola"
            )}&countrycodes=ao&limit=1`
          );
          
          if (response.ok) {
            const results = await response.json();
            if (results.length > 0) {
              const result = results[0];
              const latlng = L.latLng(parseFloat(result.lat), parseFloat(result.lon));
              
              // Center map on the location with closer zoom
              this.map.setView(latlng, 18);
              
              // Place marker
              this.placeMarker(latlng);
              
              // Update location data
              this.booking.location.streetAddress = query;
              this.booking.location.coordinates = {
                lat: parseFloat(result.lat),
                lng: parseFloat(result.lon),
              };
              this.booking.location.fullAddress = result.display_name;
            }
          }
        } catch (error) {
          console.error("Error geocoding address:", error);
        }
      },

      async performAddressSearch(query) {
        try {
          // Add mock Angolan addresses for common searches
          const mockAddresses = [
            {
              display_name: "Rua Major Kanhangulo, Luanda, Angola",
              lat: "-8.8368",
              lon: "13.2343",
              place_id: "mock_1",
            },
            {
              display_name: "Avenida 4 de Fevereiro, Ilha de Luanda, Angola",
              lat: "-8.8147",
              lon: "13.2302",
              place_id: "mock_2",
            },
            {
              display_name: "Rua da MissÃ£o, Talatona, Luanda, Angola",
              lat: "-8.8547",
              lon: "13.2465",
              place_id: "mock_3",
            },
            {
              display_name: "Avenida Pedro de Castro Van-DÃºnem Loy, Luanda, Angola",
              lat: "-8.8892",
              lon: "13.2782",
              place_id: "mock_4",
            },
            {
              display_name:
                "Estrada de Catete, Viana, Luanda, Angola",
              lat: "-8.9083",
              lon: "13.3233",
              place_id: "mock_5",
            },
          ];

          // Filter mock addresses based on query
          const filteredMockAddresses = mockAddresses.filter((addr) =>
            addr.display_name.toLowerCase().includes(query.toLowerCase())
          );

          // Use Nominatim API for geocoding (free OpenStreetMap service)
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
              query
            )}&countrycodes=ao&limit=3`
          );

          if (response.ok) {
            const apiResults = await response.json();
            // Combine mock results with API results
            this.searchResults = [
              ...filteredMockAddresses,
              ...apiResults,
            ].slice(0, 5);
          } else {
            // If API fails, use mock results only
            this.searchResults = filteredMockAddresses;
          }
        } catch (error) {
          console.error("Error searching address:", error);
          // Fallback to mock results
          const mockAddresses = [
            {
              display_name: "Rua Major Kanhangulo, Luanda, Angola",
              lat: "-8.8368",
              lon: "13.2343",
              place_id: "mock_1",
            },
            {
              display_name: "Avenida 4 de Fevereiro, Ilha de Luanda, Angola",
              lat: "-8.8147",
              lon: "13.2302",
              place_id: "mock_2",
            },
          ];
          this.searchResults = mockAddresses.filter((addr) =>
            addr.display_name.toLowerCase().includes(query.toLowerCase())
          );
        }
      },

      selectSearchResult(result) {
        // Update the booking location
        this.booking.location.streetAddress = result.display_name;
        this.booking.location.coordinates = {
          lat: parseFloat(result.lat),
          lng: parseFloat(result.lon),
        };

        // Clear search results
        this.searchResults = [];

        // Center map on selected location with closer zoom
        this.map.setView([result.lat, result.lon], 18);

        // Place marker
        this.placeMarker(L.latLng(result.lat, result.lon));

        // Show continue button instead of auto-navigating
        this.showContinueButton = true;
      },

      async placeMarker(latlng) {
        // Remove existing marker
        if (this.mapMarker) {
          this.map.removeLayer(this.mapMarker);
        }

        // Add new marker
        this.mapMarker = L.marker(latlng, {
          icon: L.icon({
            iconUrl:
              "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",
            shadowUrl:
              "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41],
          }),
        }).addTo(this.map);

        // Update booking coordinates
        this.booking.location.coordinates = {
          lat: latlng.lat,
          lng: latlng.lng,
        };

        // Perform reverse geocoding to get address
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}&zoom=18&addressdetails=1`
          );
          
          if (response.ok) {
            const data = await response.json();
            if (data.display_name) {
              // Extract street address from the response
              const address = data.address;
              let streetAddress = "";
              
              // Build street address from components
              if (address.house_number) {
                streetAddress += address.house_number + " ";
              }
              if (address.road || address.street) {
                streetAddress += (address.road || address.street) + ", ";
              }
              if (address.suburb || address.neighbourhood) {
                streetAddress += (address.suburb || address.neighbourhood) + ", ";
              }
              if (address.city || address.town) {
                streetAddress += (address.city || address.town) + ", ";
              }
              streetAddress += "Angola";
              
              this.booking.location.streetAddress = streetAddress.trim();
              this.booking.location.fullAddress = data.display_name;
              
              // Show popup with address
              this.mapMarker.bindPopup(`ðŸ“ ${streetAddress}`).openPopup();
            } else {
              // Fallback if no address found
              this.booking.location.streetAddress = `${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
              this.mapMarker.bindPopup("ðŸ“ Selected location").openPopup();
            }
          } else {
            // Fallback if API fails
            this.booking.location.streetAddress = `${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
            this.mapMarker.bindPopup("ðŸ“ Selected location").openPopup();
          }
        } catch (error) {
          console.error("Error getting address:", error);
          // Fallback if error occurs
          this.booking.location.streetAddress = `${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
          this.mapMarker.bindPopup("ðŸ“ Selected location").openPopup();
        }

        // Show continue button instead of auto-navigating
        this.showContinueButton = true;
      },

      // Save booking data to session
      async saveBookingData() {
        try {
          const response = await fetch('/booking-flow/save-data/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(this.booking),
          });
          
          if (response.ok) {
            const result = await response.json();
            console.log('Booking data saved:', result);
          }
        } catch (error) {
          console.error('Error saving booking data:', error);
        }
      },
      
      // Complete booking and create in database
      async completeBooking() {
        try {
          const response = await fetch('/booking-flow/payment/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(this.booking),
          });
          
          if (response.ok) {
            const result = await response.json();
            console.log('Booking created:', result);
            
            // Store success message in sessionStorage for dashboard
            sessionStorage.setItem('bookingSuccess', 'true');
            sessionStorage.setItem('navigateToTab', 'bookings');
            
            // Redirect to dashboard
            window.location.href = '/dashboard/';
          } else {
            const error = await response.json();
            alert('Error creating booking: ' + error.message);
          }
        } catch (error) {
          console.error('Error completing booking:', error);
          alert('Error creating booking. Please try again.');
        }
      },
      
      // Helper methods
      formatCurrency(amount) {
        return `R${amount}`;
      },

      getHomeSizeLabel(sizeId) {
        const option = this.homeSizeOptions.find((opt) => opt.id === sizeId);
        return option ? option.label : sizeId;
      },

      getExtraTaskLabel(taskId) {
        const task = this.extraTasksOptions.find((opt) => opt.id === taskId);
        return task ? task.label : taskId;
      },

      // Tip handling methods
      selectTip(tipOption, amount = null) {
        this.booking.tip.selectedOption = tipOption;

        if (tipOption === "custom" && amount !== null) {
          this.booking.tip.amount = amount;
        } else if (tipOption !== "custom") {
          // Set predefined tip amounts
          const tipAmounts = {
            "no-tip": 0,
            small: 25,
            medium: 50,
            large: 75,
            generous: 100,
          };
          this.booking.tip.amount = tipAmounts[tipOption] || 0;
        }
        
        this.calculatePricing();
        this.saveBookingData();
      },

      updateCustomTip(amount) {
        this.booking.tip.amount = Math.max(0, parseInt(amount) || 0);
        this.calculatePricing();
      },

      // Load available workers from API
      async loadAvailableWorkers() {
        try {
          const response = await fetch('/booking-flow/workers/');
          if (response.ok) {
            const data = await response.json();
            if (data.status === 'success') {
              this.availableWorkers = data.workers;
              this.displayWorkers();
            }
          }
        } catch (error) {
          console.error('Error loading workers:', error);
        }
      },

      displayWorkers() {
        // Wait a bit for DOM to be ready
        setTimeout(() => {
          // Be very specific - find the main booking screen
          const bookingScreen = document.querySelector('#booking-screen');
          if (!bookingScreen) return;
          
          // Find all elements with space-y-6 class
          const allContainers = bookingScreen.querySelectorAll('.space-y-6');
          
          // Find the right container - it should be in a div that has "Choose your worker" as a sibling
          let targetContainer = null;
          allContainers.forEach(container => {
            const parent = container.parentElement;
            if (parent && parent.querySelector('h2')?.textContent?.includes('Choose your worker')) {
              targetContainer = container;
            }
          });
          
          if (!targetContainer) {
            console.error('Could not find worker container');
            return;
          }
          
          // Clear existing content
          targetContainer.innerHTML = '';
          
          if (this.availableWorkers.length === 0) {
            targetContainer.innerHTML = `
              <div class="text-center py-8 text-gray-500">
                <p>No workers available at this time.</p>
              </div>
            `;
            return;
          }
          
          // Create worker cards
          this.availableWorkers.forEach(worker => {
            const workerCard = this.createWorkerCard(worker);
            targetContainer.appendChild(workerCard);
          });
        }, 200);
      },

      createWorkerCard(worker) {
        const div = document.createElement('div');
        div.className = 'bg-white border border-gray-200 rounded-2xl p-6';
        
        // Get the static URL for the generic avatar
        const genericAvatarUrl = document.querySelector('[src*="generic-avatar"]')?.src || '/static/generic-avatar.png';
        
        div.innerHTML = `
          <div class="flex items-start space-x-4">
            <!-- Profile Picture -->
            <div class="w-16 h-16 bg-gray-300 rounded-full flex-shrink-0 overflow-hidden">
              <img
                src="${worker.avatar || genericAvatarUrl}"
                alt="${worker.name}"
                class="w-full h-full object-cover"
                onerror="this.src='${genericAvatarUrl}'"
              />
            </div>

            <!-- Worker Details -->
            <div class="flex-1">
              <h3 class="text-xl font-bold mb-2" style="color: #011e41">
                ${worker.name}
              </h3>
              <div class="flex items-center mb-2">
                <svg
                  class="w-4 h-4 text-[#015e73] mr-2"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M12 17.27L18.18 21L16.54 13.97L22 9.24L14.81 8.63L12 2L9.19 8.63L2 9.24L7.46 13.97L5.82 21L12 17.27Z"
                  />
                </svg>
                <span class="text-sm font-medium" style="color: #011e41">
                  ${worker.recommend_rate}% Recommend
                </span>
              </div>
              <div class="text-sm text-gray-600 mb-4">
                <span class="font-bold">${worker.jobs_completed}</span> Jobs Completed
              </div>

              <!-- Action Buttons -->
              <div class="flex space-x-3">
                <button
                  @click="viewWorkerProfile(${worker.id})"
                  class="flex-1 bg-white border border-[#015e73] text-[#015e73] font-medium py-2 px-4 rounded-xl hover:bg-[#015e73]/5 transition-colors cursor-pointer"
                >
                  View profile
                </button>
                <button
                  @click="chooseWorker(${worker.id})"
                  class="flex-1 bg-[#015e73] text-white font-medium py-2 px-4 rounded-xl hover:bg-[#014a5a] transition-colors cursor-pointer"
                >
                  Choose me
                </button>
              </div>
            </div>
          </div>
        `;
        return div;
      },

      // Load saved addresses from user's address book
      async loadSavedAddresses() {
        try {
          const response = await fetch('/booking-flow/addresses/');
          if (response.ok) {
            const data = await response.json();
            if (data.status === 'success') {
              this.savedAddresses = data.addresses;
            }
          }
        } catch (error) {
          console.error('Error loading saved addresses:', error);
        }
      },

      // Select a saved address
      selectSavedAddress(address) {
        // Update booking location with saved address
        this.booking.location.unitName = address.address_line_2 || '';
        this.booking.location.streetAddress = address.full_address;
        this.booking.location.fullAddress = address.full_address;
        
        // Set coordinates if available
        if (address.latitude && address.longitude) {
          this.booking.location.coordinates = {
            lat: address.latitude,
            lng: address.longitude
          };
          
          // Center map on the saved address
          const latlng = L.latLng(address.latitude, address.longitude);
          this.map.setView(latlng, 18);
          this.placeMarker(latlng);
        } else {
          // If no coordinates, geocode the address
          this.geocodeAndCenterMap(address.full_address);
        }
        
        // Clear search results
        this.searchResults = [];
        
        // Show continue button
        this.showContinueButton = true;
      },

      // Repeat booking methods
      setRepeatFrequency(frequency) {
        this.booking.repeat.frequency = frequency;
        // Reset days of week when changing frequency
        this.booking.repeat.daysOfWeek = [];
        this.calculateRepeatPricing();
      },

      toggleDayOfWeek(day) {
        const index = this.booking.repeat.daysOfWeek.indexOf(day);
        if (index > -1) {
          this.booking.repeat.daysOfWeek.splice(index, 1);
        } else {
          this.booking.repeat.daysOfWeek.push(day);
        }
        this.calculateRepeatPricing();
      },

      updateNumberOfSessions(sessions) {
        this.booking.repeat.numberOfSessions = Math.max(1, Math.min(52, sessions));
        this.calculateRepeatPricing();
      },

      calculateRepeatPricing() {
        // Calculate base cost for one session
        const baseRate = 129; // per hour
        let baseCost = this.booking.details.duration * baseRate;
        
        // Adjust for home size
        const homeSize = this.booking.details.homeSize;
        let sizeMultiplier = 1;
        if (homeSize === "small-1-2-bedrooms") {
          sizeMultiplier = 0.8;
        } else if (homeSize === "large-5-plus-bedrooms") {
          sizeMultiplier = 1.2;
        }
        
        // Add extra tasks cost
        const extraTasksCost = this.booking.details.extraTasks.length * 25;
        
        // Calculate cost per session
        const costPerSession = baseCost * sizeMultiplier + extraTasksCost;
        
        // Apply repeat booking discount
        let discountMultiplier = 1;
        if (this.booking.repeat.numberOfSessions >= 4) {
          discountMultiplier = 0.85; // 15% discount for 4+ sessions
        }
        if (this.booking.repeat.numberOfSessions >= 8) {
          discountMultiplier = 0.75; // 25% discount for 8+ sessions
        }
        
        const discountedCostPerSession = costPerSession * discountMultiplier;
        const totalCost = discountedCostPerSession * this.booking.repeat.numberOfSessions;
        
        this.booking.pricing.bookingCost = Math.round(totalCost);
        this.booking.pricing.total = this.booking.pricing.bookingCost + 
          this.booking.pricing.otherCosts.bookingCover + 
          this.booking.pricing.otherCosts.serviceFee;
      },
    };
  }

  // Global functions accessible from included screens
  function chooseWorker(workerId) {
    const bookingData = Alpine.store("booking");
    if (bookingData && bookingData.chooseWorker) {
      bookingData.chooseWorker(workerId);
    } else {
      // Fallback: find the Alpine component and call the method
      const component = Alpine.findClosest(document.body, "[x-data]");
      if (
        component &&
        component._x_dataStack &&
        component._x_dataStack[0].chooseWorker
      ) {
        component._x_dataStack[0].chooseWorker(workerId);
      }
    }
  }

  function chooseForMe() {
    const component = Alpine.findClosest(document.body, "[x-data]");
    if (
      component &&
      component._x_dataStack &&
      component._x_dataStack[0].chooseForMe
    ) {
      component._x_dataStack[0].chooseForMe();
    }
  }

  function viewWorkerProfile(workerId) {
    window.dispatchEvent(
      new CustomEvent("open-worker-profile", {
        detail: { workerId: workerId },
      })
    );
  }

  function proceedToPayment() {
    // Primary method: use global window reference
    if (window.bookingFlowComponent && window.bookingFlowComponent.goToScreen) {
      window.bookingFlowComponent.goToScreen(13);
      return;
    }

    // Fallback: try multiple approaches to find the Alpine component
    let component = document.querySelector("[x-data]");

    // If we have the component, try to access its Alpine data
    if (component && component._x_dataStack && component._x_dataStack[0]) {
      component._x_dataStack[0].goToScreen(13);
    } else {
      // Second fallback: try to find by class
      const bookingContainer = document.querySelector(".min-h-screen[x-data]");
      if (
        bookingContainer &&
        bookingContainer._x_dataStack &&
        bookingContainer._x_dataStack[0]
      ) {
        bookingContainer._x_dataStack[0].goToScreen(13);
      } else {
        console.error("Could not find Alpine component for proceedToPayment");
      }
    }
  }

  function goBack() {
    // Primary method: use global window reference
    if (
      window.bookingFlowComponent &&
      window.bookingFlowComponent.goToChooseWorker
    ) {
      window.bookingFlowComponent.goToChooseWorker();
      return;
    }

    // Fallback: try multiple approaches to find the Alpine component
    let component = document.querySelector("[x-data]");

    // If we have the component, try to access its Alpine data
    if (component && component._x_dataStack && component._x_dataStack[0]) {
      component._x_dataStack[0].goToChooseWorker();
    } else {
      // Second fallback: try to find by class
      const bookingContainer = document.querySelector(".min-h-screen[x-data]");
      if (
        bookingContainer &&
        bookingContainer._x_dataStack &&
        bookingContainer._x_dataStack[0]
      ) {
        bookingContainer._x_dataStack[0].goToChooseWorker();
      } else {
        console.error("Could not find Alpine component for goBack");
      }
    }
  }

  // Global functions for repeat booking functionality
  function setRepeatFrequency(frequency) {
    if (window.bookingFlowComponent && window.bookingFlowComponent.setRepeatFrequency) {
      window.bookingFlowComponent.setRepeatFrequency(frequency);
      
      // Update visual indicators
      const frequencies = ['weekly', 'bi-weekly', 'monthly', 'custom'];
      frequencies.forEach(freq => {
        const element = document.getElementById(`frequency-${freq}`);
        const indicator = document.getElementById(`frequency-${freq}-indicator`);
        if (element && indicator) {
          if (freq === frequency) {
            element.classList.add('border-[#015e73]', 'bg-[#015e73]/10', 'shadow-lg');
            element.classList.remove('border-gray-200');
            indicator.classList.remove('hidden');
          } else {
            element.classList.remove('border-[#015e73]', 'bg-[#015e73]/10', 'shadow-lg');
            element.classList.add('border-gray-200');
            indicator.classList.add('hidden');
          }
        }
      });
      
      // Show/hide days selection
      const daysSection = document.querySelector('[data-days-section]');
      if (daysSection) {
        if (frequency === 'weekly' || frequency === 'bi-weekly') {
          daysSection.style.display = 'block';
        } else {
          daysSection.style.display = 'none';
        }
      }
    }
  }

  function toggleDayOfWeek(day) {
    if (window.bookingFlowComponent && window.bookingFlowComponent.toggleDayOfWeek) {
      window.bookingFlowComponent.toggleDayOfWeek(day);
      
      // Update visual indicator
      const element = document.getElementById(`day-${day}`);
      const text = element.querySelector('.text-sm');
      if (element && text) {
        const isSelected = window.bookingFlowComponent.booking.repeat.daysOfWeek.includes(day);
        if (isSelected) {
          element.classList.add('border-[#015e73]', 'bg-[#015e73]/10', 'shadow-lg');
          element.classList.remove('border-gray-200');
          text.classList.add('text-[#015e73]', 'font-bold');
        } else {
          element.classList.remove('border-[#015e73]', 'bg-[#015e73]/10', 'shadow-lg');
          element.classList.add('border-gray-200');
          text.classList.remove('text-[#015e73]', 'font-bold');
        }
      }
      
      // Update days counter
      updateDaysCounter();
    }
  }

  function updateDaysCounter() {
    const counterElement = document.getElementById('days-counter');
    if (counterElement && window.bookingFlowComponent) {
      const selectedDays = window.bookingFlowComponent.booking.repeat.daysOfWeek.length;
      if (selectedDays === 0) {
        counterElement.innerHTML = '<span class="text-gray-500">Select the days you want service</span>';
      } else {
        const dayText = selectedDays === 1 ? 'day' : 'days';
        counterElement.innerHTML = `<span class="text-[#015e73] font-medium">${selectedDays} ${dayText} selected</span>`;
      }
    }
  }

  function updateNumberOfSessions(sessions) {
    if (window.bookingFlowComponent && window.bookingFlowComponent.updateNumberOfSessions) {
      window.bookingFlowComponent.updateNumberOfSessions(sessions);
      updateSessionsDisplay();
    }
  }

  function decreaseNumberOfSessions() {
    if (window.bookingFlowComponent) {
      const current = window.bookingFlowComponent.booking.repeat.numberOfSessions;
      updateNumberOfSessions(current - 1);
    }
  }

  function increaseNumberOfSessions() {
    if (window.bookingFlowComponent) {
      const current = window.bookingFlowComponent.booking.repeat.numberOfSessions;
      updateNumberOfSessions(current + 1);
    }
  }

  function handleSessionsInputChange(value) {
    const sessions = parseInt(value) || 1;
    updateNumberOfSessions(sessions);
  }

  function updateSessionsDisplay() {
    if (window.bookingFlowComponent) {
      const sessions = window.bookingFlowComponent.booking.repeat.numberOfSessions;
      
      // Update input value
      const input = document.getElementById('sessions-input');
      if (input) {
        input.value = sessions;
      }
      
      // Update button states
      const decreaseBtn = document.getElementById('sessions-decrease-btn');
      const increaseBtn = document.getElementById('sessions-increase-btn');
      
      if (decreaseBtn) {
        if (sessions <= 1) {
          decreaseBtn.classList.add('opacity-50', 'cursor-not-allowed');
          decreaseBtn.disabled = true;
        } else {
          decreaseBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          decreaseBtn.disabled = false;
        }
      }
      
      if (increaseBtn) {
        if (sessions >= 52) {
          increaseBtn.classList.add('opacity-50', 'cursor-not-allowed');
          increaseBtn.disabled = true;
        } else {
          increaseBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          increaseBtn.disabled = false;
        }
      }
      
      // Update savings message
      const savingsElement = document.getElementById('sessions-savings');
      if (savingsElement) {
        if (sessions >= 8) {
          savingsElement.innerHTML = '<span class="text-green-600 font-medium">ðŸ’° Save 25% on 8+ sessions!</span>';
        } else if (sessions >= 4) {
          savingsElement.innerHTML = '<span class="text-green-600 font-medium">ðŸ’° Save 15% on 4+ sessions!</span>';
        } else {
          savingsElement.innerHTML = '<span class="text-gray-500">Book 4+ sessions to save money</span>';
        }
      }
      
      // Update pricing displays
      updatePricingDisplays();
    }
  }

  function updateDuration(change) {
    if (window.bookingFlowComponent && window.bookingFlowComponent.updateDuration) {
      window.bookingFlowComponent.updateDuration(change);
      window.bookingFlowComponent.calculateRepeatPricing();
      
      // Update duration display
      const durationDisplay = document.getElementById('duration-display');
      if (durationDisplay) {
        durationDisplay.textContent = window.bookingFlowComponent.booking.details.duration + ' hrs';
      }
      
      updatePricingDisplays();
    }
  }

  function updateHomeSizeDuration() {
    if (window.bookingFlowComponent && window.bookingFlowComponent.updateHomeSizeDuration) {
      const select = document.getElementById('home-size-select');
      if (select) {
        window.bookingFlowComponent.booking.details.homeSize = select.value;
      }
      
      window.bookingFlowComponent.updateHomeSizeDuration();
      window.bookingFlowComponent.calculateRepeatPricing();
      
      // Update duration display
      const durationDisplay = document.getElementById('duration-display');
      if (durationDisplay) {
        durationDisplay.textContent = window.bookingFlowComponent.booking.details.duration + ' hrs';
      }
      
      updatePricingDisplays();
    }
  }

  function updatePricingDisplays() {
    if (window.bookingFlowComponent) {
      // Update sessions display in sidebar
      const sessionsElement = document.querySelector('[data-sessions]');
      if (sessionsElement) {
        sessionsElement.textContent = window.bookingFlowComponent.booking.repeat.numberOfSessions;
      }
      
      // Update total cost in sidebar
      const totalCostElement = document.querySelector('[data-total-cost]');
      if (totalCostElement) {
        totalCostElement.textContent = window.bookingFlowComponent.formatCurrency(window.bookingFlowComponent.booking.pricing.bookingCost);
      }
      
      // Update duration display in sidebar
      const durationElement = document.querySelector('[data-duration]');
      if (durationElement) {
        durationElement.textContent = window.bookingFlowComponent.booking.details.duration + ' hrs each';
      }
    }
  }

  function calculateRepeatPricing() {
    if (window.bookingFlowComponent && window.bookingFlowComponent.calculateRepeatPricing) {
      window.bookingFlowComponent.calculateRepeatPricing();
    }
  }

  function findWorker() {
    if (window.bookingFlowComponent && window.bookingFlowComponent.findWorker) {
      window.bookingFlowComponent.findWorker();
    }
  }

  function goToScreen(screenNumber) {
    if (window.bookingFlowComponent && window.bookingFlowComponent.goToScreen) {
      window.bookingFlowComponent.goToScreen(screenNumber);
    }
  }

  function initializeRepeatBookingDisplays() {
    if (window.bookingFlowComponent) {
      // Set default frequency selection visual
      setRepeatFrequency(window.bookingFlowComponent.booking.repeat.frequency);
      
      // Update sessions display
      updateSessionsDisplay();
      
      // Update duration display
      const durationDisplay = document.getElementById('duration-display');
      if (durationDisplay) {
        durationDisplay.textContent = window.bookingFlowComponent.booking.details.duration + ' hrs';
      }
      
      // Update pricing displays
      updatePricingDisplays();
      
      // Set home size selection
      const homeSizeSelect = document.getElementById('home-size-select');
      if (homeSizeSelect) {
        homeSizeSelect.value = window.bookingFlowComponent.booking.details.homeSize;
      }
      
      // Set start time selection
      const startTimeSelect = document.getElementById('start-time-select');
      if (startTimeSelect) {
        startTimeSelect.value = window.bookingFlowComponent.booking.details.startTime || '07:00 - 07:30';
      }
      
      // Set special instructions
      const specialInstructions = document.getElementById('special-instructions');
      if (specialInstructions) {
        specialInstructions.value = window.bookingFlowComponent.booking.details.notes || '';
      }
    }
  }

  // Add event listeners for fallback events
  window.addEventListener("booking-proceed-to-payment", function () {
    if (window.bookingFlowComponent && window.bookingFlowComponent.goToScreen) {
      window.bookingFlowComponent.goToScreen(13);
    }
  });

  window.addEventListener("booking-go-back", function () {
    if (
      window.bookingFlowComponent &&
      window.bookingFlowComponent.goToChooseWorker
    ) {
      window.bookingFlowComponent.goToChooseWorker();
    }
  });
</script>
