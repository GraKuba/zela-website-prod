{% load static %}
<!-- Screen 13: Select Payment Method -->
<div class="min-h-screen bg-white flex flex-col">
  <!-- Progress Header -->
  {% include "website/components/booking-flow/partials/booking-progress-header.html" %}

  <!-- Main Content -->
  <div class="flex max-w-7xl mx-auto px-6 py-8">
    <!-- Left Column - Booking Details -->
    <div class="w-80 flex-shrink-0 mr-8 space-y-6">
      <!-- Total -->
      <div class="bg-white border border-gray-200 rounded-2xl p-6">
        <h3 class="text-lg font-bold mb-4" style="color: #011e41">
          Resumo do Pagamento
        </h3>
        <div class="bg-[#F4D35E] text-[#011e41] rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div class="text-lg font-bold" x-text="`Total: AOA ${(window.bookingFlowComponent?.booking?.pricing?.total || 0).toLocaleString('pt-AO')}`">Total: AOA 0</div>
            <button
              class="text-[#011e41]/60 hover:text-[#011e41] cursor-pointer"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Location & Service Details -->
      <div class="bg-white border border-gray-200 rounded-2xl p-6">
        <!-- Location -->
        <div class="flex items-center justify-between mb-4">
          <div>
            <div class="text-sm text-gray-600 mb-1">Onde:</div>
            <div class="text-sm font-medium" style="color: #011e41" 
                 x-text="window.bookingFlowComponent?.booking?.location?.streetAddress ? 
                         (window.bookingFlowComponent.booking.location.streetAddress.length > 35 ? 
                          window.bookingFlowComponent.booking.location.streetAddress.substring(0, 35) + '...' : 
                          window.bookingFlowComponent.booking.location.streetAddress) : 
                         'Endereço não definido'">
              Endereço não definido
            </div>
          </div>
          <button class="text-gray-400 hover:text-gray-600 cursor-pointer">
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              />
            </svg>
          </button>
        </div>

        <!-- Service Type -->
        <div class="flex items-center justify-between mb-4">
          <div>
            <div class="text-sm text-gray-600 mb-1">O quê:</div>
            <div class="text-sm font-medium" style="color: #011e41"
                 x-text="(() => {
                   const serviceMap = {
                     'indoor-cleaning': 'Limpeza Interna',
                     'outdoor': 'Serviços Externos',
                     'office': 'Limpeza de Escritório',
                     'moving': 'Limpeza de Mudança',
                     'express': 'Limpeza Express',
                     'laundry': 'Lavandaria e Engomadoria',
                     'electrician': 'Eletricista',
                     'ac-repair': 'Reparação de AC',
                     'pest-control': 'Desinfestação',
                     'dog-trainer': 'Adestrador'
                   };
                   const serviceType = window.bookingFlowComponent?.booking?.serviceType || 'indoor-cleaning';
                   return serviceMap[serviceType] || 'Limpeza Interna';
                 })()">
              Limpeza Interna
            </div>
          </div>
          <button class="text-gray-400 hover:text-gray-600 cursor-pointer">
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              />
            </svg>
          </button>
        </div>

        <!-- When -->
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm text-gray-600 mb-1">Quando:</div>
            <div class="text-sm font-medium" style="color: #011e41"
                 x-text="(() => {
                   const booking = window.bookingFlowComponent?.booking;
                   if (!booking?.date) return 'Data não definida';
                   
                   const date = new Date(booking.date);
                   const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                   const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                   
                   const dayName = days[date.getDay()];
                   const day = date.getDate();
                   const month = months[date.getMonth()];
                   const time = booking.timeWindow || booking.details?.startTime || '07:00';
                   
                   return `${dayName} ${day} ${month} @ ${time.split(' - ')[0]}`;
                 })()">
              Data não definida
            </div>
          </div>
          <button class="text-gray-400 hover:text-gray-600 cursor-pointer">
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Right Column - Payment Method Selection -->
    <div class="flex-1">
      <div class="max-w-2xl">
        <h2 class="text-2xl font-bold mb-8" style="color: #011e41">
          Qual é o seu método de pagamento preferido?
        </h2>
        <p class="text-gray-600 mb-6" x-text="`Total a pagar: AOA ${(window.bookingFlowComponent?.booking?.pricing?.total || 0).toLocaleString('pt-AO')}`">Total a pagar: AOA 0</p>

        <div class="space-y-4 mb-8">
          <!-- Credit Card / UCount -->
          <div
            id="payment-credit-card"
            onclick="selectPaymentMethod('credit-card')"
            class="bg-white border-2 border-gray-200 hover:border-[#015e73] rounded-2xl p-6 cursor-pointer transition-colors duration-200"
          >
            <div class="flex items-center">
              <div
                id="radio-credit-card"
                class="w-6 h-6 rounded-full border-2 border-gray-300 mr-4 flex items-center justify-center"
              >
                <div
                  id="radio-dot-credit-card"
                  class="w-2 h-2 bg-white rounded-full"
                  style="display: none"
                ></div>
              </div>
              <div class="flex items-center">
                <svg
                  class="w-8 h-8 mr-3 text-blue-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"
                  />
                </svg>
                <span class="font-medium" style="color: #011e41"
                  >Cartão de Crédito / UCount</span
                >
              </div>
            </div>
          </div>

          <!-- EFT -->
          <div
            id="payment-eft"
            class="bg-white border-2 border-gray-200 rounded-2xl p-6 cursor-not-allowed opacity-60 transition-colors duration-200 relative"
          >
            <div class="flex items-center">
              <div
                id="radio-eft"
                class="w-6 h-6 rounded-full border-2 border-gray-200 mr-4 flex items-center justify-center bg-gray-50"
              >
                <div
                  id="radio-dot-eft"
                  class="w-2 h-2 bg-white rounded-full"
                  style="display: none"
                ></div>
              </div>
              <div class="flex items-center">
                <svg
                  class="w-8 h-8 mr-3 text-green-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                  />
                </svg>
                <span class="font-medium" style="color: #011e41"
                  >Transferência Bancária</span
                >
                <span
                  class="ml-2 text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full"
                  >Em breve</span
                >
              </div>
            </div>
          </div>

          <!-- SnapScan -->
          <div
            id="payment-snapscan"
            class="bg-white border-2 border-gray-200 rounded-2xl p-6 cursor-not-allowed opacity-60 transition-colors duration-200 relative"
          >
            <div class="flex items-center">
              <div
                id="radio-snapscan"
                class="w-6 h-6 rounded-full border-2 border-gray-200 mr-4 flex items-center justify-center bg-gray-50"
              >
                <div
                  id="radio-dot-snapscan"
                  class="w-2 h-2 bg-white rounded-full"
                  style="display: none"
                ></div>
              </div>
              <div class="flex items-center">
                <svg
                  class="w-8 h-8 mr-3 text-orange-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"
                  />
                </svg>
                <span class="font-medium" style="color: #011e41">SnapScan</span>
                <span
                  class="ml-2 text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full"
                  >Em breve</span
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Info -->
        <div class="mb-8" id="payment-info-section" style="display: none">
          <h3 class="text-xl font-bold mb-4" style="color: #011e41">
            Informações de Pagamento
          </h3>

          <!-- Test Mode Notice -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
              <svg
                class="w-5 h-5 text-blue-600 mt-0.5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <div class="text-sm text-blue-800">
                <p class="font-medium mb-1">Modo de Teste Ativo</p>
                <p>
                  O processamento de pagamento está atualmente em modo de teste.
                  Nenhuma cobrança real será feita.
                </p>
              </div>
            </div>
          </div>

          <!-- Saved Cards -->
          <div class="space-y-3 mb-4" id="saved-cards-container">
            <!-- Cards will be loaded here dynamically -->
          </div>

          <button
            onclick="addNewCard()"
            class="flex items-center text-green-600 hover:text-green-700 font-medium transition-colors duration-200 cursor-pointer"
          >
            <svg
              class="w-5 h-5 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 4v16m8-8H4"
              />
            </svg>
            Adicionar novo cartão
          </button>
        </div>

        <!-- Action Buttons -->
        <div class="flex space-x-4">
          <button
            onclick="continueToCard()"
            class="flex-1 py-3 px-6 bg-[#015e73] text-white font-semibold rounded-full hover:bg-[#014a5a] transition-colors duration-200 cursor-pointer"
          >
            Continuar
          </button>
          <button
            onclick="goBackToWorker()"
            class="flex-1 py-3 px-6 bg-white border border-gray-300 text-gray-700 font-semibold rounded-full hover:bg-gray-50 transition-colors duration-200 cursor-pointer"
          >
            Voltar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let selectedPaymentMethod = null;

  function selectPaymentMethod(method) {
    // Prevent selection of coming soon methods
    if (method === "eft" || method === "snapscan") {
      return;
    }

    // Clear all previous selections
    ["credit-card", "eft", "snapscan"].forEach((methodId) => {
      const element = document.getElementById(`payment-${methodId}`);
      const radio = document.getElementById(`radio-${methodId}`);
      const dot = document.getElementById(`radio-dot-${methodId}`);

      if (element && radio && dot) {
        element.className =
          "bg-white border-2 border-gray-200 hover:border-[#015e73] rounded-2xl p-6 cursor-pointer transition-colors duration-200";
        radio.className =
          "w-6 h-6 rounded-full border-2 border-gray-300 mr-4 flex items-center justify-center";
        dot.style.display = "none";
      }
    });

    // Set the selected method
    selectedPaymentMethod = method;
    const element = document.getElementById(`payment-${method}`);
    const radio = document.getElementById(`radio-${method}`);
    const dot = document.getElementById(`radio-dot-${method}`);

    if (element && radio && dot) {
      element.className =
        "bg-white border-2 border-[#015e73] bg-[#015e73]/10 rounded-2xl p-6 cursor-pointer transition-colors duration-200";
      radio.className =
        "w-6 h-6 rounded-full border-2 border-[#015e73] bg-[#015e73] mr-4 flex items-center justify-center";
      dot.style.display = "block";
    }

    // Update the main booking data if the global component is available
    if (window.bookingFlowComponent) {
      window.bookingFlowComponent.booking.payment.method = method;
    }

    // Show payment info section for credit card
    const paymentInfoSection = document.getElementById("payment-info-section");
    if (paymentInfoSection) {
      paymentInfoSection.style.display =
        method === "credit-card" ? "block" : "none";
    }

    // Load saved cards if credit card is selected
    if (method === "credit-card") {
      loadSavedCards();
    }
  }

  function loadSavedCards() {
    // Load saved cards from the user's profile
    fetch("/api/payment-methods/")
      .then((response) => response.json())
      .then((data) => {
        const container = document.getElementById("saved-cards-container");
        if (container && data.cards) {
          container.innerHTML = data.cards
            .map(
              (card) => `
            <div class="border border-gray-200 rounded-lg p-4 cursor-pointer hover:border-[#015e73] transition-colors"
                 onclick="selectCard('${card.id}')">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <input type="radio" name="card" value="${
                    card.id
                  }" class="text-[#015e73]" />
                  <div>
                    <div class="font-medium">•••• •••• •••• ${card.last4}</div>
                    <div class="text-sm text-gray-500">${
                      card.brand
                    } - Expires ${card.exp_month}/${card.exp_year}</div>
                  </div>
                </div>
                ${
                  card.is_default
                    ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Default</span>'
                    : ""
                }
              </div>
            </div>
          `
            )
            .join("");
        }
      })
      .catch((error) => {
        console.log("Using mock data for cards");
        // Mock data for demo
        const container = document.getElementById("saved-cards-container");
        if (container) {
          container.innerHTML = `
            <div class="border border-gray-200 rounded-lg p-4 cursor-pointer hover:border-[#015e73] transition-colors"
                 onclick="selectCard('mock-1')">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <input type="radio" name="card" value="mock-1" class="text-[#015e73]" />
                  <div>
                    <div class="font-medium">•••• •••• •••• 4242</div>
                    <div class="text-sm text-gray-500">Visa - Expires 12/25</div>
                  </div>
                </div>
                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Default</span>
              </div>
            </div>
          `;
        }
      });
  }

  function selectCard(cardId) {
    if (window.bookingFlowComponent) {
      window.bookingFlowComponent.booking.payment.cardId = cardId;
    }
    // Update radio button
    const radio = document.querySelector(`input[value="${cardId}"]`);
    if (radio) {
      radio.checked = true;
    }
  }

  function applyVoucher() {
    const input = document.getElementById("voucher-input");
    const voucher = input.value.trim();

    if (voucher) {
      // Update the global component if available
      if (window.bookingFlowComponent) {
        window.bookingFlowComponent.booking.voucher = voucher;
      }

      // You could add voucher validation logic here
      alert(`Voucher "${voucher}" aplicado com sucesso!`);
    } else {
      alert("Por favor, insira um código de voucher");
    }
  }

  function addNewCard() {
    // Navigate to add new card flow or show modal
    if (window.bookingFlowComponent && window.bookingFlowComponent.goToScreen) {
      // You could navigate to a new card screen (e.g., screen 15)
      // window.bookingFlowComponent.goToScreen(15);
      alert(
        "Funcionalidade adicionar cartão - isto abriria um formulário para adicionar um novo cartão"
      );
    } else {
      alert(
        "Funcionalidade adicionar cartão - isto abriria um formulário para adicionar um novo cartão"
      );
    }
  }

  // Handle card selection
  document.addEventListener("DOMContentLoaded", function () {
    const cardSelect = document.getElementById("card-select");
    if (cardSelect) {
      cardSelect.addEventListener("change", function () {
        const selectedCard = this.value;
        if (window.bookingFlowComponent) {
          window.bookingFlowComponent.booking.payment.cardId = selectedCard;
        }
      });
    }
  });

  function continueToCard() {
    if (!selectedPaymentMethod) {
      alert("Por favor, selecione um método de pagamento primeiro");
      return;
    }

    // For credit card, check if a card is selected
    if (selectedPaymentMethod === "credit-card") {
      const selectedCard = document.querySelector('input[name="card"]:checked');
      if (!selectedCard) {
        alert("Por favor, selecione um cartão ou adicione um novo");
        return;
      }
    }

    // Use the global component if available
    if (window.bookingFlowComponent) {
      // Show a loading state or confirmation
      const continueBtn = event.target;
      const originalText = continueBtn.textContent;
      continueBtn.textContent = "Processando...";
      continueBtn.disabled = true;

      // Complete the booking after a short delay for UX
      setTimeout(() => {
        window.bookingFlowComponent.completeBooking();
      }, 1000);
    } else {
      console.error("Could not find booking flow component");
    }
  }

  function goBackToWorker() {
    // Use the global component's previousScreen method to navigate back properly
    if (window.bookingFlowComponent && window.bookingFlowComponent.previousScreen) {
      window.bookingFlowComponent.previousScreen();
    } else {
      console.error("Could not find booking flow component or previousScreen method");
    }
  }
</script>
