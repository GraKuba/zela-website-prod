{% load static %}

<!-- Individual Worker Screen -->
<div class="min-h-screen bg-white flex flex-col">
  <!-- Sticky Header with Progress -->
  <div class="sticky top-0 z-50 bg-white border-b border-gray-200 p-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <img src="{% static 'zela-logo.png' %}" alt="Zela" class="w-10 h-10" />
        <span class="ml-3 text-xl font-bold" style="color: #011e41">Zela</span>
      </div>

      <!-- Progress Bar -->
      <div class="flex-1 max-w-md mx-auto">
        <div class="flex items-start justify-between mb-4">
          <div class="flex items-center">
            <div
              class="w-8 h-8 bg-[#015e73] text-white rounded-full flex items-center justify-center text-sm font-bold"
            >
              1
            </div>
            <div class="ml-2 text-sm font-medium" style="color: #011e41">
              Detalhes
            </div>
          </div>
          <div class="flex items-center">
            <div
              class="w-8 h-8 bg-[#015e73] text-white rounded-full flex items-center justify-center text-sm font-bold"
            >
              2
            </div>
            <div class="ml-2 text-sm font-medium" style="color: #011e41">
              Trabalhador
            </div>
          </div>
          <div class="flex items-center">
            <div
              class="w-8 h-8 bg-gray-200 text-gray-600 rounded-full flex items-center justify-center text-sm font-bold"
            >
              3
            </div>
            <div class="ml-2 text-sm text-gray-600">Pagamento</div>
          </div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div
            class="bg-[#015e73] h-2 rounded-full"
            style="width: 66.66%"
          ></div>
        </div>
      </div>

      <div class="flex items-center space-x-4">
        <div
          @click="window.location.href = '/dashboard/'"
          class="w-10 h-10 bg-[#015e73] rounded-full flex items-center justify-center text-white font-bold cursor-pointer hover:bg-[#014a5a] transition-colors"
        >
          JG
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content with Sticky Sidebar -->
  <div class="flex flex-1 max-w-7xl mx-auto w-full">
    <!-- Sticky Left Column - Booking Details -->
    <div
      class="w-80 flex-shrink-0 sticky top-0 h-screen overflow-y-auto px-6 py-8 space-y-6"
    >
      <!-- Booking Details -->
      <div class="bg-white border border-gray-200 rounded-2xl p-6">
        <h3 class="text-lg font-bold mb-4" style="color: #011e41">
          Detalhes da Reserva
        </h3>

        <!-- Pricing Display -->
        <div class="bg-gray-900 text-white rounded-2xl p-4">
          <div class="flex justify-between items-center mb-2">
            <div class="text-2xl font-bold">
              <span x-show="window.bookingFlowComponent && window.bookingFlowComponent.booking" x-text="window.bookingFlowComponent?.booking?.details?.duration || '5.5'"></span>
              <span x-show="!window.bookingFlowComponent || !window.bookingFlowComponent.booking">5.5</span>
            </div>
            <div class="text-2xl font-bold">
              <span x-show="window.bookingFlowComponent && window.bookingFlowComponent.booking" x-text="window.bookingFlowComponent?.formatCurrency ? window.bookingFlowComponent.formatCurrency(window.bookingFlowComponent.booking?.pricing?.bookingCost || 710) : 'R710'"></span>
              <span x-show="!window.bookingFlowComponent || !window.bookingFlowComponent.booking">R710</span>
            </div>
          </div>
          <div class="flex justify-between text-sm text-gray-300">
            <div>Total de horas</div>
            <div>Preço da Reserva</div>
          </div>
        </div>
      </div>

      <!-- Location & Service Details -->
      <div class="bg-white border border-gray-200 rounded-2xl p-6">
        <!-- Location -->
        <div class="flex items-center justify-between mb-4">
          <div>
            <div class="text-sm text-gray-600 mb-1">Onde:</div>
            <div class="text-sm font-medium" style="color: #011e41" id="location-display">
              <span x-show="window.bookingFlowComponent && window.bookingFlowComponent.booking && window.bookingFlowComponent.booking.location.streetAddress" 
                    x-text="window.bookingFlowComponent?.booking?.location?.streetAddress ? window.bookingFlowComponent.booking.location.streetAddress.substring(0, 30) + '...' : 'Selecione uma localização'"></span>
              <span x-show="!window.bookingFlowComponent || !window.bookingFlowComponent.booking.location.streetAddress">
                Selecione uma localização
              </span>
            </div>
          </div>
          <button class="text-gray-400 hover:text-gray-600 cursor-pointer" onclick="window.bookingFlowComponent && window.bookingFlowComponent.goToScreen(1)">
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              />
            </svg>
          </button>
        </div>

        <!-- Service Type -->
        <div class="flex items-center justify-between mb-4">
          <div>
            <div class="text-sm text-gray-600 mb-1">O quê:</div>
            <div class="text-sm font-medium" style="color: #011e41">
              <span x-show="window.bookingFlowComponent && window.bookingFlowComponent.booking" x-text="window.bookingFlowComponent?.serviceInfo?.[window.bookingFlowComponent?.booking?.serviceType]?.name || 'Limpeza Interior'"></span>
              <span x-show="!window.bookingFlowComponent || !window.bookingFlowComponent.booking">Limpeza Interior</span>
            </div>
          </div>
          <button class="text-gray-400 hover:text-gray-600 cursor-pointer">
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              />
            </svg>
          </button>
        </div>

        <!-- When -->
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm text-gray-600 mb-1">Quando:</div>
            <div class="text-sm font-medium" style="color: #011e41" id="date-display">
              <!-- Will be updated by JavaScript -->
            </div>
          </div>
          <button class="text-gray-400 hover:text-gray-600 cursor-pointer" onclick="window.bookingFlowComponent && window.bookingFlowComponent.goToScreen(7)">
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              />
            </svg>
          </button>
        </div>
      </div>

      <!-- Selected Worker -->
      <div class="bg-white border border-gray-200 rounded-2xl p-6 text-center">
        <div
          class="w-16 h-16 bg-gray-300 rounded-full mx-auto mb-3 overflow-hidden"
        >
          <img
            src="{% static 'beatriz.webp' %}"
            alt="Memory Mudede"
            class="w-full h-full object-cover"
          />
        </div>
        <div class="text-lg font-bold mb-2" style="color: #011e41">
          Memory Mudede
        </div>
        <div class="flex items-center justify-center mb-2">
          <svg
            class="w-4 h-4 text-[#015e73] mr-1"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              d="M12 17.27L18.18 21L16.54 13.97L22 9.24L14.81 8.63L12 2L9.19 8.63L2 9.24L7.46 13.97L5.82 21L12 17.27Z"
            />
          </svg>
          <span class="text-sm font-medium" style="color: #011e41"
            >98% Recomendam</span
          >
        </div>
        <div class="text-sm text-gray-600">423 Trabalhos Concluídos</div>
      </div>
    </div>

    <!-- Scrollable Right Column - Tip & Payment -->
    <div class="flex-1 overflow-y-auto px-6 py-8">
      <div class="max-w-2xl mx-auto">
        <!-- Enhanced Tip Section -->
        {% include 'website/components/booking-flow/partials/tip-selection.html' %}

        <!-- Price Breakdown -->
        <div class="bg-white border border-gray-200 rounded-2xl p-6 mb-8">
          <h3 class="text-2xl font-bold mb-6" style="color: #011e41">
            Discriminação do Preço
          </h3>

          <!-- Booking Cost -->
          <div class="mb-6">
            <h4 class="text-lg font-bold mb-4" style="color: #011e41">
              Custo da Reserva
            </h4>
            <div class="flex justify-between items-center">
              <div>
                <div class="font-medium" style="color: #011e41" id="booking-day">Mon</div>
                <div class="text-sm text-gray-600" id="booking-hours-time">
                  <span x-show="window.bookingFlowComponent && window.bookingFlowComponent.booking" x-text="`${window.bookingFlowComponent?.booking?.details?.duration || '5.5'} hrs @ ${window.bookingFlowComponent?.booking?.details?.startTime || '07:00'}`"></span>
                  <span x-show="!window.bookingFlowComponent || !window.bookingFlowComponent.booking">5.5 hrs @ 07:00</span>
                </div>
              </div>
              <div class="text-lg font-bold" style="color: #011e41" id="booking-cost">
                <span x-show="window.bookingFlowComponent && window.bookingFlowComponent.booking" x-text="window.bookingFlowComponent?.formatCurrency ? window.bookingFlowComponent.formatCurrency(window.bookingFlowComponent.booking?.pricing?.bookingCost || 710) : 'R710'"></span>
                <span x-show="!window.bookingFlowComponent || !window.bookingFlowComponent.booking">R710</span>
              </div>
            </div>
          </div>

          <!-- Other Costs -->
          <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
              <div class="flex items-center">
                <span class="text-lg font-bold" style="color: #011e41"
                  >Outros Custos</span
                >
                <button class="ml-2 text-gray-400 hover:text-gray-600">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path
                      d="M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2ZM13,17H11V11H13V17ZM13,9H11V7H13V9Z"
                    />
                  </svg>
                </button>
              </div>
              <div class="text-lg font-bold" style="color: #011e41">R60</div>
            </div>

            <!-- Booking Cover -->
            <div class="flex justify-between items-center mb-3">
              <div class="flex items-center">
                <span class="text-base" style="color: #011e41"
                  >Cobertura da Reserva</span
                >
                <button class="ml-2 text-gray-400 hover:text-gray-600">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path
                      d="M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2ZM13,17H11V11H13V17ZM13,9H11V7H13V9Z"
                    />
                  </svg>
                </button>
                <div class="ml-4 relative">
                  <input
                    type="checkbox"
                    id="bookingCover"
                    class="sr-only"
                    checked
                    onchange="toggleBookingCover(this.checked)"
                  />
                  <label
                    for="bookingCover"
                    class="flex items-center cursor-pointer"
                  >
                    <div
                      id="bookingCoverToggle"
                      class="w-12 h-6 bg-[#015e73] rounded-full relative transition-colors"
                    >
                      <div
                        id="bookingCoverSlider"
                        class="w-5 h-5 bg-white rounded-full absolute top-0.5 transition-transform translate-x-6"
                      ></div>
                    </div>
                    <span
                      id="bookingCoverLabel"
                      class="ml-2 text-sm font-medium text-white bg-[#015e73] px-2 py-1 rounded"
                    >
                      Sim
                    </span>
                  </label>
                </div>
              </div>
              <div class="text-base font-medium" style="color: #011e41">
                R21
              </div>
            </div>

            <!-- Service Fee -->
            <div class="flex justify-between items-center">
              <span class="text-base" style="color: #011e41">Taxa de Serviço</span>
              <div class="text-base font-medium" style="color: #011e41">
                R39
              </div>
            </div>
          </div>

          <!-- Booking Total -->
          <div class="border-t border-gray-200 pt-4 mb-6">
            <div class="flex justify-between items-center">
              <span class="text-lg font-bold" style="color: #011e41"
                >Total da Reserva</span
              >
              <div class="text-lg font-bold" style="color: #011e41">R400</div>
            </div>
          </div>

          <!-- SweepCred Wallet -->
          <div class="flex justify-between items-center mb-6">
            <span class="text-lg font-bold" style="color: #011e41"
              >Usar Carteira SweepCred</span
            >
            <div class="relative">
              <input
                type="checkbox"
                id="sweepCredWallet"
                class="sr-only"
                onchange="toggleSweepCred(this.checked)"
              />
              <label
                for="sweepCredWallet"
                class="flex items-center cursor-pointer"
              >
                <div
                  id="sweepCredToggle"
                  class="w-12 h-6 rounded-full relative transition-colors bg-orange-300"
                >
                  <div
                    id="sweepCredSlider"
                    class="w-5 h-5 bg-white rounded-full absolute top-0.5 transition-transform translate-x-0.5"
                  ></div>
                </div>
                <span
                  id="sweepCredLabel"
                  class="ml-2 text-sm font-medium text-white px-2 py-1 rounded bg-orange-300"
                >
                  Não
                </span>
              </label>
            </div>
          </div>

          <!-- Total Due -->
          <div class="border-t border-gray-200 pt-4">
            <div class="flex justify-between items-center">
              <div class="flex items-center">
                <span class="text-xl font-bold" style="color: #011e41"
                  >TOTAL A PAGAR</span
                >
                <button class="ml-2 text-gray-400 hover:text-gray-600">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path
                      d="M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2ZM13,17H11V11H13V17ZM13,9H11V7H13V9Z"
                    />
                  </svg>
                </button>
              </div>
              <div class="text-xl font-bold" style="color: #011e41">R400</div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex space-x-4">
          <button
            onclick="console.log('Proceed to Payment clicked'); proceedToPayment();"
            class="flex-1 bg-[#015e73] text-white font-bold py-4 px-6 rounded-2xl hover:bg-[#014a5a] transition-colors"
          >
            Prosseguir para Método de Pagamento
          </button>
          <button
            onclick="console.log('Back clicked'); goBack();"
            class="flex-1 bg-white border-2 border-gray-300 text-gray-700 font-bold py-4 px-6 rounded-2xl hover:bg-gray-50 transition-colors"
          >
            Voltar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Individual Worker Screen Functions -->
<script>
  // Tip selection functionality
  function selectTip(amount) {
    // Update the main booking data using global component
    if (window.bookingFlowComponent) {
      window.bookingFlowComponent.booking.tip.amount = amount;
      
      // Determine tip option based on amount
      let tipOption = 'custom';
      if (amount === 0) tipOption = 'no-tip';
      else if (amount === 25) tipOption = 'small';
      else if (amount === 50) tipOption = 'medium';
      else if (amount === 75) tipOption = 'large';
      else if (amount === 100) tipOption = 'generous';
      
      window.bookingFlowComponent.booking.tip.selectedOption = tipOption;
      
      // Save the tip data
      window.bookingFlowComponent.saveBookingData();
      
      // Update pricing
      updatePriceDisplay();
    }

    // Update UI to show selected tip
    document.querySelectorAll('[id^="tip-"]').forEach((btn) => {
      btn.className =
        "px-6 py-3 rounded-full border-2 font-medium transition-colors border-gray-300 text-gray-700 hover:border-gray-400";
    });

    if (document.getElementById(`tip-${amount}`)) {
      document.getElementById(`tip-${amount}`).className =
        "px-6 py-3 rounded-full border-2 font-medium transition-colors border-[#015e73] bg-[#015e73]/10 text-[#015e73]";
    }
  }

  function showCustomTip() {
    // Handle custom tip input
    const customAmount = prompt("Digite o valor da gorjeta personalizada (R):");
    if (customAmount && !isNaN(customAmount)) {
      const amount = parseInt(customAmount);
      selectTip(amount);
      
      // Also highlight the custom button
      const customBtn = document.querySelector('button[onclick="showCustomTip()"]');
      if (customBtn) {
        customBtn.className = "px-6 py-3 rounded-full border-2 border-[#015e73] bg-[#015e73]/10 text-[#015e73] font-medium transition-colors";
      }
    }
  }

  function toggleBookingCover(isChecked) {
    const toggle = document.getElementById("bookingCoverToggle");
    const slider = document.getElementById("bookingCoverSlider");
    const label = document.getElementById("bookingCoverLabel");

    if (isChecked) {
      toggle.className =
        "w-12 h-6 bg-[#015e73] rounded-full relative transition-colors";
      slider.className =
        "w-5 h-5 bg-white rounded-full absolute top-0.5 transition-transform translate-x-6";
      label.className =
        "ml-2 text-sm font-medium text-white bg-[#015e73] px-2 py-1 rounded";
      label.textContent = "Sim";
    } else {
      toggle.className =
        "w-12 h-6 bg-gray-300 rounded-full relative transition-colors";
      slider.className =
        "w-5 h-5 bg-white rounded-full absolute top-0.5 transition-transform translate-x-0.5";
      label.className =
        "ml-2 text-sm font-medium text-white bg-gray-300 px-2 py-1 rounded";
      label.textContent = "Não";
    }
  }

  function toggleSweepCred(isChecked) {
    const toggle = document.getElementById("sweepCredToggle");
    const slider = document.getElementById("sweepCredSlider");
    const label = document.getElementById("sweepCredLabel");

    if (isChecked) {
      toggle.className =
        "w-12 h-6 rounded-full relative transition-colors bg-[#015e73]";
      slider.className =
        "w-5 h-5 bg-white rounded-full absolute top-0.5 transition-transform translate-x-6";
      label.className =
        "ml-2 text-sm font-medium text-white px-2 py-1 rounded bg-[#015e73]";
      label.textContent = "Sim";
    } else {
      toggle.className =
        "w-12 h-6 rounded-full relative transition-colors bg-orange-300";
      slider.className =
        "w-5 h-5 bg-white rounded-full absolute top-0.5 transition-transform translate-x-0.5";
      label.className =
        "ml-2 text-sm font-medium text-white px-2 py-1 rounded bg-orange-300";
      label.textContent = "Não";
    }
  }
  
  function updatePriceDisplay() {
    // Update the total price display including tip
    if (window.bookingFlowComponent) {
      const booking = window.bookingFlowComponent.booking;
      const total = booking.pricing.total + booking.tip.amount;
      
      // Update booking total display
      const totalElements = document.querySelectorAll('[style*="color: #011e41"]');
      totalElements.forEach(el => {
        if (el.textContent.includes('R') && el.textContent.match(/R\d+/)) {
          if (el.previousElementSibling && el.previousElementSibling.textContent.includes('Booking Total')) {
            el.textContent = `R${total}`;
          }
        }
      });
    }
  }
  
  // Initialize tip selection on page load
  document.addEventListener('DOMContentLoaded', function() {
    // Select default tip (R0)
    selectTip(0);
    
    // Update date display
    updateDateDisplay();
    
    // Update price displays
    updateAllPrices();
  });
  
  function updateDateDisplay() {
    if (window.bookingFlowComponent) {
      const booking = window.bookingFlowComponent.booking;
      const dateElement = document.getElementById('date-display');
      const dayElement = document.getElementById('booking-day');
      
      if (dateElement && booking.date) {
        const date = new Date(booking.date);
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        const dayName = days[date.getDay()];
        const dateStr = `${dayName} ${date.getDate()} ${months[date.getMonth()]} @ ${booking.details.startTime || '07:00'}`;
        
        dateElement.textContent = dateStr;
        if (dayElement) {
          dayElement.textContent = dayName;
        }
      }
    }
  }
  
  function updateAllPrices() {
    if (window.bookingFlowComponent) {
      const booking = window.bookingFlowComponent.booking;
      const pricing = booking.pricing;
      
      // Update booking total
      const bookingTotalElements = document.querySelectorAll('.text-lg.font-bold');
      bookingTotalElements.forEach(el => {
        if (el.previousElementSibling && el.previousElementSibling.textContent === 'Booking Total') {
          el.textContent = `R${pricing.bookingCost + pricing.otherCosts.bookingCover + pricing.otherCosts.serviceFee}`;
        }
      });
      
      // Update total due
      const totalDueElements = document.querySelectorAll('.text-xl.font-bold');
      totalDueElements.forEach(el => {
        if (el.previousElementSibling && el.previousElementSibling.querySelector('span')?.textContent === 'TOTAL DUE') {
          const totalWithTip = pricing.bookingCost + pricing.otherCosts.bookingCover + pricing.otherCosts.serviceFee + booking.tip.amount;
          el.textContent = `R${totalWithTip}`;
        }
      });
    }
  }
  
  // Call update functions when screen loads
  setTimeout(() => {
    updateDateDisplay();
    updateAllPrices();
  }, 100);
</script>
