{% load static %}

<!-- Screen 8-9: One-time Booking Details -->
<div class="min-h-screen bg-white flex flex-col">
  <!-- Progress Header -->
  {% include "website/components/booking-flow/partials/booking-progress-header.html" %}

  <!-- Main Content with Sticky Sidebar -->
  <div class="flex flex-col lg:flex-row flex-1 max-w-7xl mx-auto w-full">
    <!-- Sticky Left Column - Booking Details -->
    <div
      class="w-full lg:w-80 lg:flex-shrink-0 lg:sticky lg:top-0 lg:h-screen overflow-y-auto px-4 sm:px-6 py-4 sm:py-6 lg:py-8 space-y-4 sm:space-y-6 border-b lg:border-b-0 lg:border-r border-gray-200"
    >
      <!-- Booking Details -->
      <div class="bg-white border border-gray-200 rounded-2xl p-4 sm:p-6">
        <h3 class="text-base sm:text-lg font-bold mb-3 sm:mb-4" style="color: #011e41">
          Detalhes da Reserva
        </h3>

        <!-- Pricing Display -->
        <div class="bg-[#F4D35E] text-[#011e41] rounded-2xl p-5">
          <div class="space-y-4">
            <!-- Hours Row -->
            <div class="pb-3 border-b border-[#011e41]/20">
              <div class="text-2xl font-bold mb-1">
                <span x-text="booking.details.duration"></span> Horas
              </div>
              <div class="text-sm text-[#011e41]/70">Horas Est.</div>
            </div>
            <!-- Price Row -->
            <div>
              <div class="text-2xl font-bold mb-1" x-text="formatCurrency(booking.pricing.bookingCost)"></div>
              <div class="text-sm text-[#011e41]/70">Preço Est.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Location & Service Details -->
      <div class="bg-white border border-gray-200 rounded-2xl p-4 sm:p-6">
        <!-- Location -->
        <div class="flex items-center justify-between mb-4">
          <div>
            <div class="text-sm text-gray-600 mb-1">Onde:</div>
            <div
              class="text-sm font-medium"
              style="color: #011e41"
              x-text="booking.location.streetAddress.substring(0, 30) + (booking.location.streetAddress.length > 30 ? '...' : '')"
            ></div>
          </div>
          <button
            @click="goToScreen(1)"
            class="text-gray-400 hover:text-gray-600 cursor-pointer transition-colors"
            title="Edit location"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              />
            </svg>
          </button>
        </div>

        <!-- Service Type -->
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm text-gray-600 mb-1">O quê:</div>
            <div
              class="text-sm font-medium"
              style="color: #011e41"
              x-text="'{{ service_name|default:'Limpeza Interior' }}'"
            ></div>
          </div>
          <button
            @click="alert('O tipo de serviço não pode ser alterado nesta fase. Por favor, inicie uma nova reserva.')"
            class="text-gray-400 hover:text-gray-600 cursor-pointer transition-colors"
            title="Service type cannot be changed"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              />
            </svg>
          </button>
        </div>

        <!-- When -->
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm text-gray-600 mb-1">Quando:</div>
            <div class="text-sm font-medium" style="color: #011e41">
              <span
                x-text="(() => {
                  const selectedDate = booking.details.date || booking.date;
                  if (!selectedDate) return 'Selecione uma data';
                  const date = new Date(selectedDate);
                  const today = new Date();
                  const tomorrow = new Date(today);
                  tomorrow.setDate(tomorrow.getDate() + 1);
                  
                  // Check if selected date is tomorrow
                  if (date.toDateString() === tomorrow.toDateString()) {
                    return 'Amanhã';
                  }
                  
                  // Otherwise show the actual date
                  return date.toLocaleDateString('pt-PT', { weekday: 'short', month: 'short', day: 'numeric' });
                })()"
              ></span>
              @ <span x-text="booking.details.startTime || '07:00'"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scrollable Right Column - Booking Form -->
    <div class="flex-1 overflow-y-auto px-4 sm:px-6 py-4 sm:py-6 lg:py-8">
      <div class="max-w-2xl">
        <h2 class="text-2xl sm:text-3xl font-bold mb-2" style="color: #011e41">
          Reserva Única
        </h2>
        <p class="text-gray-600 mb-8">
          Obtenha ajuda pontual. Experimente um novo trabalhador. Cancele a
          qualquer momento
        </p>


        <!-- Form Fields -->
        <div class="space-y-6">
          <!-- Booking Details Header -->
          <div>
            <h3 class="text-base sm:text-lg font-bold mb-3 sm:mb-4" style="color: #011e41">
              Adicione detalhes sobre a sua reserva
            </h3>
          </div>

          <!-- Extra Tasks -->
          <div>
            <h4 class="text-base sm:text-lg font-bold mb-3 sm:mb-4" style="color: #011e41">
              Tarefas Extras
            </h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div
                @click="toggleExtraTask('inside-fridge')"
                class="bg-white border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:border-[#015e73] transition-colors duration-200 text-center relative"
                :class="{ 'border-[#015e73] bg-[#015e73]/10': booking.details.extraTasks.includes('inside-fridge') }"
              >
                <!-- Selected Checkmark -->
                <div
                  x-show="booking.details.extraTasks.includes('inside-fridge')"
                  class="absolute -top-2 -right-2 w-6 h-6 bg-[#015e73] rounded-full flex items-center justify-center"
                >
                  <svg
                    class="w-3 h-3 text-white"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"
                    />
                  </svg>
                </div>
                <svg
                  class="w-8 h-8 mx-auto mb-2"
                  :class="booking.details.extraTasks.includes('inside-fridge') ? 'text-[#015e73]' : 'text-gray-600'"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M9 9h.01M15 9h.01"
                  />
                </svg>
                <div
                  class="text-xs font-medium"
                  :class="booking.details.extraTasks.includes('inside-fridge') ? 'text-[#015e73]' : 'text-gray-700'"
                >
                  Interior do Frigorífico
                </div>
              </div>

              <div
                @click="toggleExtraTask('inside-oven')"
                class="bg-white border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:border-[#015e73] transition-colors duration-200 text-center relative"
                :class="{ 'border-[#015e73] bg-[#015e73]/10': booking.details.extraTasks.includes('inside-oven') }"
              >
                <!-- Selected Checkmark -->
                <div
                  x-show="booking.details.extraTasks.includes('inside-oven')"
                  class="absolute -top-2 -right-2 w-6 h-6 bg-[#015e73] rounded-full flex items-center justify-center"
                >
                  <svg
                    class="w-3 h-3 text-white"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"
                    />
                  </svg>
                </div>
                <svg
                  class="w-8 h-8 mx-auto mb-2"
                  :class="booking.details.extraTasks.includes('inside-oven') ? 'text-[#015e73]' : 'text-gray-600'"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16l3-1m-3 1l-3-1"
                  />
                </svg>
                <div
                  class="text-xs font-medium"
                  :class="booking.details.extraTasks.includes('inside-oven') ? 'text-[#015e73]' : 'text-gray-700'"
                >
                  Interior do Forno
                </div>
              </div>

              <div
                @click="toggleExtraTask('inside-cabinets')"
                class="bg-white border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:border-[#015e73] transition-colors duration-200 text-center relative"
                :class="{ 'border-[#015e73] bg-[#015e73]/10': booking.details.extraTasks.includes('inside-cabinets') }"
              >
                <!-- Selected Checkmark -->
                <div
                  x-show="booking.details.extraTasks.includes('inside-cabinets')"
                  class="absolute -top-2 -right-2 w-6 h-6 bg-[#015e73] rounded-full flex items-center justify-center"
                >
                  <svg
                    class="w-3 h-3 text-white"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"
                    />
                  </svg>
                </div>
                <svg
                  class="w-8 h-8 mx-auto mb-2"
                  :class="booking.details.extraTasks.includes('inside-cabinets') ? 'text-[#015e73]' : 'text-gray-600'"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                  />
                </svg>
                <div
                  class="text-xs font-medium"
                  :class="booking.details.extraTasks.includes('inside-cabinets') ? 'text-[#015e73]' : 'text-gray-700'"
                >
                  Interior dos Armários
                </div>
              </div>

              <div
                @click="toggleExtraTask('interior-windows')"
                class="bg-white border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:border-[#015e73] transition-colors duration-200 text-center relative"
                :class="{ 'border-[#015e73] bg-[#015e73]/10': booking.details.extraTasks.includes('interior-windows') }"
              >
                <!-- Selected Checkmark -->
                <div
                  x-show="booking.details.extraTasks.includes('interior-windows')"
                  class="absolute -top-2 -right-2 w-6 h-6 bg-[#015e73] rounded-full flex items-center justify-center"
                >
                  <svg
                    class="w-3 h-3 text-white"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"
                    />
                  </svg>
                </div>
                <svg
                  class="w-8 h-8 mx-auto mb-2"
                  :class="booking.details.extraTasks.includes('interior-windows') ? 'text-[#015e73]' : 'text-gray-600'"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"
                  />
                </svg>
                <div
                  class="text-xs font-medium"
                  :class="booking.details.extraTasks.includes('interior-windows') ? 'text-[#015e73]' : 'text-gray-700'"
                >
                  Janelas Interiores
                </div>
              </div>
            </div>
          </div>

          <!-- Duration -->
          <div>
            <h4 class="text-base sm:text-lg font-bold mb-3 sm:mb-4" style="color: #011e41">
              Duração da Reserva
            </h4>
            <div class="flex items-center space-x-4">
              <button
                @click="updateDuration(-0.5)"
                :disabled="booking.details.duration <= 1"
                class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center transition-colors"
                :class="booking.details.duration <= 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-300 cursor-pointer'"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M20 12H4"
                  />
                </svg>
              </button>
              <div class="text-center">
                <div
                  class="text-2xl font-bold"
                  x-text="booking.details.duration"
                ></div>
                <div x-show="booking.details.duration >= 8" class="text-xs text-gray-500 mt-1">Máximo</div>
              </div>
              <button
                @click="updateDuration(0.5)"
                :disabled="booking.details.duration >= 8"
                class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center transition-colors"
                :class="booking.details.duration >= 8 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-300 cursor-pointer'"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6v12m6-6H6"
                  />
                </svg>
              </button>
            </div>
            <p class="text-sm text-gray-500 mt-2">Entre 1 e 8 horas</p>
          </div>

          <!-- Date Selection -->
          <div>
            <h4 class="text-base sm:text-lg font-bold mb-3 sm:mb-4" style="color: #011e41">
              Quando precisa de ajuda?
            </h4>
            <div x-data="{ 
              showCalendar: false,
              getDateLabel(daysFromToday) {
                if (daysFromToday === 0) return 'Hoje';
                if (daysFromToday === 1) return 'Amanhã';
                const date = new Date();
                date.setDate(date.getDate() + daysFromToday);
                return date.toLocaleDateString('pt-PT', { weekday: 'short', day: 'numeric', month: 'short' });
              },
              getDateValue(daysFromToday) {
                const date = new Date();
                date.setDate(date.getDate() + daysFromToday);
                return date.toISOString().split('T')[0];
              },
              selectDate(daysFromToday) {
                booking.details.date = this.getDateValue(daysFromToday);
                this.showCalendar = false;
                window.bookingFlowComponent.saveBookingData();
              }
            }">
              <!-- Quick Date Selection Cards -->
              <div x-show="!showCalendar" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                <!-- Tomorrow -->
                <button
                  @click="selectDate(1)"
                  class="p-3 border-2 rounded-lg transition-all text-center cursor-pointer hover:shadow-md"
                  :class="booking.details.date === getDateValue(1) ? 'border-[#015e73] bg-[#015e73]/10' : 'border-gray-200 hover:border-[#015e73] hover:bg-gray-50'"
                >
                  <div class="font-bold text-sm" style="color: #011e41">Amanhã</div>
                  <div class="text-xs text-gray-500" x-text="(() => { const d = new Date(); d.setDate(d.getDate() + 1); return d.getDate(); })()"></div>
                </button>
                
                <!-- Next 3 days -->
                <template x-for="day in [2, 3, 4]" :key="day">
                  <button
                    @click="selectDate(day)"
                    class="p-3 border-2 rounded-lg transition-all text-center cursor-pointer hover:shadow-md"
                    :class="booking.details.date === getDateValue(day) ? 'border-[#015e73] bg-[#015e73]/10' : 'border-gray-200 hover:border-[#015e73] hover:bg-gray-50'"
                  >
                    <div class="font-bold text-sm" style="color: #011e41" x-text="getDateLabel(day).split(',')[0]"></div>
                    <div class="text-xs text-gray-500" x-text="(() => { const d = new Date(); d.setDate(d.getDate() + day); return d.getDate(); })()"></div>
                  </button>
                </template>
              </div>
              
              <!-- More dates button -->
              <button
                @click="showCalendar = true"
                x-show="!showCalendar"
                class="w-full p-3 border-2 border-gray-200 rounded-lg hover:border-[#015e73] hover:bg-gray-50 hover:shadow-md transition-all text-center cursor-pointer"
              >
                <span class="text-sm font-medium" style="color: #011e41">Mais datas...</span>
              </button>
              
              <!-- Calendar input (fallback) -->
              <div x-show="showCalendar">
                <input
                  type="date"
                  x-model="booking.details.date"
                  @change="window.bookingFlowComponent.saveBookingData()"
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#015e73] focus:border-transparent cursor-pointer transition-colors"
                  :min="(() => { const d = new Date(); d.setDate(d.getDate() + 1); return d.toISOString().split('T')[0]; })()"
                  required
                />
                <button
                  @click="showCalendar = false"
                  class="mt-2 text-sm text-gray-500 hover:text-gray-700"
                >
                  Voltar às opções rápidas
                </button>
              </div>
            </div>
          </div>

          <!-- Start Time -->
          <div>
            <h4 class="text-base sm:text-lg font-bold mb-3 sm:mb-4" style="color: #011e41">
              Selecione a hora de início:
            </h4>
            <select
              x-model="booking.details.startTime"
              @change="window.bookingFlowComponent.saveBookingData()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#015e73] focus:border-transparent cursor-pointer"
            >
              <template x-for="time in timeSlots" :key="time">
                <option :value="time" x-text="time"></option>
              </template>
            </select>
          </div>

          <!-- Special Instructions -->
          <div>
            <h4 class="text-base sm:text-lg font-bold mb-3 sm:mb-4" style="color: #011e41">
              Adicione instruções específicas
            </h4>
            <textarea
              x-model="booking.details.notes"
              @input="window.bookingFlowComponent.saveBookingData()"
              placeholder="Adicione as suas notas aqui"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#015e73] focus:border-transparent h-24 resize-none"
            ></textarea>
          </div>

          <!-- Action Buttons -->
          <div class="flex space-x-4 pt-6">
            <button
              @click="() => {
                if (!booking.details.date) {
                  alert('Por favor, selecione uma data para a sua reserva');
                  return;
                }
                const selectedDate = new Date(booking.details.date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (selectedDate < today) {
                  alert('Por favor, selecione uma data válida (a partir de hoje)');
                  return;
                }
                findWorker();
              }"
              class="flex-1 min-h-[44px] py-2.5 sm:py-3 px-3 sm:px-4 lg:px-6 bg-[#015e73] text-white font-semibold rounded-full hover:bg-[#014a5a] transition-colors duration-200 cursor-pointer text-sm sm:text-base"
            >
              Encontrar um Trabalhador
            </button>
            <button
              @click="goToScreen(2)"
              class="flex-1 min-h-[44px] py-2.5 sm:py-3 px-3 sm:px-4 lg:px-6 bg-white border border-gray-300 text-gray-700 font-semibold rounded-full hover:bg-gray-50 transition-colors duration-200 cursor-pointer text-sm sm:text-base"
            >
              Voltar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
