{% load static %}

<!-- Screen 1: Service Landing / Address Capture -->
<div class="min-h-screen bg-white relative">
  <!-- Header -->
  <div class="flex items-center justify-between px-6 py-3 relative z-[1001]">
    <div class="flex items-center">
      <img src="{% static 'zela-logo.png' %}" alt="Zela" class="w-8 h-8 sm:w-10 sm:h-10" />
      <span class="ml-2 sm:ml-3 text-lg sm:text-xl font-bold" style="color: #011e41">Zela</span>
    </div>

    <div class="flex items-center space-x-4">
      {% if user.is_authenticated %}
      <div
        @click="window.location.href = '/dashboard/'"
        class="w-8 h-8 sm:w-10 sm:h-10 bg-[#015e73] rounded-full flex items-center justify-center text-white font-bold cursor-pointer hover:bg-[#014a5a] transition-colors overflow-hidden"
      >
        {% if user.profile.profile_picture %}
        <img
          src="{{ user.profile.profile_picture.url }}"
          alt="{{ user.get_full_name }}"
          class="w-full h-full object-cover"
        />
        {% else %} {{ user.first_name|first|upper }}{{
        user.last_name|first|upper }} {% endif %}
      </div>
      {% else %}
      <div
        @click="window.location.href = '/accounts/login/'"
        class="w-8 h-8 sm:w-10 sm:h-10 bg-gray-400 rounded-full flex items-center justify-center text-white font-bold cursor-pointer hover:bg-gray-500 transition-colors"
      >
        ?
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Main Content -->
  <div class="flex flex-col-reverse lg:flex-row">
    <!-- Map Container -->
    <div class="h-[50vh] lg:h-[calc(100vh-72px)] w-full lg:flex-1 relative">
      <!-- Leaflet Map Container -->
      <div
        id="booking-map"
        class="h-full w-full relative"
      >
        <!-- Address Form Card (Centered Version) -->
        <div
          x-show="!showAddressInColumn"
          class="absolute top-8 sm:top-16 left-1/2 transform -translate-x-1/2 w-11/12 sm:w-full max-w-sm sm:max-w-md mx-auto px-2 sm:px-4 z-[1000]"
        >
          <div class="bg-white rounded-2xl shadow-2xl p-3 sm:p-4 lg:p-8" @click.stop>
            <h2
              class="text-lg sm:text-xl lg:text-2xl font-bold text-center mb-3 sm:mb-4 lg:mb-6"
              style="color: #011e41"
            >
              Onde precisa de ajuda?
            </h2>

            <!-- Saved Addresses -->
            <div x-show="savedAddresses.length > 0" class="mb-6">
              <label
                class="block text-sm font-medium mb-2"
                style="color: #4a5a70"
              >
                Escolha entre os endere√ßos guardados
              </label>
              <div class="space-y-2 max-h-40 overflow-y-auto">
                <template x-for="address in savedAddresses" :key="address.id">
                  <div
                    @click="selectSavedAddress(address)"
                    class="p-3 border border-gray-200 rounded-lg hover:border-[#015e73] hover:bg-[#015e73]/5 cursor-pointer transition-colors"
                  >
                    <div class="flex items-center justify-between">
                      <div>
                        <div
                          class="font-medium text-sm"
                          x-text="address.name"
                        ></div>
                        <div
                          class="text-xs text-gray-600"
                          x-text="address.full_address"
                        ></div>
                      </div>
                      <div
                        x-show="address.is_main"
                        class="text-xs bg-[#015e73] text-white px-2 py-1 rounded"
                      >
                        Principal
                      </div>
                    </div>
                  </div>
                </template>
              </div>
              <div class="mt-3 text-center">
                <span class="text-sm text-gray-500">ou</span>
              </div>
            </div>

            <!-- Unit/Apartment Field -->
            <div class="mb-4">
              <label
                class="block text-sm font-medium mb-2"
                style="color: #4a5a70"
              >
                Unidade/N√∫mero e Nome do Apartamento (Opcional)
              </label>
              <div class="relative">
                <span
                  class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
                  >üè†</span
                >
                <input
                  type="text"
                  :value="window.bookingFlowComponent?.booking?.location?.unitName || ''"
                  @input="if(window.bookingFlowComponent?.booking?.location) window.bookingFlowComponent.booking.location.unitName = $event.target.value"
                  placeholder="Ex. 2a Apartamento Verde"
                  class="w-full pl-10 pr-4 py-2 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base"
                />
              </div>
            </div>

            <!-- Street Address Field -->
            <div class="mb-4">
              <label
                class="block text-sm font-medium mb-2"
                style="color: #4a5a70"
              >
                Endere√ßo da Rua
              </label>
              <div class="relative">
                <span
                  class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
                  >üìç</span
                >
                <input
                  type="text"
                  :value="window.bookingFlowComponent?.booking?.location?.streetAddress || ''"
                  @input="if(window.bookingFlowComponent?.booking?.location) window.bookingFlowComponent.booking.location.streetAddress = $event.target.value"
                  placeholder="Ex. Rua Major Kanhangulo, Luanda"
                  class="w-full pl-10 pr-12 py-2 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base"
                  @input="searchAddress($event.target.value)"
                  @keydown.enter.prevent="geocodeAndCenterMap($event.target.value)"
                />
                <button
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                  @click="if(window.bookingFlowComponent?.booking?.location) window.bookingFlowComponent.booking.location.streetAddress = ''"
                >
                  ‚úï
                </button>
              </div>
            </div>

            <!-- Search Results -->
            <div x-show="searchResults.length > 0" class="mb-4">
              <div
                class="max-h-40 overflow-y-auto border border-gray-200 rounded-lg"
              >
                <template
                  x-for="result in searchResults"
                  :key="result.place_id"
                >
                  <div
                    class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0"
                    @click="selectSearchResult(result)"
                  >
                    <div
                      class="font-medium text-sm"
                      x-text="result.display_name"
                    ></div>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>

        <!-- Continue Button (shows after address selection - only when address form is centered) -->
        <div
          x-show="(showContinueButton || (window.bookingFlowComponent?.booking?.location?.streetAddress && window.bookingFlowComponent?.booking?.location?.streetAddress !== '')) && !showAddressInColumn"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="transform translate-y-full opacity-0"
          x-transition:enter-end="transform translate-y-0 opacity-100"
          class="absolute bottom-4 sm:bottom-6 left-1/2 transform -translate-x-1/2 w-11/12 sm:w-full max-w-sm sm:max-w-md px-2 sm:px-4 z-[1000]"
        >
          <button
            @click="proceedFromAddress()"
            class="w-full min-h-[44px] py-2.5 sm:py-3 lg:py-4 px-3 sm:px-4 lg:px-6 bg-[#015e73] text-white font-semibold rounded-full hover:bg-[#014a5a] transition-colors duration-200 shadow-lg cursor-pointer text-sm sm:text-base"
          >
            Continuar com esta localiza√ß√£o
          </button>
        </div>
      </div>
    </div>

    <!-- Right Column Container -->
    <div
      x-show="showServiceModal || showAddressInColumn"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="transform translate-x-full"
      x-transition:enter-end="transform translate-x-0"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="transform translate-x-0"
      x-transition:leave-end="transform translate-x-full"
      class="fixed inset-0 lg:relative lg:inset-auto lg:w-96 bg-white lg:shadow-xl lg:border-t-0 lg:border-l lg:border-gray-200 flex flex-col h-full lg:h-[calc(100vh-72px)] z-[1002] lg:z-auto"
    >
      <!-- Address Form (Column Version) -->
      <div x-show="showAddressInColumn" class="flex-1 overflow-y-auto">
        <div class="p-4 sm:p-6 lg:p-8">
          <h2
            class="text-xl sm:text-2xl font-bold text-center mb-4 sm:mb-6"
            style="color: #011e41"
          >
            Where do you need help?
          </h2>

          <!-- Saved Addresses -->
          <div x-show="savedAddresses.length > 0" class="mb-6">
            <label
              class="block text-sm font-medium mb-2"
              style="color: #4a5a70"
            >
              Choose from saved addresses
            </label>
            <div class="space-y-2 max-h-40 overflow-y-auto">
              <template x-for="address in savedAddresses" :key="address.id">
                <div
                  @click="selectSavedAddress(address)"
                  class="p-3 border border-gray-200 rounded-lg hover:border-[#015e73] hover:bg-[#015e73]/5 cursor-pointer transition-colors"
                >
                  <div class="flex items-center justify-between">
                    <div>
                      <div
                        class="font-medium text-sm"
                        x-text="address.name"
                      ></div>
                      <div
                        class="text-xs text-gray-600"
                        x-text="address.full_address"
                      ></div>
                    </div>
                    <div
                      x-show="address.is_main"
                      class="text-xs bg-[#015e73] text-white px-2 py-1 rounded"
                    >
                      Main
                    </div>
                  </div>
                </div>
              </template>
            </div>
            <div class="mt-3 text-center">
              <span class="text-sm text-gray-500">or</span>
            </div>
          </div>

          <!-- Unit/Apartment Field -->
          <div class="mb-4">
            <label
              class="block text-sm font-medium mb-2"
              style="color: #4a5a70"
            >
              Unit/ Apartment No and Name (Optional)
            </label>
            <div class="relative">
              <span
                class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
                >üè†</span
              >
              <input
                type="text"
                x-model="booking.location.unitName"
                placeholder="Eg. 2a Apartamento Verde"
                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
          </div>

          <!-- Street Address Field -->
          <div class="mb-6">
            <label
              class="block text-sm font-medium mb-2"
              style="color: #4a5a70"
            >
              Street Address
            </label>
            <div class="relative">
              <span
                class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
                >üìç</span
              >
              <input
                type="text"
                x-model="booking.location.streetAddress"
                placeholder="Eg. Rua Major Kanhangulo, Luanda"
                class="w-full pl-10 pr-12 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                @input="searchAddress($event.target.value)"
                @keydown.enter.prevent="geocodeAndCenterMap($event.target.value)"
              />
              <button
                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                @click="booking.location.streetAddress = ''"
              >
                ‚úï
              </button>
            </div>
          </div>

          <!-- Search Results -->
          <div x-show="searchResults.length > 0" class="mb-4">
            <div
              class="max-h-40 overflow-y-auto border border-gray-200 rounded-lg"
            >
              <template x-for="result in searchResults" :key="result.place_id">
                <div
                  class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0"
                  @click="selectSearchResult(result)"
                >
                  <div
                    class="font-medium text-sm"
                    x-text="result.display_name"
                  ></div>
                </div>
              </template>
            </div>
          </div>

          <!-- Continue Button (Column Version) -->
          <div
            x-show="showContinueButton || (window.bookingFlowComponent?.booking?.location?.streetAddress && window.bookingFlowComponent?.booking?.location?.streetAddress !== '')"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            class="mt-6"
          >
            <button
              @click="proceedFromAddress()"
              class="w-full min-h-[44px] py-2.5 sm:py-3 lg:py-4 px-3 sm:px-4 lg:px-6 bg-[#015e73] text-white font-semibold rounded-full hover:bg-[#014a5a] transition-colors duration-200 shadow-lg cursor-pointer text-sm sm:text-base"
            >
              Continuar com esta localiza√ß√£o
            </button>
          </div>

          <!-- Debug info (remove after testing) -->
          <div x-show="false" class="mt-2 text-xs text-gray-500">
            Debug: showContinueButton =
            <span x-text="showContinueButton"></span>
          </div>
        </div>
      </div>

      <!-- Service Info Section -->
      <div
        x-show="showServiceModal && !serviceModalDismissed"
        class="flex flex-col h-full"
      >
        <!-- Service Info Header -->
        <div class="p-4 sm:p-6 lg:p-8 bg-gray-50 border-b border-gray-200">
          <div class="flex items-center justify-between mb-4 sm:mb-6">
            <div>
              <h3
                class="text-lg sm:text-xl lg:text-2xl font-bold"
                style="color: #011e41"
                x-text="window.bookingFlowComponent?.serviceConfig?.name || 'Servi√ßo'"
              ></h3>
            </div>
            <button
              @click="dismissServiceModal()"
              class="text-gray-400 hover:text-gray-600 text-2xl cursor-pointer hover:bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center transition-colors"
            >
              ‚úï
            </button>
          </div>
          <p
            class="text-gray-700 leading-relaxed text-sm sm:text-base lg:text-lg"
            x-text="window.bookingFlowComponent?.serviceConfig?.description || 'Obtenha 3,5 a 10 horas de limpeza completa e abrangente da sua casa.'"
          ></p>
        </div>

        <!-- How it works -->
        <div class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
          <h4 class="text-lg sm:text-xl lg:text-2xl font-bold mb-4 sm:mb-6 lg:mb-8" style="color: #011e41">
            Como funciona
          </h4>

          <div class="space-y-5">
            <div class="flex items-start">
              <span class="text-[#015e73] text-sm font-light mr-4 mt-0.5" style="min-width: 18px;">
                1.
              </span>
              <div class="flex-1">
                <p class="text-gray-700">
                  Diga-nos onde precisa de ajuda
                </p>
              </div>
            </div>

            <div class="flex items-start">
              <span class="text-[#015e73] text-sm font-light mr-4 mt-0.5" style="min-width: 18px;">
                2.
              </span>
              <div class="flex-1">
                <p class="text-gray-700">
                  Configure os requisitos da sua reserva
                </p>
              </div>
            </div>

            <div class="flex items-start">
              <span class="text-[#015e73] text-sm font-light mr-4 mt-0.5" style="min-width: 18px;">
                3.
              </span>
              <div class="flex-1">
                <p class="text-gray-700">
                  Escolha o seu trabalhador
                </p>
              </div>
            </div>

            <div class="flex items-start pt-3 mt-3 border-t border-gray-100">
              <span class="text-[#f4d35e] mr-4 mt-0.5" style="min-width: 18px;">
                ‚úì
              </span>
              <div class="flex-1">
                <p class="text-gray-800 font-medium">Conclu√≠do üéâ</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Got It Button -->
        <div class="p-4 sm:p-6 lg:p-8 border-t border-gray-200">
          <button
            @click="dismissServiceModal()"
            class="w-full min-h-[44px] py-3 px-4 sm:px-6 bg-[#015e73] text-white font-semibold rounded-full hover:bg-[#014a5a] transition-colors duration-200 cursor-pointer text-sm sm:text-base"
          >
            Entendi!
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
