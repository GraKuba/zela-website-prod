{% extends 'website/layouts/base.html' %} {% load static %} {% block title %}Book a Service - Zela{% endblock %} {% block content %}
<!-- Include the booking flow router -->
<script src="{% static 'js/booking-flow-router.js' %}"></script>

<div
  class="min-h-screen bg-gray-50"
  x-data="bookingFlow()"
  x-init="init()"
  x-cloak
  style="font-family: Arial, sans-serif"
>
  <!-- Loading state -->
  <div x-show="!isInitialized" class="min-h-screen flex items-center justify-center">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#015e73] mx-auto mb-4"></div>
      <p class="text-gray-600">A carregar...</p>
    </div>
  </div>
  
  <!-- Main Content Container -->
  <div id="booking-screen" class="min-h-screen" x-show="isInitialized" style="display: none;">
    <!-- Screen will be loaded dynamically after initialization -->
  </div>

  <!-- Overlay for matchmaking -->
  <div
    x-show="showMatchmakingOverlay"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 bg-green-600 z-50 flex items-center justify-center"
    style="display: none"
  >
    {% include "website/components/booking-flow/screens/screen-10-matchmaking.html" %}
  </div>

  <!-- Modal for heads-up -->
  <div
    x-show="showHeadsUpModal"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-0"
    x-transition:leave-end="opacity-100"
    class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center px-4"
    style="display: none"
  >
    {% include "website/components/booking-flow/screens/screen-11-heads-up-modal.html" %}
  </div>

  <!-- Worker Profile Modal -->
  {% include "website/components/booking-flow/screens/modal-worker-profile.html" %}

  <!-- Service Scope Modal -->
  {% include "website/components/booking-flow/screens/modal-service-scope.html" %}

  <!-- Hidden screen templates -->
  <template id="choose-worker-screen">
    {% include "website/components/booking-flow/screens/screen-choose-worker.html" %}
  </template>

  <template id="individual-worker-screen">
    {% include "website/components/booking-flow/screens/screen-individual-worker.html" %}
  </template>

  <template id="repeat-booking-screen">
    {% include "website/components/booking-flow/screens/screen-repeat-booking.html" %}
  </template>
</div>

<script>
  function bookingFlow() {
    return {
      // Initialization tracking
      isInitialized: false,
      apiCallsInProgress: new Set(),
      
      // Flow router
      flowRouter: null,
      serviceConfig: null,
      currentScreenName: "address",
      currentService: {
        pricing_model: "typology", // Default pricing model for indoor-cleaning
      },
      progressStep: 0, // 0 = no progress (screen 1), 1 = Details, 2 = Worker, 3 = Payment

      // Current screen state
      currentScreen: 1,
      showServiceModal: true,
      serviceModalDismissed: false,
      showMatchmakingOverlay: false,
      showHeadsUpModal: false,
      showContinueButton: false,
      showServiceScope: false,
      showAddressInColumn: false,

      // Map state
      map: null,
      mapMarker: null,
      searchResults: [],
      searchTimeout: null,
      availableWorkers: [],
      savedAddresses: [],

      // Pricing configuration
      pricingConfig: null,

      // Booking state
      booking: {
        serviceType: "indoor-cleaning",
        originalServiceType: "", // Store original URL service type for icon display
        propertyTypology: null, // 'T1', 'T2', 'T3', 'T4+'
        unitCount: 1, // For AC service
        acServiceNotes: "", // Notes for AC service
        location: {
          unitName: "",
          streetAddress: "",
          coordinates: null,
          fullAddress: "",
          area: "Luanda Centro", // Default area
        },
        frequency: null, // 'one-time' or 'repeat'
        dateBucket: null, // 'tomorrow' or 'later'
        date: null,
        timeWindow: "07:00 - 07:30",
        // Repeat booking specific fields
        repeat: {
          frequency: "weekly", // 'daily', 'weekly', 'bi-weekly', 'monthly'
          startDate: null,
          endDate: null,
          daysOfWeek: [], // For weekly/bi-weekly: ['monday', 'wednesday', 'friday']
          numberOfSessions: 4, // Default number of sessions
        },
        details: {
          homeSize: "medium-3-4-bedrooms",
          extraTasks: [],
          duration: 5.5,
          startTime: "07:00",
          notes: "",
        },
        tip: {
          amount: 0,
          selectedOption: null,
        },
        pricing: {
          bookingCost: 710,
          otherCosts: {
            bookingCover: 21,
            serviceFee: 39,
          },
          total: 770,
        },
        payment: {
          method: null,
          useSweepCred: false,
          cardId: null,
        },
        voucher: "",
        // Dog Trainer specific fields
        dogTrainerPackage: null, // 'basic', 'standard', 'premium'
        dogName: '',
        dogBreed: '',
        dogAge: '',
        dogSize: '',
        dogBehaviorNotes: '',
        selectedPackage: null,
        userPackages: [], // For existing dog training credits
        // Electrician specific fields
        electricianDescription: '',
        electricianHours: 2,
        electricianEmergency: false,
      },

      // Service data
      serviceInfo: {
        "indoor-cleaning": {
          name: "Limpeza Interior",
          description:
            "Obtenha 3,5 a 10 horas de limpeza completa e abrangente da sua casa.",
          icon: "üßπ",
          howItWorks: [
            "Diga-nos onde precisa de ajuda.",
            "Configure os requisitos da sua reserva.",
            "Escolha o seu trabalhador.",
            "Conclu√≠do!",
          ],
          included: {
            "SALA DE ESTAR": [
              "Tirar o p√≥ dos m√≥veis e superf√≠cies",
              "Passar pano e aspirar os pisos",
              "Tirar o p√≥ e limpar rodap√©s",
              "Tirar o p√≥ e limpar eletr√¥nicos, porta-retratos, etc.",
              "Tirar o p√≥ e limpar interruptores de luz e outros acess√≥rios",
            ],
            COZINHA: [
              "Limpar superf√≠cies, pias e eletrodom√©sticos",
              "Lavar lou√ßa",
              "Limpar parte externa de arm√°rios e geladeira",
              "Limpar paredes",
              "Esvaziar lixeiras e limpar √°rea do lixo",
              "Passar pano no ch√£o",
            ],
            QUARTOS: [
              "Tirar o p√≥ dos m√≥veis e superf√≠cies",
              "Arrumar a cama",
              "Aspirar e/ou passar pano no ch√£o",
              "Tirar o p√≥ e limpar rodap√©s",
              "Dobrar ou pendurar roupas no quarto",
            ],
            "CASAS DE BANHO": [
              "Limpeza do chuveiro, banheira e pias",
              "Limpeza da sanita",
              "Limpar bancadas e torneiras",
              "Limpar paredes e espelhos",
              "Limpar parte externa de arm√°rios e gaveteiros",
              "Dobrar ou pendurar toalhas limpas",
              "Esvaziar lixeiras e limpar √°rea do lixo",
              "Passar pano no ch√£o",
            ],
          },
        },
        "outdoor-services": {
          name: "Servi√ßos Exteriores",
          description:
            "Limpeza e manuten√ß√£o exterior profissional incluindo jardinagem, limpeza de piscinas e lavagem exterior.",
          icon: "üåø",
          howItWorks: [
            "Diga-nos onde precisa de ajuda.",
            "Configure os requisitos da sua reserva.",
            "Escolha o seu trabalhador.",
            "Conclu√≠do!",
          ],
        },
        "office-cleaning": {
          name: "Limpeza de Escrit√≥rios",
          description:
            "Mantenha o seu espa√ßo de trabalho impec√°vel com os nossos servi√ßos abrangentes de limpeza de escrit√≥rios.",
          icon: "üè¢",
          howItWorks: [
            "Diga-nos onde precisa de ajuda.",
            "Configure os requisitos da sua reserva.",
            "Escolha o seu trabalhador.",
            "Conclu√≠do!",
          ],
        },
        "moving-cleaning": {
          name: "Limpeza de Mudan√ßa",
          description:
            "Servi√ßos de limpeza profunda para mudan√ßas de entrada e sa√≠da para garantir que o seu espa√ßo esteja impec√°vel.",
          icon: "üì¶",
          howItWorks: [
            "Diga-nos onde precisa de ajuda.",
            "Configure os requisitos da sua reserva.",
            "Escolha o seu trabalhador.",
            "Conclu√≠do!",
          ],
        },
        "express-cleaning": {
          name: "Limpeza Express",
          description:
            "Servi√ßo de limpeza r√°pido e eficiente quando precisa com urg√™ncia - perfeito para necessidades de √∫ltima hora.",
          icon: "‚ö°",
          howItWorks: [
            "Diga-nos onde precisa de ajuda.",
            "Configure os requisitos da sua reserva.",
            "Escolha o seu trabalhador.",
            "Conclu√≠do!",
          ],
        },
        "laundry-ironing": {
          name: "Lavandaria e Engomadoria",
          description:
            "Servi√ßos profissionais de lavandaria e engomadoria para manter as suas roupas frescas e sem rugas.",
          icon: "üëî",
          howItWorks: [
            "Diga-nos onde precisa de ajuda.",
            "Configure os requisitos da sua reserva.",
            "Escolha o seu trabalhador.",
            "Conclu√≠do!",
          ],
        },
      },

      // Extra tasks options
      extraTasksOptions: [
        { id: "inside-fridge", label: "Interior do Frigor√≠fico", icon: "ü•∂" },
        { id: "inside-oven", label: "Interior do Forno", icon: "üî•" },
        { id: "inside-cabinets", label: "Interior dos Arm√°rios", icon: "üö™" },
        { id: "interior-windows", label: "Janelas Interiores", icon: "ü™ü" },
        { id: "interior-walls", label: "Paredes Interiores", icon: "üß±" },
        { id: "water-plants", label: "Regar Plantas", icon: "üå±" },
        { id: "ironing", label: "Passar a Ferro", icon: "üëî" },
        { id: "laundry", label: "Lavandaria", icon: "üëï" },
      ],

      // Home size options
      homeSizeOptions: [
        {
          id: "small-1-2-bedrooms",
          label: "Casa Pequena: 1-2 Quartos",
          duration: 3.5,
        },
        {
          id: "medium-3-4-bedrooms",
          label: "Casa M√©dia: 3-4 Quartos",
          duration: 5.5,
        },
        {
          id: "large-5-plus-bedrooms",
          label: "Casa Grande: 5+ Quartos",
          duration: 8,
        },
      ],

      // Time slots
      timeSlots: [
        "07:00 - 07:30",
        "07:30 - 08:00",
        "08:00 - 08:30",
        "08:30 - 09:00",
        "09:00 - 09:30",
        "09:30 - 10:00",
        "10:00 - 10:30",
        "10:30 - 11:00",
        "11:00 - 11:30",
        "11:30 - 12:00",
        "12:00 - 12:30",
        "12:30 - 13:00",
        "13:00 - 13:30",
        "13:30 - 14:00",
        "14:00 - 14:30",
        "14:30 - 15:00",
      ],

      async init() {
        // Prevent duplicate initialization
        if (this.isInitialized) {
          console.log('Already initialized, skipping...');
          return;
        }
        
        // Prevent duplicate API calls during initialization
        if (this.apiCallsInProgress.has('init')) {
          console.log('Initialization already in progress...');
          return;
        }
        
        this.apiCallsInProgress.add('init');
        
        try {
          // Initialize with service type from URL or default
          const urlServiceType = new URLSearchParams(window.location.search).get("service") || "indoor-cleaning";
          this.booking.serviceType = urlServiceType;
          this.booking.originalServiceType = urlServiceType; // Store original for icon display

          // Set default date to tomorrow
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          this.booking.date = tomorrow.toISOString().split("T")[0];

          // Set default repeat booking start date
          this.booking.repeat.startDate = tomorrow.toISOString().split("T")[0];

          // Load service configuration and initialize router
          await this.loadServiceConfiguration();

          // Load pricing configuration
          if (!this.apiCallsInProgress.has('pricing-config')) {
            this.apiCallsInProgress.add('pricing-config');
            try {
              const pricingResponse = await fetch("/api/pricing/config/");
              if (pricingResponse.ok) {
                const pricingResult = await pricingResponse.json();
                if (pricingResult.status === "success") {
                  this.pricingConfig = pricingResult.config;
                  console.log("Pricing config loaded:", this.pricingConfig);
                }
              }
            } catch (error) {
              console.error("Error loading pricing config:", error);
            } finally {
              this.apiCallsInProgress.delete('pricing-config');
            }
          }

          // Load saved booking data from session
          if (!this.apiCallsInProgress.has('booking-data')) {
            this.apiCallsInProgress.add('booking-data');
            try {
              const response = await fetch("/booking-flow/get-data/");
              if (response.ok) {
                const result = await response.json();
                if (result.data && Object.keys(result.data).length > 0) {
                  // Merge saved data with current booking data
                  Object.assign(this.booking, result.data);
                  console.log("Loaded saved booking data:", result.data);
                }
              }
            } catch (error) {
              console.error("Error loading booking data:", error);
            } finally {
              this.apiCallsInProgress.delete('booking-data');
            }
          }

          // Store reference to this component globally for access from dynamically loaded content
          window.bookingFlowComponent = this;

          // Load user's saved addresses
          await this.loadSavedAddresses();
          
          // Initialize the first screen after all data is loaded
          if (this.flowRouter) {
            const firstScreen = this.flowRouter.getCurrentScreen();
            await this.loadScreen(firstScreen);
          }

          console.log("Booking flow initialized:", this.booking);
          
          // Mark as initialized
          this.isInitialized = true;
          
        } catch (error) {
          console.error("Error during initialization:", error);
        } finally {
          this.apiCallsInProgress.delete('init');
        }
      },

      // Load service configuration from backend
      async loadServiceConfiguration() {
        try {
          // Get service configuration from backend
          const response = await fetch(
            `/api/booking/service-config/?service=${this.booking.serviceType}`
          );
          if (response.ok) {
            this.serviceConfig = await response.json();
            
            // Update both serviceType and originalServiceType to use the actual database slug
            if (this.serviceConfig.slug) {
              this.booking.serviceType = this.serviceConfig.slug;
              this.booking.originalServiceType = this.serviceConfig.slug;
            }

            // Initialize router with configuration
            this.flowRouter = new BookingFlowRouter(this.serviceConfig);

            // Set current screen to first in flow
            this.currentScreenName = this.flowRouter.getCurrentScreen();

            console.log("Service configuration loaded:", this.serviceConfig);
            console.log("Service type from URL:", this.booking.serviceType);
            console.log("Flow screens:", this.flowRouter.getAllScreens());
            console.log("Current screen name:", this.currentScreenName);
            console.log("Booking requirements:", this.serviceConfig.booking_requirements);
          } else {
            // Fallback to default configuration
            this.serviceConfig = {
              booking_requirements: {
                flow_type: "standard",
              },
            };
            this.flowRouter = new BookingFlowRouter(this.serviceConfig);
          }
        } catch (error) {
          console.error("Error loading service configuration:", error);
          // Fallback to default configuration
          this.serviceConfig = {
            booking_requirements: {
              flow_type: "standard",
            },
          };
          this.flowRouter = new BookingFlowRouter(this.serviceConfig);
        } finally {
          this.apiCallsInProgress.delete('service-config');
        }
      },

      // Load screen based on name
      async loadScreen(screenName) {
        const screenConfig = this.flowRouter.getScreenConfig(screenName);
        
        // Service-aware screen mapping
        const serviceType = this.booking.serviceType;
        let screenNumber = 1; // Default to address screen
        
        // Base screen mappings that work for all services
        const baseScreenMapping = {
          address: 1,
          property_typology: 2,
          schedule: 8, // Skip screen 7, go directly to booking details
          worker: "choose-worker",
          payment: 13,
          confirmation: 15,
        };
        
        // Service-specific screen mappings
        const serviceScreenMapping = {
          // Cleaning Services (from image)
          'indoor-cleaning': {
            duration_tasks: 8, // Booking details screen
          },
          'office-cleaning': {
            duration_tasks: 8, // Booking details screen
          },
          'outdoor-services': {
            garden_area: "generic-selection",
            service_type: "generic-selection",
          },
          'moving-cleaning': {
            duration_tasks: 8,
            move_type: "generic-selection",
          },
          'express-cleaning': {
            duration: "generic-duration", // 2-4 hours
          },
          'laundry-ironing': {
            items_weight: "generic-units",
            service_options: "generic-selection",
          },
          
          // Trade Services
          'electrician': {
            service_config: 4, // Electrician config screen
          },
          'ac-repair': {
            unit_count: 3, // AC units screen - correct for AC repair
          },
          'pest-control': {
            pest_config: 5, // Pest control config screen  
          },
          'dog-trainer': {
            package_selection: 6, // Dog trainer packages
          },
        };
        
        // Check if this is a base screen
        if (baseScreenMapping[screenName] !== undefined) {
          screenNumber = baseScreenMapping[screenName];
        }
        // Check service-specific mapping
        else if (serviceScreenMapping[serviceType] && serviceScreenMapping[serviceType][screenName] !== undefined) {
          screenNumber = serviceScreenMapping[serviceType][screenName];
        }
        // Handle component-based screens from config
        else if (screenConfig && screenConfig.component) {
          // Map component names to screen numbers/ids
          const componentMapping = {
            'screen-2-property-typology': 2,
            'screen-3-ac-units': 3,
            'screen-4-electrician-config': 4,
            'screen-5-pest-control-config': 5,
            'screen-6-dog-trainer-packages': 6,
            'screen-7-date-bucket': 7,
            'screen-8-booking-details': 8,
            'screen-generic-duration': "generic-duration",
            'screen-generic-units': "generic-units",
            'screen-generic-selection': "generic-selection",
          };
          screenNumber = componentMapping[screenConfig.component] || 1;
        }
        
        console.log(`Loading screen: ${screenName} -> ${screenNumber} for service: ${serviceType}`);
        
        // Update current screen name and calculate progress
        this.currentScreenName = screenName;
        this.calculateProgressStep();
        
        this.goToScreen(screenNumber);
      },

      // Navigate to next screen in flow
      async nextScreen() {
        console.log('Current screen:', this.currentScreenName);
        console.log('Service type:', this.booking.serviceType);
        console.log('Flow screens:', this.flowRouter.getAllScreens());
        console.log('Current index before:', this.flowRouter.currentIndex);
        
        const nextScreenName = this.flowRouter.getNextScreen(this.booking);
        console.log('Next screen name:', nextScreenName);
        console.log('Current index after:', this.flowRouter.currentIndex);
        
        if (nextScreenName) {
          this.currentScreenName = nextScreenName;
          this.calculateProgressStep();
          await this.loadScreen(nextScreenName);
        } else {
          // End of flow
          console.log("End of booking flow");
        }
      },

      // Navigate to previous screen in flow
      async previousScreen() {
        const prevScreenName = this.flowRouter.getPreviousScreen(this.booking);
        if (prevScreenName) {
          this.currentScreenName = prevScreenName;
          this.calculateProgressStep();
          await this.loadScreen(prevScreenName);
        }
      },

      // Get progress percentage
      getProgress() {
        return this.flowRouter ? this.flowRouter.getProgress() : 0;
      },

      // Calculate progress step based on current screen
      calculateProgressStep() {
        const screenName = this.currentScreenName;
        
        // Screen 1 (address) has no progress indicator
        if (screenName === 'address') {
          this.progressStep = 0;
          return;
        }
        
        // Details step screens - includes service configuration and scheduling
        const detailsScreens = [
          // Property and area selection
          'property_typology', 'garden_area',
          // Service-specific configuration  
          'service_type', 'move_type', 'service_options', 'service_config',
          'pest_config', 'package_selection',
          // Duration and quantity
          'duration_tasks', 'duration', 'items_weight', 'unit_count',
          // Scheduling
          'schedule', 'date_bucket', 'repeat_booking',
          // Generic screens
          'generic-duration', 'generic-units', 'generic-selection'
        ];
        
        // Worker step screens
        const workerScreens = [
          'worker',  // Main worker screen used by all services
          'worker_selection', 'choose_worker', 'individual_worker',
          'matchmaking'
        ];
        
        // Payment step screens
        const paymentScreens = [
          'payment',  // Main payment screen used by all services
          'payment_method', 'confirmation'
        ];
        
        if (detailsScreens.includes(screenName)) {
          this.progressStep = 1;
        } else if (workerScreens.includes(screenName)) {
          this.progressStep = 2;
        } else if (paymentScreens.includes(screenName)) {
          this.progressStep = 3;
        } else {
          // Default to details if unknown
          this.progressStep = 1;
        }
      },

      // Proceed from address capture
      async proceedFromAddress() {
        // Validate that we have an address
        if (!this.booking.location.streetAddress) {
          alert("Por favor, insira um endere√ßo");
          return;
        }

        // If we have an address but no coordinates, try to geocode it first
        if (
          !this.booking.location.coordinates ||
          !this.booking.location.coordinates.lat ||
          !this.booking.location.coordinates.lng
        ) {
          // Try to geocode the address
          try {
            await this.geocodeAndCenterMap(this.booking.location.streetAddress);

            // After geocoding, check again if we have coordinates
            if (
              this.booking.location.coordinates &&
              this.booking.location.coordinates.lat &&
              this.booking.location.coordinates.lng
            ) {
              // Save booking data and proceed to next screen
              this.saveBookingData();
              this.nextScreen();
            } else {
              alert(
                "N√£o foi poss√≠vel localizar o endere√ßo. Por favor, selecione um ponto no mapa."
              );
            }
          } catch (error) {
            console.error("Error geocoding:", error);
            alert(
              "Erro ao processar endere√ßo. Por favor, selecione um ponto no mapa."
            );
          }
          return;
        }

        // Save booking data and proceed to next screen
        this.saveBookingData();
        this.nextScreen();
      },

      // Navigation methods
      goToScreen(screenNumber) {
        this.currentScreen = screenNumber;

        // Map screen numbers to screen names for progress tracking
        const screenNumberToName = {
          1: 'address',
          2: 'property_typology', 
          3: 'ac_units',
          4: 'electrician_config',
          5: 'pest_control_config',
          6: 'dog_trainer_packages',
          7: 'duration_tasks', // Screen 7 now maps to booking details (was schedule)
          8: 'duration_tasks',
          9: 'worker',  // Worker selection screen
          13: 'payment',  // Payment screen
          15: 'confirmation',
          'choose-worker': 'worker',  // Choose worker maps to worker
          'individual-worker': 'worker',
          'repeat-booking': 'repeat_booking',
          'generic-duration': 'generic-duration',
          'generic-units': 'generic-units',
          'generic-selection': 'generic-selection'
        };

        // Update currentScreenName and calculate progress
        if (screenNumberToName[screenNumber]) {
          this.currentScreenName = screenNumberToName[screenNumber];
          this.calculateProgressStep();
        }

        // Handle generic screens
        if (screenNumber === "generic-duration") {
          this.loadGenericDurationScreen();
          return;
        }
        
        if (screenNumber === "generic-units") {
          this.loadGenericUnitsScreen();
          return;
        }
        
        if (screenNumber === "generic-selection") {
          this.loadGenericSelectionScreen();
          return;
        }

        // Handle special screens
        if (screenNumber === "choose-worker") {
          // Show choose worker screen
          const template = document.getElementById("choose-worker-screen");
          document.getElementById("booking-screen").innerHTML = template.content
            .cloneNode(true)
            .querySelector("div").outerHTML;
          return;
        }

        if (screenNumber === "individual-worker") {
          // Navigate to individual worker screen
          // Use HTMX if available, otherwise use direct replacement
          if (typeof htmx !== "undefined") {
            htmx.ajax("GET", `/booking-flow/screen/individual-worker/`, {
              target: "#booking-screen",
              swap: "innerHTML",
            });
          } else {
            // Fallback to direct replacement
            const template = document.getElementById(
              "individual-worker-screen"
            );
            document.getElementById("booking-screen").innerHTML =
              template.content.cloneNode(true).querySelector("div").outerHTML;
          }
          return;
        }

        if (screenNumber === "repeat-booking") {
          // Store the current context
          const currentContext = this;

          // Show repeat booking screen
          const bookingScreen = document.getElementById("booking-screen");
          const template = document.getElementById("repeat-booking-screen");
          const repeatBookingContent = template.content
            .cloneNode(true)
            .querySelector("div").outerHTML;

          // Replace content
          bookingScreen.innerHTML = repeatBookingContent;

          // Initialize repeat booking pricing
          this.calculateRepeatPricing();

          // Re-bind Alpine.js data to the new content by adding x-data attribute
          bookingScreen.setAttribute("x-data", "bookingFlow()");

          // Re-initialize Alpine.js for the new content
          setTimeout(() => {
            // Make sure the global component reference is available
            window.bookingFlowComponent = currentContext;

            // Initialize repeat booking displays
            initializeRepeatBookingDisplays();

            Alpine.initTree(bookingScreen);
          }, 50);

          return;
        }

        if (screenNumber === 15) {
          // Show confirmation screen
          const template = document.getElementById("confirmation-screen");
          document.getElementById("booking-screen").innerHTML = template.content
            .cloneNode(true)
            .querySelector("div").outerHTML;
          return;
        }

        // Store reference to this for use in callback
        const self = this;
        
        // Use HTMX to load the appropriate screen
        htmx.ajax("GET", `/booking-flow/screen/${screenNumber}/`, {
          target: "#booking-screen",
          swap: "innerHTML",
        }).then(() => {
          
          // After screen loads, check if it's the address screen (screen 1) and initialize map
          if (screenNumber === 1) {
            // Small delay to ensure DOM is fully ready
            setTimeout(() => {
              const mapContainer = document.getElementById("booking-map");
              if (mapContainer && !self.map) {
                console.log("Initializing map after screen load");
                self.initMap();
              }
            }, 100);
          }
        });
      },

      // Action methods
      dismissServiceModal() {
        this.showServiceModal = false;
        this.serviceModalDismissed = true;

        // Show the address form in the right column
        this.showAddressInColumn = true;

        // Fix map rendering issue by resizing the map after modal dismiss
        setTimeout(() => {
          if (this.map) {
            this.map.invalidateSize();
          }
        }, 350); // Wait for transition to complete
      },

      proceedToAddressConfirmation() {
        // Only proceed if we have a valid address and coordinates
        if (
          this.booking.location.streetAddress &&
          this.booking.location.coordinates
        ) {
          this.goToScreen(2);
        } else {
          alert("Por favor, selecione primeiro um endere√ßo no mapa");
        }
      },

      setLocation(address, coordinates) {
        this.booking.location.fullAddress = address;
        this.booking.location.coordinates = coordinates;
        // Use proper flow navigation instead of hardcoded screen
        this.nextScreen();
      },

      confirmLocation() {
        this.goToScreen(4);
      },

      selectFrequency(frequency) {
        this.booking.frequency = frequency;
        // Save state to session
        this.saveBookingData();
        // Don't navigate immediately - wait for date bucket selection
      },

      selectDateBucket(bucket) {
        this.booking.dateBucket = bucket;

        if (bucket === "tomorrow") {
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          this.booking.date = tomorrow.toISOString().split("T")[0];
          // Also update the time window to match the start time
          if (this.booking.details.startTime) {
            this.booking.timeWindow = `${
              this.booking.details.startTime
            } - ${this.addMinutesToTime(this.booking.details.startTime, 30)}`;
          }
        } else if (bucket === "later") {
          // Set date to a week from now as default for "later"
          const laterDate = new Date();
          laterDate.setDate(laterDate.getDate() + 7);
          this.booking.date = laterDate.toISOString().split("T")[0];
        }

        // Save state to session
        this.saveBookingData();

        // Navigate based on frequency - skip screen 7, go directly to screen 8
        if (this.booking.frequency === "one-time") {
          this.goToScreen(8); // Go to one-time booking details (was screen 8, now screen 7 is skipped)
        } else if (this.booking.frequency === "repeat") {
          this.goToScreen("repeat-booking"); // Go to repeat booking details
        }
      },

      addMinutesToTime(time, minutes) {
        const [hours, mins] = time.split(":").map(Number);
        const totalMins = hours * 60 + mins + minutes;
        const newHours = Math.floor(totalMins / 60);
        const newMins = totalMins % 60;
        return `${String(newHours).padStart(2, "0")}:${String(newMins).padStart(
          2,
          "0"
        )}`;
      },

      toggleExtraTask(taskId) {
        const index = this.booking.details.extraTasks.indexOf(taskId);
        if (index > -1) {
          this.booking.details.extraTasks.splice(index, 1);
        } else {
          this.booking.details.extraTasks.push(taskId);
        }
        this.calculatePricing();
        // Save state to session
        this.saveBookingData();
      },

      updateDuration(change) {
        this.booking.details.duration = Math.max(
          1,
          this.booking.details.duration + change
        );
        this.calculatePricing();
        // Save state to session
        this.saveBookingData();
      },

      // Update duration based on home size selection
      updateHomeSizeDuration() {
        const homeSizeOption = this.homeSizeOptions.find(
          (option) => option.id === this.booking.details.homeSize
        );
        if (homeSizeOption) {
          this.booking.details.duration = homeSizeOption.duration;
        }
        this.calculatePricing();
        // Save state to session
        this.saveBookingData();
      },

      async calculatePricing() {
        try {
          // Prepare data for API call
          const pricingData = {
            service_type: this.booking.serviceType,
            duration: this.booking.details.duration,
            home_size: this.booking.details.homeSize,
            extra_tasks: this.booking.details.extraTasks,
            location: {
              area: this.booking.location.area || "Luanda Centro",
              latitude: this.booking.location.coordinates?.lat,
              longitude: this.booking.location.coordinates?.lng,
            },
            date: this.booking.date,
            time: this.booking.details.startTime,
          };

          // Call pricing API
          const response = await fetch("/api/pricing/calculate/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(pricingData),
          });

          if (response.ok) {
            const result = await response.json();
            if (result.status === "success") {
              // Update pricing from API response
              this.booking.pricing.bookingCost = result.pricing.subtotal;
              this.booking.pricing.total = result.pricing.total;
              this.booking.pricing.breakdown = result.pricing.breakdown;

              // Update other costs
              this.booking.pricing.otherCosts.bookingCover =
                result.pricing.booking_fee;
              this.booking.pricing.otherCosts.serviceFee = 0; // Included in total

              console.log("Pricing updated:", result.pricing);
            }
          } else {
            // Fallback to local calculation if API fails
            this.calculatePricingFallback();
          }
        } catch (error) {
          console.error("Error calculating pricing:", error);
          // Fallback to local calculation
          this.calculatePricingFallback();
        }
      },

      calculatePricingFallback() {
        // Fallback pricing calculation (uses AOA rates)
        const baseRate = 4900; // AOA per hour (from PricingConfig)
        let baseCost = this.booking.details.duration * baseRate;

        // Adjust for home size
        const homeSize = this.booking.details.homeSize;
        let sizeMultiplier = 1;
        if (homeSize === "small-1-2-bedrooms") {
          sizeMultiplier = 0.8;
        } else if (homeSize === "large-5-plus-bedrooms") {
          sizeMultiplier = 1.3;
        }

        // Add extra tasks cost (3000 AOA per task)
        const extraTasksCost = this.booking.details.extraTasks.length * 3000;

        // Calculate final cost
        baseCost = baseCost * sizeMultiplier + extraTasksCost;

        this.booking.pricing.bookingCost = Math.round(baseCost);
        this.booking.pricing.otherCosts.bookingCover = 500; // Booking fee
        this.booking.pricing.otherCosts.serviceFee = 0;
        this.booking.pricing.total = this.booking.pricing.bookingCost + 500;
      },

      findWorker() {
        this.showMatchmakingOverlay = true;

        // Simulate search delay
        setTimeout(() => {
          this.showMatchmakingOverlay = false;
          this.goToChooseWorker();
        }, 3000);
      },

      goToChooseWorker() {
        // Navigate directly to choose worker screen
        this.goToScreen("choose-worker");
        // Load workers after navigation - increased timeout for DOM to be ready
        setTimeout(() => this.loadAvailableWorkers(), 300);
      },

      chooseWorker(workerId) {
        // Store selected worker
        this.booking.selectedWorker = workerId;
        // Save to session
        this.saveBookingData();
        // Navigate to payment screen directly (skip individual worker screen for now)
        this.goToScreen(13);
      },

      chooseForMe() {
        // Handle automatic worker selection
        // Mark as auto-selection
        this.booking.selectedWorker = "auto";
        this.saveBookingData();
        // Navigate to payment screen
        this.goToScreen(13);
      },

      closeHeadsUpModal() {
        this.showHeadsUpModal = false;
        this.goToScreen(12);
      },

      proceedToPayment() {
        this.goToScreen(13);
      },

      selectPaymentMethod(method) {
        this.booking.payment.method = method;
        this.saveBookingData();

        if (method === "credit-card") {
          // For now, simulate payment success and complete booking
          this.completeBooking();
        }
      },

      // Map methods
      initMap() {
        // Check if map container exists
        const mapContainer = document.getElementById("booking-map");
        if (!mapContainer) {
          console.log("Map container not found, skipping initialization");
          return;
        }
        
        // Clean up existing map if it exists
        if (this.map) {
          try {
            this.map.remove();
            this.map = null;
            this.mapMarker = null;
          } catch (e) {
            console.log("Error removing existing map:", e);
          }
        }
        
        try {
          // Initialize map centered on Luanda, Angola
          this.map = L.map("booking-map").setView([-8.8368, 13.2343], 12);

          // Add OpenStreetMap tiles
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "¬© OpenStreetMap contributors",
          }).addTo(this.map);

          // Add some sample markers for service areas
          this.addSampleMarkers();

          // Map clicking disabled - users must use address input
          console.log("Map initialized successfully");
        } catch (error) {
          console.error("Error initializing map:", error);
        }
      },

      addSampleMarkers() {
        // Add some sample service area markers in Luanda
        const serviceAreas = [
          { lat: -8.8368, lng: 13.2343, name: "Luanda Centro" },
          { lat: -8.8147, lng: 13.2302, name: "Ilha de Luanda" },
          { lat: -8.8547, lng: 13.2465, name: "Talatona" },
          { lat: -8.8892, lng: 13.2782, name: "Benfica" },
          { lat: -8.9083, lng: 13.3233, name: "Viana" },
        ];

        serviceAreas.forEach((area) => {
          const marker = L.circleMarker([area.lat, area.lng], {
            radius: 8,
            fillColor: "#10b981",
            color: "#059669",
            weight: 2,
            opacity: 0.8,
            fillOpacity: 0.6,
          }).addTo(this.map);

          marker.bindPopup(`<b>${area.name}</b><br>Service available`);
        });
      },

      searchAddress(query) {
        if (!query || query.length < 3) {
          this.searchResults = [];
          return;
        }

        // Clear previous timeout
        if (this.searchTimeout) {
          clearTimeout(this.searchTimeout);
        }

        // Debounce search
        this.searchTimeout = setTimeout(() => {
          this.performAddressSearch(query);
        }, 500);

        // Also attempt to geocode and center the map on manual entry
        if (query.length > 10) {
          this.searchTimeout = setTimeout(() => {
            this.geocodeAndCenterMap(query);
          }, 1000);
        }
      },

      async geocodeAndCenterMap(query) {
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
              query + ", Angola"
            )}&countrycodes=ao&limit=1`
          );

          if (response.ok) {
            const results = await response.json();
            if (results.length > 0) {
              const result = results[0];
              const latlng = L.latLng(
                parseFloat(result.lat),
                parseFloat(result.lon)
              );

              // Center map on the location with closer zoom
              this.map.setView(latlng, 18);

              // Place marker
              this.placeMarker(latlng);

              // Update location data
              this.booking.location.streetAddress =
                this.booking.location.streetAddress || query;
              this.booking.location.coordinates = {
                lat: parseFloat(result.lat),
                lng: parseFloat(result.lon),
              };
              this.booking.location.fullAddress = result.display_name;

              // Show continue button
              this.showContinueButton = true;
            }
          }
        } catch (error) {
          console.error("Error geocoding address:", error);
        }
      },

      async performAddressSearch(query) {
        try {
          // Add mock Angolan addresses for common searches
          const mockAddresses = [
            {
              display_name: "Rua Major Kanhangulo, Luanda, Angola",
              lat: "-8.8368",
              lon: "13.2343",
              place_id: "mock_1",
            },
            {
              display_name: "Avenida 4 de Fevereiro, Ilha de Luanda, Angola",
              lat: "-8.8147",
              lon: "13.2302",
              place_id: "mock_2",
            },
            {
              display_name: "Rua da Miss√£o, Talatona, Luanda, Angola",
              lat: "-8.8547",
              lon: "13.2465",
              place_id: "mock_3",
            },
            {
              display_name:
                "Avenida Pedro de Castro Van-D√∫nem Loy, Luanda, Angola",
              lat: "-8.8892",
              lon: "13.2782",
              place_id: "mock_4",
            },
            {
              display_name: "Estrada de Catete, Viana, Luanda, Angola",
              lat: "-8.9083",
              lon: "13.3233",
              place_id: "mock_5",
            },
          ];

          // Filter mock addresses based on query
          const filteredMockAddresses = mockAddresses.filter((addr) =>
            addr.display_name.toLowerCase().includes(query.toLowerCase())
          );

          // Use Nominatim API for geocoding (free OpenStreetMap service)
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
              query
            )}&countrycodes=ao&limit=3`
          );

          if (response.ok) {
            const apiResults = await response.json();
            // Combine mock results with API results
            this.searchResults = [
              ...filteredMockAddresses,
              ...apiResults,
            ].slice(0, 5);
          } else {
            // If API fails, use mock results only
            this.searchResults = filteredMockAddresses;
          }
        } catch (error) {
          console.error("Error searching address:", error);
          // Fallback to mock results
          const mockAddresses = [
            {
              display_name: "Rua Major Kanhangulo, Luanda, Angola",
              lat: "-8.8368",
              lon: "13.2343",
              place_id: "mock_1",
            },
            {
              display_name: "Avenida 4 de Fevereiro, Ilha de Luanda, Angola",
              lat: "-8.8147",
              lon: "13.2302",
              place_id: "mock_2",
            },
          ];
          this.searchResults = mockAddresses.filter((addr) =>
            addr.display_name.toLowerCase().includes(query.toLowerCase())
          );
        }
      },

      selectSearchResult(result) {
        // Update the booking location
        this.booking.location.streetAddress = result.display_name;
        this.booking.location.coordinates = {
          lat: parseFloat(result.lat),
          lng: parseFloat(result.lon),
        };

        // Clear search results
        this.searchResults = [];

        // Center map on selected location with closer zoom
        this.map.setView([result.lat, result.lon], 18);

        // Place marker
        this.placeMarker(L.latLng(result.lat, result.lon));

        // Show continue button instead of auto-navigating
        this.showContinueButton = true;
      },

      async placeMarker(latlng) {
        // Remove existing marker
        if (this.mapMarker) {
          this.map.removeLayer(this.mapMarker);
        }

        // Add new marker
        this.mapMarker = L.marker(latlng, {
          icon: L.icon({
            iconUrl:
              "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",
            shadowUrl:
              "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41],
          }),
        }).addTo(this.map);

        // Update booking coordinates
        this.booking.location.coordinates = {
          lat: latlng.lat,
          lng: latlng.lng,
        };

        // Perform reverse geocoding to get address
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}&zoom=18&addressdetails=1`
          );

          if (response.ok) {
            const data = await response.json();
            if (data.display_name) {
              // Extract street address from the response
              const address = data.address;
              let streetAddress = "";

              // Build street address from components
              if (address.house_number) {
                streetAddress += address.house_number + " ";
              }
              if (address.road || address.street) {
                streetAddress += (address.road || address.street) + ", ";
              }
              if (address.suburb || address.neighbourhood) {
                streetAddress +=
                  (address.suburb || address.neighbourhood) + ", ";
              }
              if (address.city || address.town) {
                streetAddress += (address.city || address.town) + ", ";
              }
              streetAddress += "Angola";

              this.booking.location.streetAddress = streetAddress.trim();
              this.booking.location.fullAddress = data.display_name;

              // Detect area from address components
              const area = this.detectServiceArea(address);
              this.booking.location.area = area;

              // Show popup with address
              this.mapMarker.bindPopup(`üìç ${streetAddress}`).openPopup();
            } else {
              // Fallback if no address found
              this.booking.location.streetAddress = `${latlng.lat.toFixed(
                4
              )}, ${latlng.lng.toFixed(4)}`;
              this.mapMarker.bindPopup("üìç Selected location").openPopup();
            }
          } else {
            // Fallback if API fails
            this.booking.location.streetAddress = `${latlng.lat.toFixed(
              4
            )}, ${latlng.lng.toFixed(4)}`;
            this.mapMarker.bindPopup("üìç Selected location").openPopup();
          }
        } catch (error) {
          console.error("Error getting address:", error);
          // Fallback if error occurs
          this.booking.location.streetAddress = `${latlng.lat.toFixed(
            4
          )}, ${latlng.lng.toFixed(4)}`;
          this.mapMarker.bindPopup("üìç Selected location").openPopup();
        }

        // Show continue button instead of auto-navigating
        this.showContinueButton = true;
      },

      // Save booking data to session
      async saveBookingData() {
        try {
          const response = await fetch("/booking-flow/save-data/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(this.booking),
          });

          if (response.ok) {
            const result = await response.json();
            console.log("Booking data saved:", result);
          }
        } catch (error) {
          console.error("Error saving booking data:", error);
        }
      },

      // Complete booking and create in database
      async completeBooking() {
        try {
          const response = await fetch("/booking-flow/payment/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(this.booking),
          });

          if (response.ok) {
            const result = await response.json();
            console.log("Booking created:", result);

            // Store success message in sessionStorage for dashboard
            sessionStorage.setItem("bookingSuccess", "true");
            sessionStorage.setItem("navigateToTab", "bookings");

            // Redirect to dashboard
            window.location.href = "/dashboard/";
          } else {
            const error = await response.json();
            alert("Error creating booking: " + error.message);
          }
        } catch (error) {
          console.error("Error completing booking:", error);
          alert("Error creating booking. Please try again.");
        }
      },

      // Helper methods
      formatCurrency(amount) {
        return `AOA ${amount.toLocaleString("pt-AO")}`;
      },

      getHomeSizeLabel(sizeId) {
        const option = this.homeSizeOptions.find((opt) => opt.id === sizeId);
        return option ? option.label : sizeId;
      },

      getExtraTaskLabel(taskId) {
        const task = this.extraTasksOptions.find((opt) => opt.id === taskId);
        return task ? task.label : taskId;
      },

      detectServiceArea(addressComponents) {
        // Map of neighborhoods/suburbs to service areas
        const areaMapping = {
          Ingombota: "Ingombota",
          Maianga: "Maianga",
          Maculusso: "Luanda Centro",
          Kinaxixi: "Luanda Centro",
          "Ilha de Luanda": "Luanda Centro",
          "Ilha do Cabo": "Luanda Centro",
          Rangel: "Rangel",
          Cazenga: "Cazenga",
          Viana: "Viana",
          Talatona: "Rangel",
          Benfica: "Rangel",
          Camama: "Viana",
          Zango: "Viana",
        };

        // Check suburb/neighbourhood first
        const suburb =
          addressComponents.suburb || addressComponents.neighbourhood;
        if (suburb) {
          for (const [key, value] of Object.entries(areaMapping)) {
            if (suburb.toLowerCase().includes(key.toLowerCase())) {
              return value;
            }
          }
        }

        // Check city_district
        const district = addressComponents.city_district;
        if (district) {
          for (const [key, value] of Object.entries(areaMapping)) {
            if (district.toLowerCase().includes(key.toLowerCase())) {
              return value;
            }
          }
        }

        // Default to Luanda Centro if we can't determine
        return "Luanda Centro";
      },

      // Tip handling methods
      selectTip(tipOption, amount = null) {
        this.booking.tip.selectedOption = tipOption;

        if (tipOption === "custom" && amount !== null) {
          this.booking.tip.amount = amount;
        } else if (tipOption !== "custom") {
          // Set predefined tip amounts
          const tipAmounts = {
            "no-tip": 0,
            small: 25,
            medium: 50,
            large: 75,
            generous: 100,
          };
          this.booking.tip.amount = tipAmounts[tipOption] || 0;
        }

        this.calculatePricing();
        this.saveBookingData();
      },

      updateCustomTip(amount) {
        this.booking.tip.amount = Math.max(0, parseInt(amount) || 0);
        this.calculatePricing();
      },

      // Load available workers from API
      async loadAvailableWorkers() {
        try {
          const response = await fetch("/booking-flow/workers/");
          if (response.ok) {
            const data = await response.json();
            if (data.status === "success") {
              this.availableWorkers = data.workers;
              // Store workers globally for modal access
              window.availableWorkersData = {};
              data.workers.forEach((worker) => {
                window.availableWorkersData[worker.id] = worker;
              });
              this.displayWorkers();
            }
          }
        } catch (error) {
          console.error("Error loading workers:", error);
        }
      },

      displayWorkers() {
        // Wait a bit for DOM to be ready
        setTimeout(() => {
          // Be very specific - find the main booking screen
          const bookingScreen = document.querySelector("#booking-screen");
          if (!bookingScreen) {
            console.error("Booking screen not found");
            return;
          }

          // Try multiple strategies to find the worker container
          let targetContainer = null;

          // Strategy 1: Look for h2 with "Escolha o seu trabalhador"
          const h2Element = Array.from(
            bookingScreen.querySelectorAll("h2")
          ).find((h2) => h2.textContent?.includes("Escolha o seu trabalhador"));

          if (h2Element) {
            // Find the nearest .space-y-6 container after the h2
            let sibling = h2Element.nextElementSibling;
            while (sibling) {
              if (sibling.classList.contains("space-y-6")) {
                targetContainer = sibling;
                break;
              }
              // Check children of sibling
              const childContainer = sibling.querySelector(".space-y-6");
              if (childContainer) {
                targetContainer = childContainer;
                break;
              }
              sibling = sibling.nextElementSibling;
            }
          }

          // Strategy 2: If not found, look for any empty .space-y-6 container
          if (!targetContainer) {
            const containers = bookingScreen.querySelectorAll(".space-y-6");
            targetContainer = Array.from(containers).find(
              (container) =>
                container.innerHTML.includes(
                  "A carregar trabalhadores dispon√≠veis"
                ) ||
                container.children.length === 0 ||
                (container.children.length === 1 &&
                  container.querySelector(".text-center"))
            );
          }

          if (!targetContainer) {
            console.error(
              "Could not find worker container after trying multiple strategies"
            );
            return;
          }

          // Clear existing content
          targetContainer.innerHTML = "";

          if (this.availableWorkers.length === 0) {
            targetContainer.innerHTML = `
              <div class="text-center py-8 text-gray-500">
                <p>Nenhum trabalhador dispon√≠vel neste momento.</p>
              </div>
            `;
            return;
          }

          // Create worker cards
          this.availableWorkers.forEach((worker) => {
            const workerCard = this.createWorkerCard(worker);
            targetContainer.appendChild(workerCard);
          });
        }, 200);
      },

      createWorkerCard(worker) {
        const div = document.createElement("div");
        div.className =
          "bg-white border border-gray-200 rounded-2xl p-6 hover:shadow-lg transition-shadow";

        // Get the static URL for the generic avatar
        const genericAvatarUrl =
          document.querySelector('[src*="generic-avatar"]')?.src ||
          "/static/generic-avatar.png";

        div.innerHTML = `
          <div class="flex items-start space-x-6">
            <!-- Profile Picture - Larger square with rounded edges -->
            <div class="w-32 h-32 bg-gray-200 rounded-2xl flex-shrink-0 overflow-hidden shadow-md">
              <img
                src="${worker.avatar || genericAvatarUrl}"
                alt="${worker.name}"
                class="w-full h-full object-cover"
                onerror="this.src='${genericAvatarUrl}'"
              />
            </div>

            <!-- Worker Details -->
            <div class="flex-1">
              <h3 class="text-xl font-bold mb-2" style="color: #011e41">
                ${worker.name}
              </h3>
              <div class="flex items-center mb-2">
                <svg
                  class="w-5 h-5 text-[#f4d35e] mr-1"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M12 17.27L18.18 21L16.54 13.97L22 9.24L14.81 8.63L12 2L9.19 8.63L2 9.24L7.46 13.97L5.82 21L12 17.27Z"
                  />
                </svg>
                <span class="text-sm font-semibold" style="color: #015e73">
                  ${worker.rating ? worker.rating.toFixed(1) : "5.0"}
                </span>
                <span class="text-sm text-gray-500 ml-1">
                  (${worker.rating_count || 0} avalia√ß√µes)
                </span>
              </div>
              <div class="text-sm font-medium text-gray-700 mb-1">
                <span class="text-[#015e73] font-bold">${
                  worker.recommend_rate
                }%</span> Recomendam
              </div>
              <div class="text-sm text-gray-600 mb-4">
                <span class="font-bold">${
                  worker.jobs_completed
                }</span> Trabalhos Conclu√≠dos
              </div>

              <!-- Bio snippet if available -->
              ${
                worker.bio
                  ? `
                <div class="text-xs text-gray-500 mb-3 line-clamp-2">
                  "${worker.bio}"
                </div>
              `
                  : ""
              }

              <!-- Action Buttons -->
              <div class="flex space-x-3">
                <button
                  @click="viewWorkerProfile(${worker.id})"
                  class="flex-1 bg-white border border-[#015e73] text-[#015e73] font-medium py-2 px-4 rounded-xl hover:bg-[#015e73]/5 transition-colors cursor-pointer"
                >
                  Ver perfil
                </button>
                <button
                  @click="chooseWorker(${worker.id})"
                  class="flex-1 bg-[#015e73] text-white font-medium py-2 px-4 rounded-xl hover:bg-[#014a5a] transition-colors cursor-pointer"
                >
                  Escolher-me
                </button>
              </div>
            </div>
          </div>
        `;
        return div;
      },

      // Load saved addresses from user's address book
      async loadSavedAddresses() {
        // Prevent duplicate calls
        if (this.apiCallsInProgress.has('addresses')) {
          return;
        }
        
        this.apiCallsInProgress.add('addresses');
        
        try {
          const response = await fetch("/booking-flow/addresses/");
          if (response.ok) {
            const data = await response.json();
            if (data.status === "success") {
              this.savedAddresses = data.addresses;
            }
          }
        } catch (error) {
          console.error("Error loading saved addresses:", error);
        } finally {
          this.apiCallsInProgress.delete('addresses');
        }
      },

      // Select a saved address
      async selectSavedAddress(address) {
        console.log("Selecting saved address:", address);

        // Update booking location with saved address
        this.booking.location.unitName = address.address_line_2 || "";
        this.booking.location.streetAddress =
          address.full_address || address.address_line_1 || "Principal";
        this.booking.location.fullAddress =
          address.full_address || address.address_line_1 || "Principal";

        // Clear search results immediately
        this.searchResults = [];

        // Set coordinates if available
        if (address.latitude && address.longitude) {
          this.booking.location.coordinates = {
            lat: parseFloat(address.latitude),
            lng: parseFloat(address.longitude),
          };

          // Center map on the saved address if map is ready
          if (this.map) {
            try {
              const latlng = L.latLng(address.latitude, address.longitude);
              this.map.setView(latlng, 18);
              this.placeMarker(latlng);
            } catch (error) {
              console.error("Error setting map view:", error);
            }
          }
        } else {
          // If no coordinates, geocode the address or use defaults
          // For "Principal" or addresses without coordinates, use a default Luanda location
          if (
            address.name === "Principal" ||
            address.full_address === "Principal" ||
            !address.full_address
          ) {
            // Set default coordinates for Luanda center
            this.booking.location.coordinates = {
              lat: -8.8368,
              lng: 13.2343,
            };
            if (this.map) {
              try {
                const latlng = L.latLng(-8.8368, 13.2343);
                this.map.setView(latlng, 16);
                this.placeMarker(latlng);
              } catch (error) {
                console.error("Error setting default map view:", error);
              }
            }
          } else {
            // Try to geocode the address
            const geocoded = await this.geocodeAndCenterMap(
              address.full_address
            );
            if (!geocoded) {
              // If geocoding fails, use default coordinates
              this.booking.location.coordinates = {
                lat: -8.8368,
                lng: 13.2343,
              };
            }
          }
        }

        // Always show continue button after selecting a saved address
        this.showContinueButton = true;
        console.log(
          "Continue button should now be visible:",
          this.showContinueButton
        );
        console.log("ShowAddressInColumn:", this.showAddressInColumn);
        console.log("Booking location:", this.booking.location);

        // Force Alpine to update the UI
        this.$nextTick(() => {
          this.showContinueButton = true;
          // Also ensure the global reference is updated
          if (window.bookingFlowComponent) {
            window.bookingFlowComponent.showContinueButton = true;
          }
        });
      },

      // Property typology selection
      selectPropertyTypology(typology) {
        this.booking.propertyTypology = typology;
        // Save state to session
        this.saveBookingData();
      },

      // Proceed from property typology screen
      proceedFromPropertyTypology() {
        if (!this.booking.propertyTypology) {
          alert("Por favor, selecione o tamanho da sua propriedade");
          return;
        }
        // Navigate to next screen in the flow
        if (this.flowRouter) {
          const nextScreen = this.flowRouter.getNextScreen(this.booking);
          if (nextScreen) {
            // Skip screen 7 (date-bucket), go directly to screen 8 (booking details)
            if (nextScreen === "schedule" || nextScreen === "date_bucket") {
              this.goToScreen(8); // Skip to booking details
            } else {
              // Use the loadScreen method which handles service-specific mapping
              this.currentScreenName = nextScreen;
              this.loadScreen(nextScreen);
            }
          } else {
            // End of flow or error
            console.error('No next screen found in flow');
          }
        } else {
          this.goToScreen(8); // Skip screen 7, go directly to booking details
        }
      },

      // Get price for typology
      getPriceForTypology(typology) {
        // Base pricing per typology
        const typologyPricing = {
          T1: 15000,
          T2: 20000,
          T3: 25000,
          "T4+": 35000,
        };

        return typologyPricing[typology] || 15000;
      },

      // Load generic duration screen
      loadGenericDurationScreen() {
        const screenConfig = this.flowRouter.getScreenConfig(this.currentScreenName);
        const serviceType = this.booking.serviceType;
        
        // Configure duration based on service
        let durationConfig = {
          title: "Quanto tempo precisa?",
          description: "Selecione a dura√ß√£o do servi√ßo",
          minDuration: 2,
          maxDuration: 12,
          defaultDuration: 4,
          step: 0.5,
          hourlyRate: 8000,
        };
        
        // Service-specific configurations
        if (serviceType === 'express-cleaning') {
          durationConfig = {
            ...durationConfig,
            title: "Dura√ß√£o da Limpeza Express",
            description: "Servi√ßo r√°pido entre 2-4 horas",
            minDuration: 2,
            maxDuration: 4,
            defaultDuration: 3,
          };
        }
        
        // Load generic duration screen
        htmx.ajax("GET", `/booking-flow/screen/generic-duration/?config=${encodeURIComponent(JSON.stringify(durationConfig))}`, {
          target: "#booking-screen",
          swap: "innerHTML",
        });
      },

      // Load generic units screen
      loadGenericUnitsScreen() {
        const screenConfig = this.flowRouter.getScreenConfig(this.currentScreenName);
        const serviceType = this.booking.serviceType;
        
        let unitsConfig = {
          title: "Quantas unidades?",
          description: "Selecione o n√∫mero de unidades",
          unitLabel: "Unidades",
          minUnits: 1,
          maxUnits: 10,
          defaultUnits: 1,
        };
        
        // Service-specific configurations
        if (serviceType === 'laundry-ironing') {
          unitsConfig = {
            ...unitsConfig,
            title: "Quantidade de Roupa",
            description: "Selecione o peso ou n√∫mero de pe√ßas",
            unitLabel: "Kg de roupa",
            maxUnits: 50,
            defaultUnits: 10,
            showAlternativeOption: true,
            alternativeLabel: "Ou n√∫mero de pe√ßas",
          };
        }
        
        // Load generic units screen
        htmx.ajax("GET", `/booking-flow/screen/generic-units/?config=${encodeURIComponent(JSON.stringify(unitsConfig))}`, {
          target: "#booking-screen",
          swap: "innerHTML",
        });
      },

      // Load generic selection screen  
      loadGenericSelectionScreen() {
        const screenConfig = this.flowRouter.getScreenConfig(this.currentScreenName);
        const serviceType = this.booking.serviceType;
        const currentScreenName = this.currentScreenName;
        
        let selectionConfig = {
          title: "Selecione uma op√ß√£o",
          description: "Escolha a op√ß√£o desejada",
          options: [],
          multiSelect: false,
        };
        
        // Configure based on service and screen
        if (serviceType === 'outdoor-services') {
          if (currentScreenName === 'garden_area') {
            selectionConfig = {
              title: "√Årea do Jardim",
              description: "Qual √© o tamanho da √°rea exterior?",
              options: [
                { id: "small", label: "Pequeno (at√© 50m¬≤)", price: 15000 },
                { id: "medium", label: "M√©dio (50-150m¬≤)", price: 25000 },
                { id: "large", label: "Grande (150-300m¬≤)", price: 35000 },
                { id: "xlarge", label: "Muito Grande (300m¬≤+)", price: 50000 },
              ],
            };
          } else if (currentScreenName === 'service_type') {
            selectionConfig = {
              title: "Tipo de Servi√ßo",
              description: "Que servi√ßo exterior precisa?",
              options: [
                { id: "lawn", label: "Corte de Relva" },
                { id: "hedge", label: "Poda de Sebes" },
                { id: "pressure", label: "Lavagem com Press√£o" },
                { id: "pool", label: "Limpeza de Piscina" },
                { id: "general", label: "Manuten√ß√£o Geral" },
              ],
              multiSelect: true,
            };
          }
        } else if (serviceType === 'moving-cleaning' && currentScreenName === 'move_type') {
          selectionConfig = {
            title: "Tipo de Mudan√ßa",
            description: "√â mudan√ßa de entrada ou sa√≠da?",
            options: [
              { id: "move-in", label: "Mudan√ßa de Entrada", description: "Limpeza antes de se mudar" },
              { id: "move-out", label: "Mudan√ßa de Sa√≠da", description: "Limpeza ap√≥s sair" },
              { id: "both", label: "Ambos", description: "Limpeza completa de entrada e sa√≠da" },
            ],
          };
        } else if (serviceType === 'laundry-ironing' && currentScreenName === 'service_options') {
          selectionConfig = {
            title: "Op√ß√µes de Servi√ßo",
            description: "Que servi√ßos adicionais deseja?",
            options: [
              { id: "wash-only", label: "Apenas Lavar" },
              { id: "wash-iron", label: "Lavar e Engomar" },
              { id: "iron-only", label: "Apenas Engomar" },
              { id: "dry-clean", label: "Limpeza a Seco" },
              { id: "express", label: "Servi√ßo Express (+50%)", priceModifier: 1.5 },
            ],
          };
        }
        
        // Load generic selection screen
        htmx.ajax("GET", `/booking-flow/screen/generic-selection/?config=${encodeURIComponent(JSON.stringify(selectionConfig))}`, {
          target: "#booking-screen",
          swap: "innerHTML",
        });
      },

      // Format currency
      formatCurrency(amount) {
        return new Intl.NumberFormat("pt-AO", {
          style: "currency",
          currency: "AOA",
        }).format(amount);
      },

      // AC Service Methods
      incrementUnitCount() {
        if (!this.booking.unitCount) this.booking.unitCount = 1;
        this.booking.unitCount++;
        this.saveBookingData();
      },

      decrementUnitCount() {
        if (!this.booking.unitCount) this.booking.unitCount = 1;
        if (this.booking.unitCount > 1) {
          this.booking.unitCount--;
          this.saveBookingData();
        }
      },

      getACDiscount() {
        const count = this.booking.unitCount || 1;
        if (count === 1) return 0;
        if (count >= 2 && count <= 3) return 10;
        if (count >= 4 && count <= 5) return 15;
        if (count >= 6) return 20;
        return 0;
      },

      getACDiscountAmount() {
        const basePrice = 16000;
        const count = this.booking.unitCount || 1;
        const discount = this.getACDiscount();
        return (basePrice * count * discount) / 100;
      },

      getACTotalPrice() {
        const basePrice = 16000;
        const count = this.booking.unitCount || 1;
        const totalBeforeDiscount = basePrice * count;
        const discountAmount = this.getACDiscountAmount();
        return totalBeforeDiscount - discountAmount;
      },

      proceedFromACConfiguration() {
        // Save AC configuration
        this.saveBookingData();

        // Navigate to next screen in the flow
        if (this.flowRouter) {
          const nextScreen = this.flowRouter.getNextScreen(this.booking);
          if (nextScreen === "schedule") {
            this.goToScreen(8); // Skip screen 7, go directly to booking details
          } else {
            this.goToScreen(8); // Always skip to booking details (screen 8)
          }
        } else {
          this.goToScreen(8); // Skip screen 7, go directly to booking details
        }
      },

      // Repeat booking methods
      setRepeatFrequency(frequency) {
        this.booking.repeat.frequency = frequency;
        // Reset days of week when changing frequency
        this.booking.repeat.daysOfWeek = [];
        this.calculateRepeatPricing();
      },

      toggleDayOfWeek(day) {
        const index = this.booking.repeat.daysOfWeek.indexOf(day);
        if (index > -1) {
          this.booking.repeat.daysOfWeek.splice(index, 1);
        } else {
          this.booking.repeat.daysOfWeek.push(day);
        }
        this.calculateRepeatPricing();
      },

      updateNumberOfSessions(sessions) {
        this.booking.repeat.numberOfSessions = Math.max(
          1,
          Math.min(52, sessions)
        );
        this.calculateRepeatPricing();
      },

      calculateRepeatPricing() {
        // Calculate base cost for one session
        const baseRate = 129; // per hour
        let baseCost = this.booking.details.duration * baseRate;

        // Adjust for home size
        const homeSize = this.booking.details.homeSize;
        let sizeMultiplier = 1;
        if (homeSize === "small-1-2-bedrooms") {
          sizeMultiplier = 0.8;
        } else if (homeSize === "large-5-plus-bedrooms") {
          sizeMultiplier = 1.2;
        }

        // Add extra tasks cost
        const extraTasksCost = this.booking.details.extraTasks.length * 25;

        // Calculate cost per session
        const costPerSession = baseCost * sizeMultiplier + extraTasksCost;

        // Apply repeat booking discount
        let discountMultiplier = 1;
        if (this.booking.repeat.numberOfSessions >= 4) {
          discountMultiplier = 0.85; // 15% discount for 4+ sessions
        }
        if (this.booking.repeat.numberOfSessions >= 8) {
          discountMultiplier = 0.75; // 25% discount for 8+ sessions
        }

        const discountedCostPerSession = costPerSession * discountMultiplier;
        const totalCost =
          discountedCostPerSession * this.booking.repeat.numberOfSessions;

        this.booking.pricing.bookingCost = Math.round(totalCost);
        this.booking.pricing.total =
          this.booking.pricing.bookingCost +
          this.booking.pricing.otherCosts.bookingCover +
          this.booking.pricing.otherCosts.serviceFee;
      },

      // Dog Trainer methods
      selectDogTrainerPackage(packageType) {
        this.booking.dogTrainerPackage = packageType;
        
        // Set package details
        const packages = {
          'basic': {
            sessions: 4,
            price: 32000,
            duration: 45
          },
          'standard': {
            sessions: 8,
            price: 61200,
            duration: 60
          },
          'premium': {
            sessions: 12,
            price: 90000,
            duration: 90
          }
        };
        
        this.booking.selectedPackage = packages[packageType];
        this.saveBookingData();
      },
      
      useExistingCredits() {
        this.booking.payment.useCredits = true;
        // Navigate to worker selection
        this.goToScreen(9);
      },
      
      proceedFromDogTrainerPackages() {
        if (!this.booking.dogTrainerPackage || !this.booking.dogName || 
            !this.booking.dogBreed || !this.booking.dogAge || !this.booking.dogSize) {
          alert("Por favor, preencha todos os campos obrigat√≥rios");
          return;
        }
        this.goToScreen(9); // Go to worker selection
      },

      // Electrician methods
      getElectricianMinimumHours() {
        const minimums = {
          'T1': 2,
          'T2': 2,
          'T3': 3,
          'T4+': 4
        };
        return minimums[this.booking.propertyTypology] || 2;
      },
      
      getElectricianHourlyRate() {
        const rates = {
          'T1': 5000,
          'T2': 5000,
          'T3': 5500,
          'T4+': 6000
        };
        return rates[this.booking.propertyTypology] || 5000;
      },
      
      incrementElectricianHours() {
        this.booking.electricianHours++;
        this.saveBookingData();
      },
      
      decrementElectricianHours() {
        const minimum = this.getElectricianMinimumHours();
        if (this.booking.electricianHours > minimum) {
          this.booking.electricianHours--;
          this.saveBookingData();
        }
      },
      
      getElectricianTotalPrice() {
        const hours = this.booking.electricianHours || this.getElectricianMinimumHours();
        const rate = this.getElectricianHourlyRate();
        return hours * rate;
      },
      
      getElectricianFinalPrice() {
        let price = this.getElectricianTotalPrice();
        if (this.booking.electricianEmergency) {
          price *= 1.5; // 50% emergency surcharge
        }
        return price;
      },
      
      proceedFromElectricianConfig() {
        if (!this.booking.electricianDescription) {
          alert("Por favor, descreva o trabalho necess√°rio");
          return;
        }
        // Ensure electricianHours is set to at least the minimum
        if (!this.booking.electricianHours || this.booking.electricianHours < this.getElectricianMinimumHours()) {
          this.booking.electricianHours = this.getElectricianMinimumHours();
        }
        this.saveBookingData();
        this.goToScreen(8); // Skip screen 7, go directly to booking details
      },
    };
  }

  // Global functions accessible from included screens
  function chooseWorker(workerId) {
    const bookingData = Alpine.store("booking");
    if (bookingData && bookingData.chooseWorker) {
      bookingData.chooseWorker(workerId);
    } else {
      // Fallback: find the Alpine component and call the method
      const component = Alpine.findClosest(document.body, "[x-data]");
      if (
        component &&
        component._x_dataStack &&
        component._x_dataStack[0].chooseWorker
      ) {
        component._x_dataStack[0].chooseWorker(workerId);
      }
    }
  }

  function chooseForMe() {
    const component = Alpine.findClosest(document.body, "[x-data]");
    if (
      component &&
      component._x_dataStack &&
      component._x_dataStack[0].chooseForMe
    ) {
      component._x_dataStack[0].chooseForMe();
    }
  }

  function viewWorkerProfile(workerId) {
    window.dispatchEvent(
      new CustomEvent("open-worker-profile", {
        detail: { workerId: workerId },
      })
    );
  }

  function proceedToPayment() {
    // Primary method: use global window reference
    if (window.bookingFlowComponent && window.bookingFlowComponent.goToScreen) {
      window.bookingFlowComponent.goToScreen(13);
      return;
    }

    // Fallback: try multiple approaches to find the Alpine component
    let component = document.querySelector("[x-data]");

    // If we have the component, try to access its Alpine data
    if (component && component._x_dataStack && component._x_dataStack[0]) {
      component._x_dataStack[0].goToScreen(13);
    } else {
      // Second fallback: try to find by class
      const bookingContainer = document.querySelector(".min-h-screen[x-data]");
      if (
        bookingContainer &&
        bookingContainer._x_dataStack &&
        bookingContainer._x_dataStack[0]
      ) {
        bookingContainer._x_dataStack[0].goToScreen(13);
      } else {
        console.error("Could not find Alpine component for proceedToPayment");
      }
    }
  }

  function goBack() {
    // Primary method: use global window reference
    if (
      window.bookingFlowComponent &&
      window.bookingFlowComponent.goToChooseWorker
    ) {
      window.bookingFlowComponent.goToChooseWorker();
      return;
    }

    // Fallback: try multiple approaches to find the Alpine component
    let component = document.querySelector("[x-data]");

    // If we have the component, try to access its Alpine data
    if (component && component._x_dataStack && component._x_dataStack[0]) {
      component._x_dataStack[0].goToChooseWorker();
    } else {
      // Second fallback: try to find by class
      const bookingContainer = document.querySelector(".min-h-screen[x-data]");
      if (
        bookingContainer &&
        bookingContainer._x_dataStack &&
        bookingContainer._x_dataStack[0]
      ) {
        bookingContainer._x_dataStack[0].goToChooseWorker();
      } else {
        console.error("Could not find Alpine component for goBack");
      }
    }
  }

  // Global functions for repeat booking functionality
  function setRepeatFrequency(frequency) {
    if (
      window.bookingFlowComponent &&
      window.bookingFlowComponent.setRepeatFrequency
    ) {
      window.bookingFlowComponent.setRepeatFrequency(frequency);

      // Update visual indicators
      const frequencies = ["weekly", "bi-weekly", "monthly", "custom"];
      frequencies.forEach((freq) => {
        const element = document.getElementById(`frequency-${freq}`);
        const indicator = document.getElementById(
          `frequency-${freq}-indicator`
        );
        if (element && indicator) {
          if (freq === frequency) {
            element.classList.add(
              "border-[#015e73]",
              "bg-[#015e73]/10",
              "shadow-lg"
            );
            element.classList.remove("border-gray-200");
            indicator.classList.remove("hidden");
          } else {
            element.classList.remove(
              "border-[#015e73]",
              "bg-[#015e73]/10",
              "shadow-lg"
            );
            element.classList.add("border-gray-200");
            indicator.classList.add("hidden");
          }
        }
      });

      // Show/hide days selection
      const daysSection = document.querySelector("[data-days-section]");
      if (daysSection) {
        if (frequency === "weekly" || frequency === "bi-weekly") {
          daysSection.style.display = "block";
        } else {
          daysSection.style.display = "none";
        }
      }
    }
  }

  function toggleDayOfWeek(day) {
    if (
      window.bookingFlowComponent &&
      window.bookingFlowComponent.toggleDayOfWeek
    ) {
      window.bookingFlowComponent.toggleDayOfWeek(day);

      // Update visual indicator
      const element = document.getElementById(`day-${day}`);
      const text = element.querySelector(".text-sm");
      if (element && text) {
        const isSelected =
          window.bookingFlowComponent.booking.repeat.daysOfWeek.includes(day);
        if (isSelected) {
          element.classList.add(
            "border-[#015e73]",
            "bg-[#015e73]/10",
            "shadow-lg"
          );
          element.classList.remove("border-gray-200");
          text.classList.add("text-[#015e73]", "font-bold");
        } else {
          element.classList.remove(
            "border-[#015e73]",
            "bg-[#015e73]/10",
            "shadow-lg"
          );
          element.classList.add("border-gray-200");
          text.classList.remove("text-[#015e73]", "font-bold");
        }
      }

      // Update days counter
      updateDaysCounter();
    }
  }

  function updateDaysCounter() {
    const counterElement = document.getElementById("days-counter");
    if (counterElement && window.bookingFlowComponent) {
      const selectedDays =
        window.bookingFlowComponent.booking.repeat.daysOfWeek.length;
      if (selectedDays === 0) {
        counterElement.innerHTML =
          '<span class="text-gray-500">Select the days you want service</span>';
      } else {
        const dayText = selectedDays === 1 ? "day" : "days";
        counterElement.innerHTML = `<span class="text-[#015e73] font-medium">${selectedDays} ${dayText} selected</span>`;
      }
    }
  }

  function updateNumberOfSessions(sessions) {
    if (
      window.bookingFlowComponent &&
      window.bookingFlowComponent.updateNumberOfSessions
    ) {
      window.bookingFlowComponent.updateNumberOfSessions(sessions);
      updateSessionsDisplay();
    }
  }

  function decreaseNumberOfSessions() {
    if (window.bookingFlowComponent) {
      const current =
        window.bookingFlowComponent.booking.repeat.numberOfSessions;
      updateNumberOfSessions(current - 1);
    }
  }

  function increaseNumberOfSessions() {
    if (window.bookingFlowComponent) {
      const current =
        window.bookingFlowComponent.booking.repeat.numberOfSessions;
      updateNumberOfSessions(current + 1);
    }
  }

  function handleSessionsInputChange(value) {
    const sessions = parseInt(value) || 1;
    updateNumberOfSessions(sessions);
  }

  function updateSessionsDisplay() {
    if (window.bookingFlowComponent) {
      const sessions =
        window.bookingFlowComponent.booking.repeat.numberOfSessions;

      // Update input value
      const input = document.getElementById("sessions-input");
      if (input) {
        input.value = sessions;
      }

      // Update button states
      const decreaseBtn = document.getElementById("sessions-decrease-btn");
      const increaseBtn = document.getElementById("sessions-increase-btn");

      if (decreaseBtn) {
        if (sessions <= 1) {
          decreaseBtn.classList.add("opacity-50", "cursor-not-allowed");
          decreaseBtn.disabled = true;
        } else {
          decreaseBtn.classList.remove("opacity-50", "cursor-not-allowed");
          decreaseBtn.disabled = false;
        }
      }

      if (increaseBtn) {
        if (sessions >= 52) {
          increaseBtn.classList.add("opacity-50", "cursor-not-allowed");
          increaseBtn.disabled = true;
        } else {
          increaseBtn.classList.remove("opacity-50", "cursor-not-allowed");
          increaseBtn.disabled = false;
        }
      }

      // Update savings message
      const savingsElement = document.getElementById("sessions-savings");
      if (savingsElement) {
        if (sessions >= 8) {
          savingsElement.innerHTML =
            '<span class="text-green-600 font-medium">üí∞ Save 25% on 8+ sessions!</span>';
        } else if (sessions >= 4) {
          savingsElement.innerHTML =
            '<span class="text-green-600 font-medium">üí∞ Save 15% on 4+ sessions!</span>';
        } else {
          savingsElement.innerHTML =
            '<span class="text-gray-500">Book 4+ sessions to save money</span>';
        }
      }

      // Update pricing displays
      updatePricingDisplays();
    }
  }

  function updateDuration(change) {
    if (
      window.bookingFlowComponent &&
      window.bookingFlowComponent.updateDuration
    ) {
      window.bookingFlowComponent.updateDuration(change);
      window.bookingFlowComponent.calculateRepeatPricing();

      // Update duration display
      const durationDisplay = document.getElementById("duration-display");
      if (durationDisplay) {
        durationDisplay.textContent =
          window.bookingFlowComponent.booking.details.duration + " hrs";
      }

      updatePricingDisplays();
    }
  }

  function updateHomeSizeDuration() {
    if (
      window.bookingFlowComponent &&
      window.bookingFlowComponent.updateHomeSizeDuration
    ) {
      const select = document.getElementById("home-size-select");
      if (select) {
        window.bookingFlowComponent.booking.details.homeSize = select.value;
      }

      window.bookingFlowComponent.updateHomeSizeDuration();
      window.bookingFlowComponent.calculateRepeatPricing();

      // Update duration display
      const durationDisplay = document.getElementById("duration-display");
      if (durationDisplay) {
        durationDisplay.textContent =
          window.bookingFlowComponent.booking.details.duration + " hrs";
      }

      updatePricingDisplays();
    }
  }

  function updatePricingDisplays() {
    if (window.bookingFlowComponent) {
      // Update sessions display in sidebar
      const sessionsElement = document.querySelector("[data-sessions]");
      if (sessionsElement) {
        sessionsElement.textContent =
          window.bookingFlowComponent.booking.repeat.numberOfSessions;
      }

      // Update total cost in sidebar
      const totalCostElement = document.querySelector("[data-total-cost]");
      if (totalCostElement) {
        totalCostElement.textContent =
          window.bookingFlowComponent.formatCurrency(
            window.bookingFlowComponent.booking.pricing.bookingCost
          );
      }

      // Update duration display in sidebar
      const durationElement = document.querySelector("[data-duration]");
      if (durationElement) {
        durationElement.textContent =
          window.bookingFlowComponent.booking.details.duration + " hrs each";
      }
    }
  }

  function calculateRepeatPricing() {
    if (
      window.bookingFlowComponent &&
      window.bookingFlowComponent.calculateRepeatPricing
    ) {
      window.bookingFlowComponent.calculateRepeatPricing();
    }
  }

  function findWorker() {
    if (window.bookingFlowComponent && window.bookingFlowComponent.findWorker) {
      window.bookingFlowComponent.findWorker();
    }
  }

  function goToScreen(screenNumber) {
    if (window.bookingFlowComponent && window.bookingFlowComponent.goToScreen) {
      window.bookingFlowComponent.goToScreen(screenNumber);
    }
  }

  function initializeRepeatBookingDisplays() {
    if (window.bookingFlowComponent) {
      // Set default frequency selection visual
      setRepeatFrequency(window.bookingFlowComponent.booking.repeat.frequency);

      // Update sessions display
      updateSessionsDisplay();

      // Update duration display
      const durationDisplay = document.getElementById("duration-display");
      if (durationDisplay) {
        durationDisplay.textContent =
          window.bookingFlowComponent.booking.details.duration + " hrs";
      }

      // Update pricing displays
      updatePricingDisplays();

      // Set home size selection
      const homeSizeSelect = document.getElementById("home-size-select");
      if (homeSizeSelect) {
        homeSizeSelect.value =
          window.bookingFlowComponent.booking.details.homeSize;
      }

      // Set start time selection
      const startTimeSelect = document.getElementById("start-time-select");
      if (startTimeSelect) {
        startTimeSelect.value =
          window.bookingFlowComponent.booking.details.startTime ||
          "07:00 - 07:30";
      }

      // Set special instructions
      const specialInstructions = document.getElementById(
        "special-instructions"
      );
      if (specialInstructions) {
        specialInstructions.value =
          window.bookingFlowComponent.booking.details.notes || "";
      }
    }
  }

  // Add event listeners for fallback events
  window.addEventListener("booking-proceed-to-payment", function () {
    if (window.bookingFlowComponent && window.bookingFlowComponent.goToScreen) {
      window.bookingFlowComponent.goToScreen(13);
    }
  });

  window.addEventListener("booking-go-back", function () {
    if (
      window.bookingFlowComponent &&
      window.bookingFlowComponent.goToChooseWorker
    ) {
      window.bookingFlowComponent.goToChooseWorker();
    }
  });
</script>
{% endblock %}
