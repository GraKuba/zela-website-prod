<!-- Earnings Tab Content -->
<div
  x-show="currentTab === 'earnings' && isProviderMode"
  x-transition:enter="transition ease-out duration-300"
  x-transition:enter-start="opacity-0 transform translate-y-4"
  x-transition:enter-end="opacity-100 transform translate-y-0"
>
  <div class="space-y-6">
    <!-- Earnings Overview Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
    <!-- Available Balance -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Saldo Disponível</p>
          <p class="text-2xl font-bold text-[#011e41] mt-1">
            AOA {{ wallet.available_balance|floatformat:0|default:"0" }}
          </p>
          <p class="text-xs text-gray-500 mt-1">Pronto para retirar</p>
        </div>
        <div class="p-3 bg-green-100 rounded-full">
          <svg
            class="w-6 h-6 text-green-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"
            ></path>
          </svg>
        </div>
      </div>
      {% if wallet.available_balance > 0 %}
      <button
        class="mt-4 w-full px-3 py-2 bg-[#035d73] text-white text-sm font-medium rounded-lg hover:bg-[#024854] transition-colors"
        hx-get="/dashboard/request-payout/"
        hx-target="#modal-container"
        hx-swap="innerHTML"
      >
        Solicitar Pagamento
      </button>
      {% else %}
      <div class="mt-4 text-center">
        <p class="text-xs text-gray-500">Complete trabalhos para ganhar dinheiro</p>
      </div>
      {% endif %}
    </div>

    <!-- Pending Payouts -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Pagamentos Pendentes</p>
          <p class="text-2xl font-bold text-[#011e41] mt-1">
            AOA {{ pending_payouts|floatformat:0|default:"0" }}
          </p>
          <p class="text-xs text-gray-500 mt-1">Processando</p>
        </div>
        <div class="p-3 bg-yellow-100 rounded-full">
          <svg
            class="w-6 h-6 text-yellow-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
        </div>
      </div>
    </div>

    <!-- This Week's Jobs -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Trabalhos Desta Semana</p>
          <p class="text-2xl font-bold text-[#011e41] mt-1">
            {{ current_week_jobs|default:"0" }}
          </p>
          <p class="text-xs text-gray-500 mt-1">Concluídos</p>
        </div>
        <div class="p-3 bg-blue-100 rounded-full">
          <svg
            class="w-6 h-6 text-blue-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
            ></path>
          </svg>
        </div>
      </div>
    </div>

    <!-- This Week's Earnings -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Ganhos Desta Semana</p>
          <p class="text-2xl font-bold text-[#011e41] mt-1">
            AOA {{ current_week_earnings|floatformat:0|default:"0" }}
          </p>
          <div class="flex items-center mt-1">
            {% if earnings_growth > 0 %}
            <svg
              class="w-4 h-4 text-green-500 mr-1"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z"
                clip-rule="evenodd"
              ></path>
            </svg>
            <span class="text-xs text-green-600">{{ earnings_growth }}%</span>
            {% elif earnings_growth < 0 %}
            <svg
              class="w-4 h-4 text-red-500 mr-1"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z"
                clip-rule="evenodd"
              ></path>
            </svg>
            <span class="text-xs text-red-600"
              >{{ earnings_growth|floatformat:1 }}%</span
            >
            {% else %}
            <span class="text-xs text-gray-500">Sem mudança</span>
            {% endif %}
          </div>
        </div>
        <div class="p-3 bg-purple-100 rounded-full">
          <svg
            class="w-6 h-6 text-purple-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
            ></path>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Weekly Performance Chart -->
  <div
    class="bg-white rounded-xl shadow-sm border border-gray-200 p-6"
    x-data="earningsTab"
    data-earnings-transactions='{{ earnings_transactions|default:"[]"|escapejs }}'
    data-daily-earnings='{{ daily_earnings|default:"[]"|escapejs }}'
    data-chart-labels='{{ earnings_chart_labels|default:"[]"|escapejs }}'
    data-weekly-data='{{ weekly_earnings_data|default:"[]"|escapejs }}'
    data-current-week-jobs="{{ current_week_jobs|default:0 }}"
    data-total-week-earnings="{{ total_week_earnings|default:0 }}"
  >
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-lg font-semibold text-[#011e41]">Desempenho Semanal</h3>
      <div class="flex items-center space-x-4">
        <div class="flex items-center">
          <div class="w-3 h-3 bg-[#035d73] rounded-full mr-2"></div>
          <span class="text-sm text-gray-600">Ganhos</span>
        </div>
        <div class="flex items-center">
          <div class="w-3 h-3 bg-[#fdea00] rounded-full mr-2"></div>
          <span class="text-sm text-gray-600">Trabalhos</span>
        </div>
      </div>
    </div>

    <template x-if="earningsData.hasData">
      <div>
        <div class="h-64 relative">
          <canvas id="earningsChart"></canvas>
        </div>
        <div class="mt-4 grid grid-cols-2 gap-4">
          <div class="text-center">
            <p class="text-sm text-gray-600">Média por Trabalho</p>
            <p class="text-lg font-semibold text-[#011e41]">
              AOA {{ avg_per_job|floatformat:0|default:"0" }}
            </p>
          </div>
          <div class="text-center">
            <p class="text-sm text-gray-600">Total Desta Semana</p>
            <p class="text-lg font-semibold text-[#011e41]">
              AOA {{ total_week_earnings|floatformat:0|default:"0" }}
            </p>
          </div>
        </div>
      </div>
    </template>
    <template x-if="!earningsData.hasData">
      <!-- Empty state -->
      <div class="h-64 flex flex-col items-center justify-center text-gray-400">
        <svg
          class="w-16 h-16 mb-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
          ></path>
        </svg>
        <p class="text-sm font-medium">Sem dados de ganhos ainda</p>
        <p class="text-xs mt-1">Complete trabalhos para ver seu desempenho</p>
      </div>
    </template>
  </div>

  <!-- Recent Transactions -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200">
    <div class="p-6 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-[#011e41]">
          Transações Recentes
        </h3>
        <a
          href="/dashboard/transactions/"
          class="text-sm text-[#035d73] hover:underline"
          >Ver Tudo</a
        >
      </div>
    </div>

    <div class="overflow-hidden" x-data="earningsTab">
      <template
        x-if="earningsData.transactions && earningsData.transactions.length > 0"
      >
        <div class="divide-y divide-gray-200">
          <template
            x-for="transaction in earningsData.transactions"
            :key="transaction.id"
          >
            <div class="p-4 hover:bg-gray-50 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                  <div
                    class="p-2 rounded-full"
                    :class="transaction.amount > 0 ? 'bg-green-100' : 'bg-red-100'"
                  >
                    <svg
                      class="w-5 h-5"
                      :class="transaction.amount > 0 ? 'text-green-600' : 'text-red-600'"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        x-show="transaction.amount > 0"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 11l5-5m0 0l5 5m-5-5v12"
                      ></path>
                      <path
                        x-show="transaction.amount <= 0"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M17 13l-5 5m0 0l-5-5m5 5V6"
                      ></path>
                    </svg>
                  </div>
                  <div>
                    <p
                      class="text-sm font-medium text-gray-900"
                      x-text="transaction.description"
                    ></p>
                    <p
                      class="text-xs text-gray-500"
                      x-text="formatDate(transaction.date)"
                    ></p>
                  </div>
                </div>
                <div class="text-right">
                  <p
                    class="text-sm font-semibold"
                    :class="transaction.amount > 0 ? 'text-green-600' : 'text-red-600'"
                    x-text="(transaction.amount > 0 ? '+' : '-') + 'AOA ' + Math.abs(transaction.amount).toLocaleString()"
                  ></p>
                  <span
                    class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                    :class="getStatusClass(transaction.status)"
                    x-text="transaction.status.charAt(0).toUpperCase() + transaction.status.slice(1)"
                  >
                  </span>
                </div>
              </div>
            </div>
          </template>
        </div>
      </template>
      <template
        x-if="!earningsData.transactions || earningsData.transactions.length === 0"
      >
        <!-- Empty state -->
        <div class="p-12 text-center">
          <svg
            class="w-16 h-16 mx-auto text-gray-400 mb-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
            ></path>
          </svg>
          <p class="text-sm font-medium text-gray-900 mb-1">
            Sem transações ainda
          </p>
          <p class="text-xs text-gray-500">
            Seus ganhos e pagamentos aparecerão aqui
          </p>
        </div>
      </template>
    </div>
  </div>

  <!-- Modal Container -->
  <div id="modal-container"></div>
  </div>
</div>

<!-- Initialize earnings data and Chart.js -->
<script>
  document.addEventListener("alpine:init", () => {
    Alpine.data("earningsTab", () => ({
      earningsData: {
        transactions: [],
        dailyEarnings: [],
        chartLabels: [],
        weeklyData: [],
        hasData: false,
      },
      chartInstance: null,

      init() {
        // Get data from data attributes
        const element = this.$el;
        this.earningsData = {
          transactions: JSON.parse(
            element.dataset.earningsTransactions || "[]"
          ),
          dailyEarnings: JSON.parse(element.dataset.dailyEarnings || "[]"),
          chartLabels: JSON.parse(element.dataset.chartLabels || "[]"),
          weeklyData: JSON.parse(element.dataset.weeklyData || "[]"),
          hasData:
            parseInt(element.dataset.currentWeekJobs || "0") > 0 ||
            parseInt(element.dataset.totalWeekEarnings || "0") > 0,
        };

        if (this.earningsData.hasData) {
          // Load Chart.js if not already loaded
          if (!window.Chart) {
            const script = document.createElement("script");
            script.src = "https://cdn.jsdelivr.net/npm/chart.js";
            script.onload = () => {
              this.$nextTick(() => this.initChart());
            };
            document.head.appendChild(script);
          } else {
            this.$nextTick(() => this.initChart());
          }
        }
      },

      initChart() {
        const ctx = document.getElementById("earningsChart");
        if (ctx && window.Chart) {
          this.chartInstance = new Chart(ctx.getContext("2d"), {
            type: "line",
            data: {
              labels: this.earningsData.chartLabels,
              datasets: [
                {
                  label: "Ganhos Diários",
                  data: this.earningsData.dailyEarnings,
                  borderColor: "#035d73",
                  backgroundColor: "rgba(3, 93, 115, 0.1)",
                  borderWidth: 2,
                  tension: 0.4,
                  fill: true,
                  pointBackgroundColor: "#035d73",
                  pointBorderColor: "#fff",
                  pointBorderWidth: 2,
                  pointRadius: 4,
                  pointHoverRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false,
                },
                tooltip: {
                  backgroundColor: "rgba(0, 0, 0, 0.8)",
                  padding: 12,
                  cornerRadius: 8,
                  titleFont: {
                    size: 14,
                    weight: "normal",
                  },
                  bodyFont: {
                    size: 16,
                    weight: "bold",
                  },
                  callbacks: {
                    label: function (context) {
                      return "AOA " + context.parsed.y.toLocaleString();
                    },
                  },
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: {
                    drawBorder: false,
                    color: "#e5e7eb",
                  },
                  ticks: {
                    callback: function (value) {
                      return "AOA " + value.toLocaleString();
                    },
                    color: "#6b7280",
                    padding: 8,
                  },
                },
                x: {
                  grid: {
                    display: false,
                    drawBorder: false,
                  },
                  ticks: {
                    color: "#6b7280",
                    padding: 8,
                  },
                },
              },
              interaction: {
                intersect: false,
                mode: "index",
              },
            },
          });
        }
      },

      formatDate(dateStr) {
        return new Date(dateStr).toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        });
      },

      getStatusClass(status) {
        switch (status) {
          case "completed":
            return "bg-green-100 text-green-800";
          case "pending":
            return "bg-yellow-100 text-yellow-800";
          case "failed":
            return "bg-red-100 text-red-800";
          default:
            return "bg-gray-100 text-gray-800";
        }
      },
    }));
  });
</script>
