<!-- Addresses Tab - Improved UX -->
<div
  id="addresses-tab"
  x-show="currentTab === 'addresses' && !isProviderMode"
  x-transition:enter="transition ease-out duration-300"
  x-transition:enter-start="opacity-0 transform translate-y-4"
  x-transition:enter-end="opacity-100 transform translate-y-0"
  x-data="{ 
    showAddLocation: false, 
    editingLocation: null,
    searchQuery: '',
    get filteredLocations() {
      if (!this.searchQuery) return locations;
      return locations.filter(loc => 
        loc.name.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
        loc.address_line_1.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
        loc.city.toLowerCase().includes(this.searchQuery.toLowerCase())
      );
    }
  }"
  class="space-y-6"
>
  <!-- Header Section -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="p-6 border-b border-gray-100">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h3 class="text-xl font-semibold text-gray-900">My Locations</h3>
          <p class="text-sm text-gray-600 mt-1">Manage your delivery addresses and locations</p>
        </div>
        <button
          @click="showAddLocation = true"
          class="inline-flex items-center px-4 py-2.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-100 transition-all duration-200 shadow-sm"
        >
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Add New Location
        </button>
      </div>

      <!-- Search Bar (shows when 3+ locations) -->
      {% if locations|length >= 3 %}
      <div class="mt-4">
        <div class="relative">
          <input
            type="text"
            x-model="searchQuery"
            placeholder="Search locations..."
            class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
          >
          <svg class="absolute left-3 top-2.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Locations List -->
    <div class="p-6">
      {% if locations %}
        <div class="grid gap-4">
          {% for location in locations %}
            <div 
              class="group relative bg-gray-50 rounded-xl p-5 hover:bg-white hover:shadow-lg border-2 {% if location.is_main %}border-blue-500 bg-blue-50 hover:bg-blue-50{% else %}border-transparent{% endif %} transition-all duration-200"
              x-show="!searchQuery || '{{ location.name }}'.toLowerCase().includes(searchQuery.toLowerCase()) || '{{ location.address_line_1 }}'.toLowerCase().includes(searchQuery.toLowerCase()) || '{{ location.city }}'.toLowerCase().includes(searchQuery.toLowerCase())"
            >
              <!-- Main Location Indicator -->
              {% if location.is_main %}
              <div class="absolute -top-2 -right-2">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-600 text-white shadow-sm">
                  <svg class="w-3.5 h-3.5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                  </svg>
                  Main
                </span>
              </div>
              {% endif %}

              <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
                <!-- Location Details -->
                <div class="flex-1 min-w-0">
                  <div class="flex items-start gap-3 mb-3">
                    <div class="flex-shrink-0 w-10 h-10 bg-{% if location.is_main %}blue{% else %}gray{% endif %}-100 rounded-lg flex items-center justify-center">
                      <svg class="w-5 h-5 text-{% if location.is_main %}blue{% else %}gray{% endif %}-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                      </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                      <h4 class="text-base font-semibold text-gray-900 truncate">{{ location.name }}</h4>
                      <div class="mt-1 space-y-1">
                        <p class="text-sm text-gray-700">{{ location.address_line_1 }}</p>
                        {% if location.address_line_2 %}
                          <p class="text-sm text-gray-600">{{ location.address_line_2 }}</p>
                        {% endif %}
                        <p class="text-sm text-gray-600">
                          {{ location.city }}, {{ location.province }}{% if location.postal_code %} {{ location.postal_code }}{% endif %}
                        </p>
                        <p class="text-sm text-gray-500">{{ location.get_country_display }}</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-2 sm:gap-3">
                  {% if not location.is_main %}
                    <button
                      hx-post="{% url 'accounts:location-set-main' location.id %}"
                      hx-target="#addresses-tab"
                      hx-swap="innerHTML"
                      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                      class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-blue-700 bg-blue-100 rounded-lg hover:bg-blue-200 transition-colors"
                      title="Set as main location"
                    >
                      <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                      </svg>
                      Set Main
                    </button>
                  {% endif %}
                  
                  <button
                    @click="editingLocation = editingLocation === {{ location.id }} ? null : {{ location.id }}"
                    hx-get="{% url 'accounts:location-edit' location.id %}"
                    hx-target="#location-form-{{ location.id }}"
                    hx-swap="innerHTML"
                    class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"
                    title="Edit location"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                    </svg>
                  </button>
                  
                  {% if not location.is_main %}
                  <button
                    hx-delete="{% url 'accounts:location-delete' location.id %}"
                    hx-target="#addresses-tab"
                    hx-swap="innerHTML"
                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                    hx-confirm="Are you sure you want to delete '{{ location.name }}'? This action cannot be undone."
                    class="p-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                    title="Delete location"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                  </button>
                  {% endif %}
                </div>
              </div>
              
              <!-- Inline Edit Form -->
              <div id="location-form-{{ location.id }}" class="mt-4" x-show="editingLocation === {{ location.id }}" x-collapse></div>
            </div>
          {% endfor %}
        </div>

        <!-- No search results -->
        <div x-show="searchQuery && filteredLocations.length === 0" class="text-center py-8" style="display: none;">
          <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <p class="text-gray-600">No locations found matching your search.</p>
        </div>
      {% else %}
        <!-- Empty State -->
        <div class="text-center py-12">
          <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
            <svg class="w-12 h-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">No locations saved yet</h3>
          <p class="text-gray-600 mb-6 max-w-sm mx-auto">Add your home, office, or other frequently used addresses to speed up your bookings.</p>
          <button
            @click="showAddLocation = true"
            class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-100 transition-all duration-200 shadow-sm"
          >
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Add Your First Location
          </button>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Add Location Modal - Improved -->
  <div
    x-show="showAddLocation"
    x-cloak
    class="fixed inset-0 z-50 overflow-y-auto"
    @keydown.escape.window="showAddLocation = false"
  >
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
      <!-- Background overlay -->
      <div 
        x-show="showAddLocation"
        x-transition:enter="ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity"
        @click="showAddLocation = false"
      ></div>

      <!-- Modal panel -->
      <div
        x-show="showAddLocation"
        x-transition:enter="ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave="ease-in duration-200"
        x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"
      >
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <div class="flex-shrink-0 w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-3">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-white">Add New Location</h3>
            </div>
            <button 
              @click="showAddLocation = false" 
              class="text-white hover:text-gray-200 transition-colors"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Modal Body -->
        <form
          hx-post="{% url 'accounts:location-create' %}"
          hx-target="#addresses-tab"
          hx-swap="innerHTML"
          hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
          @htmx:after-request="if ($event.detail.successful) showAddLocation = false"
          class="px-6 py-4"
        >
          {% csrf_token %}
          
          <!-- Location Name -->
          <div class="mb-4">
            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
              Location Name <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <select
                name="name"
                id="name"
                required
                class="w-full px-4 py-2.5 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none"
                @change="if ($event.target.value === 'custom') { $event.target.style.display='none'; $refs.customName.style.display='block'; $refs.customName.focus(); }"
              >
                <option value="">Select a location type</option>
                <option value="Home">🏠 Home</option>
                <option value="Office">🏢 Office</option>
                <option value="Parents">👨‍👩‍👧 Parents</option>
                <option value="Partner">💑 Partner</option>
                <option value="custom">✏️ Custom...</option>
              </select>
              <input
                type="text"
                name="name"
                x-ref="customName"
                placeholder="Enter custom name"
                style="display: none;"
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
              <svg class="absolute right-3 top-3 w-5 h-5 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </div>

          <!-- Address Fields -->
          <div class="space-y-4">
            <div>
              <label for="address_line_1" class="block text-sm font-medium text-gray-700 mb-2">
                Street Address <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                name="address_line_1"
                id="address_line_1"
                required
                placeholder="123 Main Street"
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
            </div>

            <div>
              <label for="address_line_2" class="block text-sm font-medium text-gray-700 mb-2">
                Apartment, Suite, etc. <span class="text-gray-400 text-xs">(optional)</span>
              </label>
              <input
                type="text"
                name="address_line_2"
                id="address_line_2"
                placeholder="Apt 4B"
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="city" class="block text-sm font-medium text-gray-700 mb-2">
                  City <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  name="city"
                  id="city"
                  required
                  placeholder="Luanda"
                  class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
              </div>

              <div>
                <label for="province" class="block text-sm font-medium text-gray-700 mb-2">
                  Province <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  name="province"
                  id="province"
                  required
                  placeholder="Luanda"
                  class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="postal_code" class="block text-sm font-medium text-gray-700 mb-2">
                  Postal Code <span class="text-gray-400 text-xs">(optional)</span>
                </label>
                <input
                  type="text"
                  name="postal_code"
                  id="postal_code"
                  placeholder="12345"
                  class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
              </div>

              <div>
                <label for="country" class="block text-sm font-medium text-gray-700 mb-2">
                  Country <span class="text-red-500">*</span>
                </label>
                <select
                  name="country"
                  id="country"
                  required
                  class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="AO" selected>🇦🇴 Angola</option>
                  <option value="BR">🇧🇷 Brazil</option>
                  <option value="PT">🇵🇹 Portugal</option>
                  <option value="US">🇺🇸 United States</option>
                  <option value="GB">🇬🇧 United Kingdom</option>
                </select>
              </div>
            </div>

            <!-- Set as Main Location -->
            <div class="bg-blue-50 rounded-lg p-4">
              <label class="flex items-start cursor-pointer">
                <input
                  type="checkbox"
                  name="is_main"
                  id="is_main"
                  class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                >
                <div class="ml-3">
                  <span class="block text-sm font-medium text-gray-900">Set as main location</span>
                  <span class="block text-xs text-gray-600 mt-0.5">This will be your default delivery address</span>
                </div>
              </label>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="flex gap-3 pt-6 border-t border-gray-100 mt-6">
            <button
              type="submit"
              class="flex-1 bg-blue-600 text-white py-2.5 px-4 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-100 transition-all duration-200 font-medium shadow-sm"
            >
              Save Location
            </button>
            <button
              type="button"
              @click="showAddLocation = false"
              class="flex-1 bg-gray-100 text-gray-700 py-2.5 px-4 rounded-lg hover:bg-gray-200 transition-colors font-medium"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Include Alpine.js collapse plugin for smooth animations -->
<script>
  // Pass locations data from Django to Alpine.js
  window.locations = {{ locations|safe|default:"[]" }};
</script>