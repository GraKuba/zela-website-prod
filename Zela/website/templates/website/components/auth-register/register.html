{% extends 'website/layouts/base.html' %} {% load static %} {% block title %}Criar Conta - Zela{% endblock %} {% block content %}
<!-- Include Navbar -->
{% include 'website/fragments/navbar.html' %}

<div
  class="min-h-screen flex items-center justify-center px-4 py-12"
  style="background-color: #f5f5f5"
  x-data="registerForm()"
>
  <div class="w-full max-w-md mx-auto">
    <!-- Registration Form -->
    <div class="bg-white rounded-3xl shadow-lg overflow-hidden">
      <!-- Header -->
      <div class="px-8 py-12 text-center">
        <h1 class="text-4xl font-bold mb-4" style="color: #035d73">
          Criar a Sua Conta Gratuita Zela
        </h1>
        <p class="text-lg mb-8" style="color: #4a5a70">
          Reserve serviços mais rapidamente, acompanhe as suas reservas e ganhe
          créditos de referência.
        </p>

        <!-- Step Badge -->
        <div
          class="inline-block px-4 py-2 rounded-full text-sm font-medium mb-8"
          style="background-color: #F4D35E; color: #035d73"
        >
          Passo <span x-text="currentStep"></span> de 2 –
          <span
            x-text="currentStep === 1 ? 'Dados Pessoais' : 'Dados de Morada'"
          ></span>
        </div>
      </div>

      <!-- Registration Form -->
      <form @submit.prevent="submitRegistration" class="px-8 pb-8">
        {% csrf_token %}

        <!-- Step 1: Personal Details -->
        <div x-show="currentStep === 1" class="space-y-6">
          <!-- Full Name -->
          <div>
            <label
              for="fullName"
              class="block text-sm font-semibold mb-2"
              style="color: #035d73"
            >
              Nome Completo *
            </label>
            <input
              type="text"
              id="fullName"
              name="full_name"
              x-model="formData.fullName"
              placeholder="Introduza o seu nome completo"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none transition-colors"
              required
            />
            <div
              x-show="errors.full_name"
              class="text-red-600 text-sm mt-1"
              x-text="errors.full_name"
            ></div>
          </div>

          <!-- Email -->
          <div>
            <label
              for="email"
              class="block text-sm font-semibold mb-2"
              style="color: #035d73"
            >
              Email *
            </label>
            <input
              type="email"
              id="email"
              name="email"
              x-model="formData.email"
              placeholder="Introduza o seu endereço de email"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none transition-colors"
              required
            />
            <div
              x-show="errors.email"
              class="text-red-600 text-sm mt-1"
              x-text="errors.email"
            ></div>
          </div>

          <!-- Phone -->
          <div>
            <label
              for="phone"
              class="block text-sm font-semibold mb-2"
              style="color: #035d73"
            >
              Telefone *
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              x-model="formData.phone"
              placeholder="Introduza o seu número de telefone"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none transition-colors"
              required
            />
            <div
              x-show="errors.phone"
              class="text-red-600 text-sm mt-1"
              x-text="errors.phone"
            ></div>
          </div>

          <!-- Password -->
          <div>
            <label
              for="password"
              class="block text-sm font-semibold mb-2"
              style="color: #035d73"
            >
              Palavra-passe *
            </label>
            <input
              type="password"
              id="password"
              name="password"
              x-model="formData.password"
              placeholder="Criar uma palavra-passe segura"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none transition-colors"
              @input="updatePasswordStrength()"
              required
            />
            <div
              x-show="errors.password"
              class="text-red-600 text-sm mt-1"
              x-text="errors.password"
            ></div>

            <!-- Password Requirements Checklist -->
            <div class="mt-3 space-y-2">
              <div class="flex items-center space-x-2">
                <div
                  class="w-4 h-4 rounded-full flex items-center justify-center text-xs font-bold transition-all duration-200"
                  :class="{
                    'bg-green-500 text-white': passwordChecks.minLength,
                    'bg-gray-300 text-gray-600': !passwordChecks.minLength
                  }"
                >
                  <span x-show="passwordChecks.minLength">✓</span>
                  <span x-show="!passwordChecks.minLength">✗</span>
                </div>
                <span
                  class="text-xs transition-colors duration-200"
                  :class="{
                    'text-green-600': passwordChecks.minLength,
                    'text-gray-500': !passwordChecks.minLength
                  }"
                >
                  Pelo menos 8 caracteres
                </span>
              </div>

              <div class="flex items-center space-x-2">
                <div
                  class="w-4 h-4 rounded-full flex items-center justify-center text-xs font-bold transition-all duration-200"
                  :class="{
                    'bg-green-500 text-white': passwordChecks.hasUpper,
                    'bg-gray-300 text-gray-600': !passwordChecks.hasUpper
                  }"
                >
                  <span x-show="passwordChecks.hasUpper">✓</span>
                  <span x-show="!passwordChecks.hasUpper">✗</span>
                </div>
                <span
                  class="text-xs transition-colors duration-200"
                  :class="{
                    'text-green-600': passwordChecks.hasUpper,
                    'text-gray-500': !passwordChecks.hasUpper
                  }"
                >
                  Uma letra maiúscula (A-Z)
                </span>
              </div>

              <div class="flex items-center space-x-2">
                <div
                  class="w-4 h-4 rounded-full flex items-center justify-center text-xs font-bold transition-all duration-200"
                  :class="{
                    'bg-green-500 text-white': passwordChecks.hasLower,
                    'bg-gray-300 text-gray-600': !passwordChecks.hasLower
                  }"
                >
                  <span x-show="passwordChecks.hasLower">✓</span>
                  <span x-show="!passwordChecks.hasLower">✗</span>
                </div>
                <span
                  class="text-xs transition-colors duration-200"
                  :class="{
                    'text-green-600': passwordChecks.hasLower,
                    'text-gray-500': !passwordChecks.hasLower
                  }"
                >
                  Uma letra minúscula (a-z)
                </span>
              </div>

              <div class="flex items-center space-x-2">
                <div
                  class="w-4 h-4 rounded-full flex items-center justify-center text-xs font-bold transition-all duration-200"
                  :class="{
                    'bg-green-500 text-white': passwordChecks.hasNumber,
                    'bg-gray-300 text-gray-600': !passwordChecks.hasNumber
                  }"
                >
                  <span x-show="passwordChecks.hasNumber">✓</span>
                  <span x-show="!passwordChecks.hasNumber">✗</span>
                </div>
                <span
                  class="text-xs transition-colors duration-200"
                  :class="{
                    'text-green-600': passwordChecks.hasNumber,
                    'text-gray-500': !passwordChecks.hasNumber
                  }"
                >
                  Um número (0-9)
                </span>
              </div>

              <div class="flex items-center space-x-2">
                <div
                  class="w-4 h-4 rounded-full flex items-center justify-center text-xs font-bold transition-all duration-200"
                  :class="{
                    'bg-green-500 text-white': passwordChecks.hasSpecial,
                    'bg-gray-300 text-gray-600': !passwordChecks.hasSpecial
                  }"
                >
                  <span x-show="passwordChecks.hasSpecial">✓</span>
                  <span x-show="!passwordChecks.hasSpecial">✗</span>
                </div>
                <span
                  class="text-xs transition-colors duration-200"
                  :class="{
                    'text-green-600': passwordChecks.hasSpecial,
                    'text-gray-500': !passwordChecks.hasSpecial
                  }"
                >
                  Um carácter especial (!@#$%^&*)
                </span>
              </div>
            </div>

            <!-- Password Strength Meter -->
            <div class="mt-4">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium" style="color: #035d73"
                  >Força da Palavra-passe:</span
                >
                <span
                  class="text-sm font-semibold capitalize"
                  :class="{
                    'text-red-600': passwordStrength === 'weak',
                    'text-yellow-600': passwordStrength === 'fair',
                    'text-blue-600': passwordStrength === 'strong',
                    'text-green-600': passwordStrength === 'excellent'
                  }"
                  x-text="passwordStrength"
                ></span>
              </div>
              <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div
                  class="h-full transition-all duration-300"
                  :class="{
                    'w-1/4 bg-red-500': passwordStrength === 'weak',
                    'w-2/4 bg-yellow-500': passwordStrength === 'fair',
                    'w-3/4 bg-blue-500': passwordStrength === 'strong',
                    'w-full bg-green-500': passwordStrength === 'excellent'
                  }"
                ></div>
              </div>
            </div>
          </div>

          <!-- Confirm Password -->
          <div>
            <label
              for="confirmPassword"
              class="block text-sm font-semibold mb-2"
              style="color: #035d73"
            >
              Confirmar Palavra-passe *
            </label>
            <input
              type="password"
              id="confirmPassword"
              name="confirm_password"
              x-model="formData.confirmPassword"
              placeholder="Confirmar a sua palavra-passe"
              class="w-full px-4 py-3 rounded-xl border-2 transition-colors"
              :class="{
                'border-green-500': formData.confirmPassword && formData.password === formData.confirmPassword,
                'border-red-500': formData.confirmPassword && formData.password !== formData.confirmPassword,
                'border-gray-200 focus:border-blue-500': !formData.confirmPassword
              }"
              required
            />
            <div
              x-show="errors.confirm_password"
              class="text-red-600 text-sm mt-1"
              x-text="errors.confirm_password"
            ></div>
            <!-- Password Match Indicator -->
            <div
              x-show="formData.confirmPassword"
              class="mt-2 flex items-center space-x-2"
            >
              <div
                class="w-4 h-4 rounded-full flex items-center justify-center text-xs font-bold transition-all duration-200"
                :class="{
                  'bg-green-500 text-white': formData.password === formData.confirmPassword,
                  'bg-red-500 text-white': formData.password !== formData.confirmPassword
                }"
              >
                <span x-show="formData.password === formData.confirmPassword"
                  >✓</span
                >
                <span x-show="formData.password !== formData.confirmPassword"
                  >✗</span
                >
              </div>
              <span
                class="text-xs transition-colors duration-200"
                :class="{
                    'text-green-600': formData.password === formData.confirmPassword,
                    'text-red-600': formData.password !== formData.confirmPassword
                  }"
                x-text="formData.password === formData.confirmPassword ? 'Palavras-passe coincidem' : 'Palavras-passe não coincidem'"
              ></span>
            </div>
          </div>

          <!-- Marketing Opt-in -->
          <div class="flex items-center">
            <input
              type="checkbox"
              id="marketingOptIn"
              name="marketing_opt_in"
              x-model="formData.marketingOptIn"
              class="mr-3 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
            />
            <label for="marketingOptIn" class="text-sm" style="color: #4a5a70">
              Enviar-me dicas e códigos promocionais (opcional)
            </label>
          </div>

          <!-- Continue Button -->
          <button
            type="button"
            @click="currentStep = 2"
            class="w-full py-4 rounded-full font-semibold text-lg transition-all duration-200 shadow-lg hover:shadow-xl hover:opacity-90 cursor-pointer"
            style="background-color: #035d73; color: #F4D35E"
          >
            Continuar
          </button>
        </div>

        <!-- Step 2: Address Details -->
        <div x-show="currentStep === 2" class="space-y-6">
          <!-- Address Line 1 -->
          <div>
            <label
              for="addressLine1"
              class="block text-sm font-semibold mb-2"
              style="color: #035d73"
            >
              Linha de Morada 1 *
            </label>
            <input
              type="text"
              id="addressLine1"
              name="address_line1"
              x-model="formData.addressLine1"
              placeholder="Introduza a sua morada"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none transition-colors"
              required
            />
            <div
              x-show="errors.address_line1"
              class="text-red-600 text-sm mt-1"
              x-text="errors.address_line1"
            ></div>
          </div>

          <!-- Area / Neighbourhood -->
          <div>
            <label
              for="area"
              class="block text-sm font-semibold mb-2"
              style="color: #035d73"
            >
              Área / Bairro *
            </label>
            <select
              id="area"
              name="area"
              x-model="formData.area"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none transition-colors"
              required
            >
              <option value="">Selecionar a sua área</option>
              <option value="city-centre">Centro da Cidade</option>
              <option value="suburbs">Subúrbios</option>
              <option value="waterfront">Frente Marítima</option>
              <option value="northern-suburbs">Subúrbios do Norte</option>
              <option value="southern-suburbs">Subúrbios do Sul</option>
            </select>
            <div
              x-show="errors.area"
              class="text-red-600 text-sm mt-1"
              x-text="errors.area"
            ></div>
          </div>

          <!-- Referral Code -->
          <div>
            <label
              for="referralCode"
              class="block text-sm font-semibold mb-2"
              style="color: #035d73"
            >
              Código de Referência (opcional)
            </label>
            <input
              type="text"
              id="referralCode"
              name="referral_code"
              x-model="formData.referralCode"
              placeholder="Introduza o código de referência se tiver um"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none transition-colors"
            />
            <div
              x-show="errors.referral_code"
              class="text-red-600 text-sm mt-1"
              x-text="errors.referral_code"
            ></div>
          </div>

          <!-- Terms Consent -->
          <div class="flex items-start">
            <input
              type="checkbox"
              id="termsConsent"
              name="terms_consent"
              x-model="formData.termsConsent"
              class="mr-3 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mt-1"
              required
            />
            <label for="termsConsent" class="text-sm" style="color: #4a5a70">
              Ao criar uma conta, concorda com os nossos
              <a
                href="{% url 'website:terms-of-service' %}"
                class="underline cursor-pointer"
                style="color: #035d73"
                >Termos de Serviço</a
              >
              e
              <a
                href="{% url 'website:privacy-policy' %}"
                class="underline cursor-pointer"
                style="color: #035d73"
                >Política de Privacidade</a
              >.
            </label>
          </div>
          <div
            x-show="errors.terms_consent"
            class="text-red-600 text-sm mt-1"
            x-text="errors.terms_consent"
          ></div>

          <!-- Back & Submit Buttons -->
          <div class="flex gap-4">
            <button
              type="button"
              @click="currentStep = 1"
              class="flex-1 py-4 rounded-full font-semibold text-lg border-2 transition-all duration-200 hover:bg-gray-50 cursor-pointer"
              style="border-color: #035d73; color: #035d73"
            >
              Voltar
            </button>
            <button
              type="submit"
              :disabled="isSubmitting"
              class="flex-1 py-4 rounded-full font-semibold text-lg transition-all duration-200 shadow-lg hover:shadow-xl hover:opacity-90 disabled:opacity-50 cursor-pointer"
              style="background-color: #035d73; color: #F4D35E"
            >
              <span x-show="!isSubmitting">Criar Conta</span>
              <span x-show="isSubmitting">A criar...</span>
            </button>
          </div>
        </div>
      </form>

      <!-- Sign In Link -->
      <div class="px-8 pb-8 text-center">
        <p class="text-sm" style="color: #69768b">
          Já tem uma conta?
          <a
            href="{% url 'website:sign-in' %}"
            class="font-semibold underline cursor-pointer"
            style="color: #035d73"
          >
            Iniciar sessão
          </a>
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("alpine:init", () => {
    Alpine.data("registerForm", () => ({
      currentStep: 1,
      formData: {
        fullName: "",
        email: "",
        password: "",
        confirmPassword: "",
        phone: "",
        addressLine1: "",
        area: "",
        referralCode: "",
        marketingOptIn: false,
        termsConsent: false,
      },
      passwordStrength: "weak",
      passwordChecks: {
        minLength: false,
        hasUpper: false,
        hasLower: false,
        hasNumber: false,
        hasSpecial: false,
      },
      errors: {},
      isSubmitting: false,

      updatePasswordStrength() {
        const password = this.formData.password;

        // Update individual password checks
        this.passwordChecks.minLength = password.length >= 8;
        this.passwordChecks.hasUpper = /[A-Z]/.test(password);
        this.passwordChecks.hasLower = /[a-z]/.test(password);
        this.passwordChecks.hasNumber = /[0-9]/.test(password);
        this.passwordChecks.hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(
          password
        );

        // Calculate overall strength based on requirements met
        const checksCount = Object.values(this.passwordChecks).filter(
          (check) => check
        ).length;

        if (password.length === 0) {
          this.passwordStrength = "weak";
        } else if (checksCount === 5) {
          this.passwordStrength = "excellent";
        } else if (checksCount >= 4) {
          this.passwordStrength = "strong";
        } else if (checksCount >= 3) {
          this.passwordStrength = "fair";
        } else {
          this.passwordStrength = "weak";
        }
      },

      async submitRegistration() {
        // Clear previous errors
        this.errors = {};

        // Client-side validation
        if (!this.formData.fullName) {
          this.errors.full_name = "Nome completo é obrigatório";
        }

        if (!this.formData.email) {
          this.errors.email = "Email é obrigatório";
        }

        if (!this.formData.phone) {
          this.errors.phone = "Número de telefone é obrigatório";
        }

        if (!this.formData.password) {
          this.errors.password = "Palavra-passe é obrigatória";
        }

        if (!this.formData.confirmPassword) {
          this.errors.confirm_password =
            "Por favor confirme a sua palavra-passe";
        }

        if (!this.formData.addressLine1) {
          this.errors.address_line1 = "Morada é obrigatória";
        }

        if (!this.formData.area) {
          this.errors.area = "Área é obrigatória";
        }

        if (!this.formData.termsConsent) {
          this.errors.terms_consent = "Deve concordar com os termos";
        }

        // Check password requirements
        const allRequirementsMet = Object.values(this.passwordChecks).every(
          (check) => check
        );

        if (!allRequirementsMet) {
          this.errors.password =
            "A palavra-passe não cumpre todos os requisitos";
        }

        if (this.formData.password !== this.formData.confirmPassword) {
          this.errors.confirm_password = "As palavras-passe não coincidem";
        }

        // If there are client-side errors, don't submit
        if (Object.keys(this.errors).length > 0) {
          return;
        }

        // Submit to backend
        this.isSubmitting = true;
        try {
          const formData = new FormData();
          formData.append("full_name", this.formData.fullName);
          formData.append("email", this.formData.email);
          formData.append("phone", this.formData.phone);
          formData.append("password", this.formData.password);
          formData.append("confirm_password", this.formData.confirmPassword);
          formData.append("address_line1", this.formData.addressLine1);
          formData.append("area", this.formData.area);
          formData.append("referral_code", this.formData.referralCode);
          formData.append("marketing_opt_in", this.formData.marketingOptIn);
          formData.append("terms_consent", this.formData.termsConsent);
          formData.append(
            "csrfmiddlewaretoken",
            document.querySelector("[name=csrfmiddlewaretoken]").value
          );

          const response = await fetch("/accounts/register/", {
            method: "POST",
            body: formData,
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              "HX-Request": "true",
            },
          });

          const data = await response.json();

          if (data.success) {
            // Show success message and redirect
            alert("🎉 Conta criada com sucesso! Bem-vindo à Zela.");
            window.location.href = data.redirect;
          } else {
            // Show validation errors
            if (data.errors) {
              this.errors = data.errors;

              // If there are errors in step 1, go back to step 1
              const step1Fields = [
                "full_name",
                "email",
                "phone",
                "password",
                "confirm_password",
              ];
              if (step1Fields.some((field) => data.errors[field])) {
                this.currentStep = 1;
              }
            } else {
              alert("Registo falhou. Por favor tente novamente.");
            }
          }
        } catch (error) {
          console.error("Registration error:", error);
          alert("Registo falhou. Por favor tente novamente.");
        } finally {
          this.isSubmitting = false;
        }
      },
    }));
  });
</script>

{% endblock %}
